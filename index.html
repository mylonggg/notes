<!DOCTYPE html>
<html>
<head>
    <title>D1å›¾ç‰‡ä¸Šä¼ æµ‹è¯•</title>
    <style>
        body { font-family: Arial; padding: 20px; }
        .box { border: 1px solid #ddd; padding: 15px; margin: 10px 0; border-radius: 5px; }
        input, button { margin: 5px; padding: 8px; }
        button { background: #4CAF50; color: white; border: none; cursor: pointer; }
        button:hover { background: #45a049; }
        #log { background: #f5f5f5; padding: 15px; margin-top: 20px; font-family: monospace; }
        .success { color: green; }
        .error { color: red; }
    </style>
</head>
<body>
    <h1>D1æ•°æ®åº“å›¾ç‰‡ä¸Šä¼ æµ‹è¯•</h1>
    
    <div class="box">
        <h3>é…ç½®</h3>
        <label>Worker URL: </label>
        <input type="text" id="url" placeholder="https://d1-image-upload.è´¦æˆ·.workers.dev" style="width: 400px;">
        <br>
        <label>Admin Key: </label>
        <input type="password" id="key" value="123456">
    </div>
    
    <div class="box">
        <h3>æ•°æ®åº“æ“ä½œ</h3>
        <button onclick="health()">å¥åº·æ£€æŸ¥</button>
        <button onclick="init()">åˆå§‹åŒ–æ•°æ®åº“</button>
        <button onclick="list()">æŸ¥çœ‹åˆ—è¡¨</button>
        <button onclick="clearAll()" style="background: #f44336;">æ¸…é™¤æ‰€æœ‰</button>
    </div>
    
    <div class="box">
        <h3>ä¸Šä¼ å›¾ç‰‡</h3>
        <input type="file" id="fileInput" accept="image/*">
        <button onclick="upload()">ä¸Šä¼ å›¾ç‰‡</button>
        <div id="imagePreview"></div>
    </div>
    
    <div class="box">
        <h3>æ“ä½œæ—¥å¿—</h3>
        <div id="log">ç­‰å¾…æ“ä½œ...</div>
    </div>

    <script>
        // æ—¥å¿—å‡½æ•°
        function log(message, type = 'info') {
            const logDiv = document.getElementById('log');
            const time = new Date().toLocaleTimeString();
            const color = type === 'error' ? 'red' : type === 'success' ? 'green' : 'black';
            logDiv.innerHTML = `<div><span style="color:${color}">[${time}] ${message}</span></div>` + logDiv.innerHTML;
        }
        
        // è·å–é…ç½®
        function getConfig() {
            const url = document.getElementById('url').value.trim();
            const key = document.getElementById('key').value.trim();
            return { url, key };
        }
        
        // 1. å¥åº·æ£€æŸ¥
        async function health() {
            const config = getConfig();
            try {
                const res = await fetch(`${config.url}/api/health`);
                const data = await res.json();
                if (data.success) {
                    log(`âœ… å¥åº·æ£€æŸ¥: ${data.message}`, 'success');
                } else {
                    log(`âŒ å¤±è´¥: ${data.error}`, 'error');
                }
            } catch(e) {
                log(`âŒ é”™è¯¯: ${e.message}`, 'error');
            }
        }
        
        // 2. åˆå§‹åŒ–æ•°æ®åº“
        async function init() {
            const config = getConfig();
            try {
                const res = await fetch(`${config.url}/api/init`, {
                    method: 'POST'
                });
                const data = await res.json();
                if (data.success) {
                    log(`âœ… ${data.message}`, 'success');
                } else {
                    log(`âŒ å¤±è´¥: ${data.error}`, 'error');
                }
            } catch(e) {
                log(`âŒ é”™è¯¯: ${e.message}`, 'error');
            }
        }
        
        // 3. ä¸Šä¼ å›¾ç‰‡
        async function upload() {
            const config = getConfig();
            const fileInput = document.getElementById('fileInput');
            const file = fileInput.files[0];
            
            if (!file) {
                alert('è¯·é€‰æ‹©å›¾ç‰‡æ–‡ä»¶');
                return;
            }
            
            // éªŒè¯æ–‡ä»¶
            if (file.size > 2 * 1024 * 1024) {
                alert('æ–‡ä»¶å¤ªå¤§ï¼Œæœ€å¤§2MB');
                return;
            }
            
            const formData = new FormData();
            formData.append('file', file);
            
            try {
                const res = await fetch(`${config.url}/api/upload`, {
                    method: 'POST',
                    headers: {
                        'Authorization': config.key
                    },
                    body: formData
                });
                
                const data = await res.json();
                
                if (data.success) {
                    log(`âœ… ä¸Šä¼ æˆåŠŸ! ID: ${data.data.id}`, 'success');
                    log(`URL: ${config.url}${data.data.url}`, 'info');
                    
                    // æ˜¾ç¤ºå›¾ç‰‡
                    const previewDiv = document.getElementById('imagePreview');
                    const img = document.createElement('img');
                    img.src = `${config.url}${data.data.url}`;
                    img.style.maxWidth = '300px';
                    img.style.margin = '10px';
                    previewDiv.innerHTML = '';
                    previewDiv.appendChild(img);
                } else {
                    log(`âŒ ä¸Šä¼ å¤±è´¥: ${data.error}`, 'error');
                }
            } catch(e) {
                log(`âŒ é”™è¯¯: ${e.message}`, 'error');
            }
        }
        
        // 4. æŸ¥çœ‹åˆ—è¡¨
        async function list() {
            const config = getConfig();
            try {
                const res = await fetch(`${config.url}/api/list`, {
                    headers: {
                        'Authorization': config.key
                    }
                });
                
                const data = await res.json();
                
                if (data.success) {
                    log(`ğŸ“‹ æ‰¾åˆ° ${data.count} å¼ å›¾ç‰‡`, 'success');
                    data.data.forEach(img => {
                        log(`- ${img.filename} (${img.size} bytes) - ${img.created_at}`);
                    });
                } else {
                    log(`âŒ å¤±è´¥: ${data.error}`, 'error');
                }
            } catch(e) {
                log(`âŒ é”™è¯¯: ${e.message}`, 'error');
            }
        }
        
        // 5. æ¸…é™¤æ‰€æœ‰
        async function clearAll() {
            if (!confirm('ç¡®å®šè¦åˆ é™¤æ‰€æœ‰å›¾ç‰‡å—ï¼Ÿ')) return;
            
            const config = getConfig();
            try {
                const res = await fetch(`${config.url}/api/clear`, {
                    method: 'POST',
                    headers: {
                        'Authorization': config.key
                    }
                });
                
                const data = await res.json();
                
                if (data.success) {
                    log(`âœ… ${data.message}`, 'success');
                } else {
                    log(`âŒ å¤±è´¥: ${data.error}`, 'error');
                }
            } catch(e) {
                log(`âŒ é”™è¯¯: ${e.message}`, 'error');
            }
        }
        
        // é¡µé¢åŠ è½½
        document.addEventListener('DOMContentLoaded', () => {
            log('é¡µé¢å·²åŠ è½½ï¼Œè¯·å…ˆé…ç½®Worker URL');
            log('é»˜è®¤Admin Key: 123456');
        });
    </script>
</body>
</html>
