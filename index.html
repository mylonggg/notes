<!DOCTYPE html>
<html>
<head>
    <title>图片上传测试</title>
    <style>
        body { font-family: Arial; padding: 20px; }
        .container { max-width: 500px; margin: 0 auto; }
        input, button { margin: 10px 0; padding: 10px; width: 100%; }
        .success { background: #d4edda; padding: 10px; border-radius: 5px; }
        .error { background: #f8d7da; padding: 10px; border-radius: 5px; }
        .log { background: #f5f5f5; padding: 15px; border-radius: 5px; margin-top: 20px; font-size: 12px; white-space: pre-wrap; }
        .preview { max-width: 300px; margin-top: 10px; }
    </style>
</head>
<body>
    <div class="container">
        <h2>图片上传测试</h2>
        
        <div>
            <label>Worker URL:</label>
            <input type="text" id="apiUrl" placeholder="https://your-worker.workers.dev">
        </div>
        
        <div>
            <label>Admin Key:</label>
            <input type="password" id="adminKey" placeholder="your-secret-admin-key">
        </div>
        
        <div>
            <label>选择图片:</label>
            <input type="file" id="fileInput" accept="image/*">
        </div>
        
        <div>
            <button onclick="initDatabase()">初始化数据库</button>
            <button onclick="testHealth()">测试连接</button>
            <button onclick="uploadImage()">上传图片</button>
            <button onclick="listImages()">查看列表</button>
            <button onclick="resetDatabase()">重置数据库</button>
        </div>
        
        <div id="result"></div>
        <div id="log"></div>
        <div id="preview"></div>
    </div>

    <script>
        // 配置
        let config = {
            apiUrl: '',
            adminKey: ''
        };
        
        // 日志函数
        function log(msg, type = 'info') {
            const logDiv = document.getElementById('log');
            const time = new Date().toLocaleTimeString();
            logDiv.innerHTML = `[${time}] ${msg}\n` + logDiv.innerHTML;
            console.log(`[${type}]`, msg);
        }
        
        // 显示结果
        function showResult(msg, type = 'info') {
            const resultDiv = document.getElementById('result');
            resultDiv.innerHTML = `<div class="${type}">${msg}</div>`;
        }
        
        // 获取配置
        function getConfig() {
            config.apiUrl = document.getElementById('apiUrl').value.trim();
            config.adminKey = document.getElementById('adminKey').value.trim();
            
            if (!config.apiUrl || !config.adminKey) {
                alert('请填写URL和Admin Key');
                return false;
            }
            return true;
        }
        
        // 1. 初始化数据库
        async function initDatabase() {
            if (!getConfig()) return;
            
            log('初始化数据库...');
            try {
                const res = await fetch(`${config.apiUrl}/api/images/init`, {
                    method: 'POST',
                    headers: { 'Authorization': config.adminKey }
                });
                const data = await res.json();
                
                if (res.ok) {
                    showResult('✅ 数据库初始化成功', 'success');
                    log(JSON.stringify(data, null, 2));
                } else {
                    showResult(`❌ ${data.error}`, 'error');
                    log(data.error, 'error');
                }
            } catch (error) {
                showResult(`❌ ${error.message}`, 'error');
                log(error.message, 'error');
            }
        }
        
        // 2. 测试连接
        async function testHealth() {
            if (!getConfig()) return;
            
            log('测试连接...');
            try {
                const res = await fetch(`${config.apiUrl}/api/health`);
                const data = await res.json();
                
                if (res.ok) {
                    showResult('✅ 连接成功', 'success');
                    log(JSON.stringify(data, null, 2));
                } else {
                    showResult('❌ 连接失败', 'error');
                    log(data.error, 'error');
                }
            } catch (error) {
                showResult(`❌ ${error.message}`, 'error');
                log(error.message, 'error');
            }
        }
        
        // 3. 上传图片
        async function uploadImage() {
            if (!getConfig()) return;
            
            const fileInput = document.getElementById('fileInput');
            const file = fileInput.files[0];
            
            if (!file) {
                alert('请选择图片');
                return;
            }
            
            log(`上传: ${file.name} (${file.size} bytes)`);
            
            // 验证文件
            if (file.size > 2 * 1024 * 1024) {
                showResult('❌ 文件超过2MB限制', 'error');
                return;
            }
            
            const formData = new FormData();
            formData.append('image', file);
            
            try {
                const res = await fetch(`${config.apiUrl}/api/images/upload`, {
                    method: 'POST',
                    headers: { 'Authorization': config.adminKey },
                    body: formData
                });
                
                const data = await res.json();
                
                if (res.ok && data.success) {
                    showResult('✅ 上传成功', 'success');
                    log(JSON.stringify(data.data, null, 2));
                    
                    // 显示预览
                    const previewDiv = document.getElementById('preview');
                    previewDiv.innerHTML = `
                        <h3>预览:</h3>
                        <img class="preview" src="${config.apiUrl}${data.data.url}" alt="预览">
                        <p>URL: ${config.apiUrl}${data.data.url}</p>
                    `;
                } else {
                    showResult(`❌ ${data.error}`, 'error');
                    log(data.error, 'error');
                }
            } catch (error) {
                showResult(`❌ ${error.message}`, 'error');
                log(error.message, 'error');
            }
        }
        
        // 4. 查看列表
        async function listImages() {
            if (!getConfig()) return;
            
            log('获取图片列表...');
            try {
                const res = await fetch(`${config.apiUrl}/api/images/list`, {
                    headers: { 'Authorization': config.adminKey }
                });
                const data = await res.json();
                
                if (res.ok && data.success) {
                    showResult(`✅ 找到 ${data.count} 张图片`, 'success');
                    log(JSON.stringify(data.data, null, 2));
                } else {
                    showResult(`❌ ${data.error}`, 'error');
                    log(data.error, 'error');
                }
            } catch (error) {
                showResult(`❌ ${error.message}`, 'error');
                log(error.message, 'error');
            }
        }
        
        // 5. 重置数据库
        async function resetDatabase() {
            if (!getConfig()) return;
            if (!confirm('确定要重置数据库吗？所有图片将被删除！')) return;
            
            log('重置数据库...');
            try {
                const res = await fetch(`${config.apiUrl}/api/images/reset`, {
                    method: 'POST',
                    headers: { 'Authorization': config.adminKey }
                });
                const data = await res.json();
                
                if (res.ok) {
                    showResult('✅ 数据库已重置', 'success');
                    log(JSON.stringify(data, null, 2));
                } else {
                    showResult(`❌ ${data.error}`, 'error');
                    log(data.error, 'error');
                }
            } catch (error) {
                showResult(`❌ ${error.message}`, 'error');
                log(error.message, 'error');
            }
        }
        
        // 页面加载
        document.addEventListener('DOMContentLoaded', () => {
            // 加载保存的配置
            const savedUrl = localStorage.getItem('cloudnotes_url');
            const savedKey = localStorage.getItem('cloudnotes_key');
            
            if (savedUrl) document.getElementById('apiUrl').value = savedUrl;
            if (savedKey) document.getElementById('adminKey').value = savedKey;
            
            // 保存配置
            document.getElementById('apiUrl').addEventListener('change', function() {
                localStorage.setItem('cloudnotes_url', this.value);
            });
            document.getElementById('adminKey').addEventListener('change', function() {
                localStorage.setItem('cloudnotes_key', this.value);
            });
            
            log('测试页面已加载');
        });
    </script>
</body>
</html>
