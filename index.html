<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CloudNotes | éšç§åŠ å¯†ç¬”è®°ã€å¯¼èˆªä¸å›¾ç‰‡ç®¡ç†</title>
    <link rel="manifest" href="manifest.json">
    <link rel="apple-touch-icon" href="icon.png">
    <meta name="theme-color" content="#020617">
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/styles/github-dark.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/highlight.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap');

        body {
            font-family: 'Inter', sans-serif;
            background-color: #020617;
            color: #f8fafc;
        }

        .glass {
            background: rgba(30, 41, 59, 0.7);
            backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .gradient-btn {
            background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .gradient-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px -5px rgba(37, 99, 235, 0.4);
        }

        .note-card {
            transition: all 0.3s ease;
        }

        .note-card:hover {
            border-color: rgba(59, 130, 246, 0.5);
            background: rgba(30, 41, 59, 0.9);
        }

        ::-webkit-scrollbar {
            width: 0px;
        }

        /* ç»Ÿä¸€çš„Markdowné¢„è§ˆæ ·å¼ - ç”¨äºç¼–è¾‘æ¨¡å¼å’Œåˆ†äº«é¡µé¢ */
        .markdown-preview {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            line-height: 1.6;
            overflow-wrap: break-word;
        }

        .markdown-preview h1 {
            font-size: 2em;
            font-weight: 800;
            margin-top: 1.5em;
            margin-bottom: 0.5em;
            padding-bottom: 0.3em;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .markdown-preview h2 {
            font-size: 1.5em;
            font-weight: 700;
            margin-top: 1.5em;
            margin-bottom: 0.5em;
        }

        .markdown-preview h3 {
            font-size: 1.25em;
            font-weight: 600;
            margin-top: 1.5em;
            margin-bottom: 0.5em;
        }

        .markdown-preview h4 {
            font-size: 1.1em;
            font-weight: 600;
            margin-top: 1.5em;
            margin-bottom: 0.5em;
        }

        .markdown-preview p {
            margin-bottom: 1em;
        }

        .markdown-preview ul, .markdown-preview ol {
            margin-left: 1.5em;
            margin-bottom: 1em;
        }

        .markdown-preview li {
            margin-bottom: 0.5em;
        }

        .markdown-preview code {
            background: rgba(0, 0, 0, 0.3);
            padding: 0.2em 0.4em;
            border-radius: 0.25em;
            font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', monospace;
            font-size: 0.9em;
        }

        .markdown-preview pre {
            background: rgba(0, 0, 0, 0.4);
            padding: 1em;
            border-radius: 0.5em;
            overflow-x: auto;
            margin-bottom: 1.5em;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .markdown-preview blockquote {
            border-left: 4px solid #3b82f6;
            padding-left: 1em;
            margin-left: 0;
            margin-bottom: 1.5em;
            color: #94a3b8;
            font-style: italic;
        }

        .markdown-preview table {
            border-collapse: collapse;
            width: 100%;
            margin-bottom: 1.5em;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .markdown-preview th, .markdown-preview td {
            border: 1px solid rgba(255, 255, 255, 0.1);
            padding: 0.75em;
            text-align: left;
        }

        .markdown-preview th {
            background: rgba(0, 0, 0, 0.2);
            font-weight: 600;
        }

        .markdown-preview a {
            color: #60a5fa;
            text-decoration: none;
        }

        .markdown-preview a:hover {
            text-decoration: underline;
        }

        .markdown-preview img {
            max-width: 100%;
            border-radius: 0.5em;
            margin-bottom: 1em;
        }

        .markdown-preview hr {
            border: none;
            height: 1px;
            background: rgba(255, 255, 255, 0.1);
            margin: 2em 0;
        }

        .markdown-preview strong {
            font-weight: 700;
        }

        .markdown-preview em {
            font-style: italic;
        }

        .markdown-preview del {
            text-decoration: line-through;
        }

        .tab-button {
            padding: 0.75em 1.5em;
            background: transparent;
            border: none;
            color: #94a3b8;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: 600;
            border-radius: 0.5em;
        }

        .tab-button:hover {
            background: rgba(255, 255, 255, 0.05);
        }

        .tab-button.active {
            color: #60a5fa;
            background: rgba(59, 130, 246, 0.1);
        }

        .hljs {
            background: transparent !important;
        }
        
        .login-shake {
            animation: shake 0.5s ease-in-out;
        }
        
        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            10%, 30%, 50%, 70%, 90% { transform: translateX(-5px); }
            20%, 40%, 60%, 80% { transform: translateX(5px); }
        }
        
        .login-bg {
            background: linear-gradient(135deg, #0f172a 0%, #1e293b 50%, #0f172a 100%);
        }
        
        .loader {
            width: 48px;
            height: 48px;
            border: 5px solid #3b82f6;
            border-bottom-color: transparent;
            border-radius: 50%;
            display: inline-block;
            box-sizing: border-box;
            animation: rotation 1s linear infinite;
        }

        @keyframes rotation {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .share-gradient {
            background: linear-gradient(135deg, #f97316 0%, #dc2626 100%);
        }
        
        .share-gradient:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px -5px rgba(220, 38, 38, 0.4);
        }
        
        .nav-gradient {
            background: linear-gradient(135deg, #8b5cf6 0%, #7c3aed 100%);
        }
        
        .nav-gradient:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px -5px rgba(124, 58, 237, 0.4);
        }
        
        .nav-link-card {
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            border: 1px solid rgba(255, 255, 255, 0.05);
        }
        
        .nav-link-card:hover {
            transform: translateY(-4px);
            border-color: rgba(139, 92, 246, 0.5);
            box-shadow: 0 10px 25px -5px rgba(139, 92, 246, 0.3);
            background: rgba(30, 41, 59, 0.9);
        }
        
        .category-tag {
            display: inline-block;
            padding: 0.25em 0.75em;
            border-radius: 9999px;
            font-size: 0.75rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }
        
        .icon-blue { color: #60a5fa; }
        .icon-green { color: #34d399; }
        .icon-purple { color: #a78bfa; }
        .icon-red { color: #f87171; }
        .icon-yellow { color: #fbbf24; }
        .icon-pink { color: #f472b6; }
        .icon-indigo { color: #818cf8; }
        
        .quick-access-bar {
            position: fixed;
            bottom: 20px;
            right: 20px;
            z-index: 100;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        
        .quick-access-btn {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.25rem;
            transition: all 0.3s ease;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
        }
        
        .quick-access-btn:hover {
            transform: scale(1.1) rotate(5deg);
        }
        
        .modal-enter {
            animation: modalEnter 0.3s ease-out;
        }
        
        @keyframes modalEnter {
            from {
                opacity: 0;
                transform: scale(0.9) translateY(-20px);
            }
            to {
                opacity: 1;
                transform: scale(1) translateY(0);
            }
        }
        
        .nav-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 1.5rem;
        }
        
        /* å›¾ç‰‡ä¸Šä¼ æ ·å¼ */
        .image-upload-container {
            border: 2px dashed rgba(59, 130, 246, 0.3);
            border-radius: 1rem;
            padding: 2rem;
            text-align: center;
            background: rgba(15, 23, 42, 0.3);
            transition: all 0.3s ease;
            cursor: pointer;
            margin-bottom: 1rem;
        }
        
        .image-upload-container:hover {
            border-color: rgba(59, 130, 246, 0.5);
            background: rgba(15, 23, 42, 0.5);
        }
        
        .image-upload-container.dragover {
            border-color: #3b82f6;
            background: rgba(59, 130, 246, 0.1);
        }
        
        .image-preview-container {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
            gap: 0.75rem;
            margin-top: 1rem;
        }
        
        .image-preview {
            position: relative;
            aspect-ratio: 1;
            border-radius: 0.5rem;
            overflow: hidden;
            border: 1px solid rgba(255, 255, 255, 0.1);
            background: rgba(0, 0, 0, 0.3);
        }
        
        .image-preview img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            transition: transform 0.3s ease;
        }
        
        .image-preview:hover img {
            transform: scale(1.05);
        }
        
        .image-preview .image-overlay {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            opacity: 0;
            transition: opacity 0.3s ease;
        }
        
        .image-preview:hover .image-overlay {
            opacity: 1;
        }
        
        .image-actions {
            display: flex;
            gap: 0.5rem;
        }
        
        .image-action-btn {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            background: rgba(0, 0, 0, 0.7);
            color: white;
            border: none;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .image-action-btn:hover {
            transform: scale(1.1);
        }
        
        .image-action-btn.copy {
            background: rgba(59, 130, 246, 0.8);
        }
        
        .image-action-btn.delete {
            background: rgba(239, 68, 68, 0.8);
        }
        
        .image-upload-progress {
            width: 100%;
            height: 6px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 3px;
            overflow: hidden;
            margin-top: 0.5rem;
        }
        
        .image-upload-progress-bar {
            height: 100%;
            background: linear-gradient(90deg, #3b82f6, #8b5cf6);
            border-radius: 3px;
            transition: width 0.3s ease;
        }
        
        .image-stats {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 1rem;
            padding: 0.75rem;
            background: rgba(15, 23, 42, 0.5);
            border-radius: 0.5rem;
            font-size: 0.875rem;
        }
        
        .image-grid-view {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 1rem;
        }
        
        .image-detail-modal img {
            max-width: 100%;
            max-height: 60vh;
            border-radius: 0.75rem;
            margin-bottom: 1rem;
        }
        
        .image-meta {
            background: rgba(15, 23, 42, 0.5);
            padding: 0.75rem;
            border-radius: 0.5rem;
            font-size: 0.875rem;
        }
        
        .image-meta-row {
            display: flex;
            justify-content: space-between;
            margin-bottom: 0.25rem;
        }
        
        .image-meta-label {
            color: #94a3b8;
        }
        
        .image-meta-value {
            color: #e2e8f0;
            font-family: monospace;
        }
        
        .images-view-tabs {
            display: flex;
            gap: 0.5rem;
            margin-bottom: 1.5rem;
        }
        
        .images-view-tab {
            padding: 0.5rem 1rem;
            background: transparent;
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 0.5rem;
            color: #94a3b8;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .images-view-tab:hover {
            background: rgba(255, 255, 255, 0.05);
        }
        
        .images-view-tab.active {
            background: rgba(59, 130, 246, 0.1);
            color: #60a5fa;
            border-color: rgba(59, 130, 246, 0.3);
        }
        
        .upload-area-icon {
            font-size: 3rem;
            margin-bottom: 1rem;
            color: rgba(59, 130, 246, 0.5);
        }
        
        .upload-area-text {
            color: #94a3b8;
            margin-bottom: 0.5rem;
        }
        
        .upload-area-hint {
            color: #64748b;
            font-size: 0.875rem;
        }
        
        @media (max-width: 768px) {
            .nav-grid {
                grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
                gap: 1rem;
            }
            
            .quick-access-bar {
                bottom: 15px;
                right: 15px;
            }
            
            .quick-access-btn {
                width: 45px;
                height: 45px;
                font-size: 1.1rem;
            }
            
            .image-grid-view {
                grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
                gap: 0.75rem;
            }
            
            .image-preview-container {
                grid-template-columns: repeat(auto-fill, minmax(100px, 1fr));
            }
        }

        /* é¡¶éƒ¨æ§åˆ¶æ æŒ‰é’®æ ·å¼ */
        .toggle-btn {
            transition: all 0.3s ease;
            border: 1px solid rgba(59, 130, 246, 0.2);
        }
        
        .toggle-btn:hover {
            border-color: rgba(59, 130, 246, 0.4);
            background: rgba(59, 130, 246, 0.1);
        }
        
        .toggle-btn i {
            transition: transform 0.3s ease;
        }
        
        .toggle-btn.expanded i {
            transform: rotate(180deg);
        }
        
        /* å­—ç¬¦é¡ºåºæ¶ˆå¤±åŠ¨ç”»ç›¸å…³æ ·å¼ */
        .burning-text {
            position: relative;
            transition: all 0.3s ease;
        }
        
        .burning-char {
            display: inline-block;
            transition: all 0.6s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
        }
        
        .char-burning {
            opacity: 0.1;
            transform: translateY(8px) scale(0.85);
            filter: blur(1.5px);
            color: #ff6b6b !important;
        }
        
        .char-removed {
            opacity: 0;
            visibility: hidden;
            transform: translateY(15px) scale(0.7);
        }
        
        .current-burning {
            position: relative;
            z-index: 10;
        }
        
        .current-burning::after {
            content: '';
            position: absolute;
            top: -2px;
            left: -2px;
            right: -2px;
            bottom: -2px;
            background: linear-gradient(45deg, #ff6b6b, #ffa500);
            border-radius: 2px;
            z-index: -1;
            animation: glow 0.8s ease-in-out infinite alternate;
            opacity: 0.5;
        }
        
        @keyframes glow {
            from {
                opacity: 0.3;
                box-shadow: 0 0 5px #ff6b6b;
            }
            to {
                opacity: 0.6;
                box-shadow: 0 0 10px #ffa500, 0 0 20px #ff6b6b;
            }
        }
        
        .fire-trail {
            position: absolute;
            width: 3px;
            height: 3px;
            background: linear-gradient(45deg, #ff6b6b, #ffa500);
            border-radius: 50%;
            pointer-events: none;
            z-index: 100;
            box-shadow: 0 0 6px #ff6b6b;
            animation: fireTrail 0.8s ease-out forwards;
        }
        
        @keyframes fireTrail {
            0% {
                transform: translate(0, 0) scale(1);
                opacity: 1;
            }
            100% {
                transform: translate(var(--tx, 0), var(--ty, -20px)) scale(0.3);
                opacity: 0;
            }
        }
        
        .burn-progress-bar {
            height: 4px;
            background: linear-gradient(90deg, #dc2626, #f97316);
            border-radius: 2px;
            transition: width 0.3s ease;
            margin-top: 4px;
        }
        
        .burn-notification {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 1000;
            background: rgba(220, 38, 38, 0.9);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 107, 107, 0.3);
            padding: 12px 20px;
            border-radius: 12px;
            box-shadow: 0 8px 32px rgba(220, 38, 38, 0.3);
            animation: notificationSlide 0.5s ease-out;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        @keyframes notificationSlide {
            from {
                transform: translateX(100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }
        
        .burn-cursor {
            position: absolute;
            width: 2px;
            height: 1.2em;
            background: #ff6b6b;
            animation: cursorBlink 1s infinite;
            pointer-events: none;
            z-index: 50;
        }
        
        @keyframes cursorBlink {
            0%, 50% { opacity: 1; }
            51%, 100% { opacity: 0; }
        }
        
        .typewriter-effect {
            overflow: hidden;
            white-space: nowrap;
            margin: 0 auto;
            letter-spacing: 0.15em;
        }
        
        /* Toast é€šçŸ¥æ ·å¼ */
        .toast {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 1000;
            padding: 12px 20px;
            border-radius: 8px;
            color: white;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 10px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
            transform: translateY(-20px);
            opacity: 0;
            transition: all 0.3s ease;
        }
        
        .toast.show {
            transform: translateY(0);
            opacity: 1;
        }
        
        .toast.success {
            background: linear-gradient(135deg, #10b981, #059669);
        }
        
        .toast.error {
            background: linear-gradient(135deg, #ef4444, #dc2626);
        }
        
        .toast.info {
            background: linear-gradient(135deg, #3b82f6, #2563eb);
        }
        
        .share-btn {
            transition: all 0.3s ease;
        }
        
        .share-btn:hover {
            transform: translateY(-2px);
        }
        
        /* Markdownå·¥å…·æ æ ·å¼ */
        .markdown-toolbar {
            display: flex;
            flex-wrap: wrap;
            gap: 0.5rem;
            padding: 0.75rem;
            background: rgba(15, 23, 42, 0.5);
            border-radius: 0.75rem;
            margin-bottom: 1rem;
        }
        
        .markdown-toolbar button {
            padding: 0.5rem 0.75rem;
            background: rgba(30, 41, 59, 0.7);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 0.5rem;
            color: #cbd5e1;
            cursor: pointer;
            transition: all 0.2s ease;
            font-size: 0.875rem;
            display: flex;
            align-items: center;
            gap: 0.25rem;
        }
        
        .markdown-toolbar button:hover {
            background: rgba(59, 130, 246, 0.2);
            border-color: rgba(59, 130, 246, 0.3);
            color: #60a5fa;
        }
        
        .markdown-toolbar button i {
            font-size: 0.75rem;
        }
        
        /* å›¾ç‰‡ä¸Šä¼ æŒ‰é’®æ ·å¼ */
        .image-gradient-btn {
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }
        
        .image-gradient-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px -5px rgba(16, 185, 129, 0.4);
        }
    </style>
</head>

<body class="min-h-screen selection:bg-blue-500/30">
    <!-- Toast é€šçŸ¥å®¹å™¨ -->
    <div id="toastContainer"></div>
    
    <!-- è®¤è¯æ¨¡æ€æ¡† -->
    <div id="authModal" class="fixed inset-0 z-50 flex items-center justify-center p-4 login-bg hidden">
        <div class="glass w-full max-w-md p-10 rounded-[2.5rem] shadow-2xl space-y-8">
            <div class="text-center space-y-4">
                <div class="inline-flex p-4 bg-gradient-to-r from-blue-500 to-purple-600 rounded-full text-5xl">ğŸ”</div>
                <div class="space-y-2">
                    <h1 class="text-3xl font-extrabold tracking-tight italic">CloudNotes</h1>
                    <p class="text-slate-400 leading-relaxed text-sm">ç§æœ‰åŠ å¯†ç¬”è®°ä¸å¯¼èˆªç³»ç»Ÿ<br>è¯·è¾“å…¥è®¿é—®å¯†ç ä»¥ç»§ç»­</p>
                </div>
            </div>
            
            <div class="space-y-6">
                <div class="space-y-3">
                    <label class="text-xs uppercase tracking-widest text-slate-400 font-bold ml-1">
                        è®¿é—®å¯†ç 
                        <span id="attemptsCount" class="text-rose-500 text-xs ml-2">å‰©ä½™å°è¯•æ¬¡æ•°: 5</span>
                    </label>
                    <input id="authPassword" type="password" 
                           class="w-full bg-slate-900/70 border border-slate-700 p-5 rounded-2xl outline-none focus:ring-2 ring-blue-500/50 text-center font-mono text-lg"
                           placeholder="è¯·è¾“å…¥å¯†ç "
                           autocomplete="off"
                           onkeydown="if(event.key === 'Enter') checkPassword()">
                    <p class="text-xs text-slate-500 text-center">
                        æç¤ºï¼šè¯·è”ç³»ç®¡ç†å‘˜è·å–è®¿é—®å¯†ç 
                    </p>
                </div>
                
                <button onclick="checkPassword()" id="verifyBtn"
                        class="w-full gradient-btn text-white py-5 rounded-2xl font-black tracking-widest uppercase text-sm shadow-xl hover:shadow-2xl transition-all">
                    éªŒè¯èº«ä»½
                </button>
                
                <div id="loadingSpinner" class="hidden text-center py-4">
                    <div class="loader mx-auto"></div>
                    <p class="text-slate-400 mt-4 text-sm">éªŒè¯ä¸­...</p>
                </div>
                
                <div class="pt-6 border-t border-white/5 text-center">
                    <p class="text-xs text-slate-500">
                        ğŸ”’ å®‰å…¨æç¤ºï¼šè¯·å‹¿åœ¨å…¬å…±è®¾å¤‡ä¸Šä¿å­˜å¯†ç 
                    </p>
                </div>
            </div>
        </div>
    </div>

    <!-- ä¸»åº”ç”¨å®¹å™¨ -->
    <div id="appContainer" class="hidden">
        <div id="app" class="max-w-6xl mx-auto px-4 py-8 md:py-12">
        </div>
    </div>

    <!-- å¿«é€Ÿè®¿é—®æ  -->
    <div id="quickAccessBar" class="quick-access-bar hidden">
        <button onclick="showAddNavLinkModal()" class="quick-access-btn nav-gradient text-white" title="æ·»åŠ å¯¼èˆªé“¾æ¥">
            <i class="fas fa-plus"></i>
        </button>
        <button onclick="showAddNoteModal()" class="quick-access-btn gradient-btn text-white" title="æ·»åŠ ç¬”è®°">
            <i class="fas fa-edit"></i>
        </button>
        <button onclick="showImageManager()" class="quick-access-btn image-gradient-btn text-white" title="å›¾ç‰‡ç®¡ç†">
            <i class="fas fa-images"></i>
        </button>
        <button onclick="scrollToTop()" class="quick-access-btn glass text-white" title="è¿”å›é¡¶éƒ¨">
            <i class="fas fa-arrow-up"></i>
        </button>
    </div>

    <!-- ç³»ç»Ÿé…ç½®æ¨¡æ€æ¡† -->
    <div id="settingsModal"
        class="fixed inset-0 bg-black/60 backdrop-blur-md z-50 flex items-center justify-center hidden p-4">
        <div class="glass w-full max-w-sm p-8 rounded-[2.5rem] shadow-2xl space-y-6 modal-enter">
            <h2 class="text-2xl font-extrabold tracking-tight">âš™ï¸ ç³»ç»Ÿé…ç½®</h2>
            <div class="space-y-4">
                <div class="space-y-1">
                    <label class="text-[10px] uppercase tracking-widest text-slate-400 font-bold ml-1">Worker
                        æœåŠ¡åœ°å€</label>
                    <input id="setApi" type="text" placeholder="https://..."
                        class="w-full bg-slate-900/50 border border-slate-700 p-4 rounded-2xl outline-none focus:ring-2 ring-blue-500/50 text-sm transition-all">
                </div>
                <div class="space-y-1">
                    <label class="text-[10px] uppercase tracking-widest text-slate-400 font-bold ml-1">ç®¡ç†å‘˜å¯†é’¥</label>
                    <input id="setKey" type="password" placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢"
                        class="w-full bg-slate-900/50 border border-slate-700 p-4 rounded-2xl outline-none focus:ring-2 ring-blue-500/50 text-sm transition-all">
                </div>
            </div>
            <div class="flex gap-3">
                <button onclick="closeSettings()"
                    class="flex-1 py-4 text-slate-400 font-semibold rounded-2xl hover:bg-slate-800 transition">å–æ¶ˆ</button>
                <button onclick="saveSettings()"
                    class="flex-1 py-4 gradient-btn text-white font-bold rounded-2xl">ä¿å­˜</button>
            </div>
        </div>
    </div>

    <!-- ç¼–è¾‘ç¬”è®°æ¨¡æ€æ¡† -->
    <div id="editModal"
        class="fixed inset-0 bg-black/60 backdrop-blur-md z-50 flex items-center justify-center hidden p-4">
        <div class="glass w-full max-w-4xl p-8 rounded-[2.5rem] shadow-2xl space-y-6 max-h-[95vh] overflow-hidden flex flex-col modal-enter">
            <h2 class="text-2xl font-extrabold tracking-tight flex items-center gap-2">
                <span class="text-blue-400">âœï¸</span> ç¼–è¾‘ç¬”è®°
                <span id="editNoteId" class="text-sm text-slate-400 ml-2 font-mono"></span>
            </h2>
            
            <div class="flex gap-2 mb-4">
                <button onclick="switchTab('edit')" class="tab-button active" id="editTabBtn">ç¼–è¾‘æ¨¡å¼</button>
                <button onclick="switchTab('preview')" class="tab-button" id="previewTabBtn">é¢„è§ˆæ¨¡å¼</button>
            </div>
            
            <div class="space-y-4 flex-1 overflow-hidden flex flex-col min-h-0">
                <div id="editTab" class="flex-1 flex flex-col min-h-0">
                    <div class="markdown-toolbar">
                        <button onclick="insertMarkdown('# ', 'æ ‡é¢˜')" title="ä¸€çº§æ ‡é¢˜">
                            <i class="fas fa-heading"></i> H1
                        </button>
                        <button onclick="insertMarkdown('## ', 'äºŒçº§æ ‡é¢˜')" title="äºŒçº§æ ‡é¢˜">
                            <i class="fas fa-heading"></i> H2
                        </button>
                        <button onclick="insertMarkdown('### ', 'ä¸‰çº§æ ‡é¢˜')" title="ä¸‰çº§æ ‡é¢˜">
                            <i class="fas fa-heading"></i> H3
                        </button>
                        <button onclick="insertMarkdown('**', 'ç²—ä½“æ–‡æœ¬')" title="ç²—ä½“">
                            <i class="fas fa-bold"></i>
                        </button>
                        <button onclick="insertMarkdown('*', 'æ–œä½“æ–‡æœ¬')" title="æ–œä½“">
                            <i class="fas fa-italic"></i>
                        </button>
                        <button onclick="insertMarkdown('~~', 'åˆ é™¤çº¿æ–‡æœ¬')" title="åˆ é™¤çº¿">
                            <i class="fas fa-strikethrough"></i>
                        </button>
                        <button onclick="insertMarkdown('- ', 'åˆ—è¡¨é¡¹')" title="æ— åºåˆ—è¡¨">
                            <i class="fas fa-list-ul"></i>
                        </button>
                        <button onclick="insertMarkdown('1. ', 'æœ‰åºåˆ—è¡¨')" title="æœ‰åºåˆ—è¡¨">
                            <i class="fas fa-list-ol"></i>
                        </button>
                        <button onclick="insertMarkdown('[é“¾æ¥æ–‡æœ¬](https://)', '')" title="é“¾æ¥">
                            <i class="fas fa-link"></i>
                        </button>
                        <button onclick="insertImageToMarkdown()" title="æ’å…¥å›¾ç‰‡">
                            <i class="fas fa-image"></i>
                        </button>
                        <button onclick="insertMarkdown('> ', 'å¼•ç”¨æ–‡æœ¬')" title="å¼•ç”¨">
                            <i class="fas fa-quote-right"></i>
                        </button>
                        <button onclick="insertMarkdown('```javascript\n\n```', 'ä»£ç ')" title="ä»£ç å—">
                            <i class="fas fa-code"></i>
                        </button>
                        <button onclick="insertMarkdown('---\n', '')" title="åˆ†å‰²çº¿">
                            <i class="fas fa-minus"></i>
                        </button>
                        <button onclick="insertMarkdown('| è¡¨å¤´ | è¡¨å¤´ |\n|------|------|\n| å†…å®¹ | å†…å®¹ |', '')" title="è¡¨æ ¼">
                            <i class="fas fa-table"></i>
                        </button>
                        <button onclick="insertMarkdown('- [ ] ', 'ä»»åŠ¡é¡¹')" title="ä»»åŠ¡åˆ—è¡¨">
                            <i class="fas fa-tasks"></i>
                        </button>
                    </div>
                    
                    <div class="flex-1 min-h-0 border border-slate-800 rounded-2xl overflow-hidden bg-slate-950/50 relative">
                        <textarea id="editNoteContent" 
                            class="w-full h-full bg-transparent p-5 outline-none text-sm transition-all resize-none leading-relaxed font-mono min-h-[45vh] border-0"
                            placeholder="# æ ‡é¢˜&#10;&#10;## äºŒçº§æ ‡é¢˜&#10;&#10;- åˆ—è¡¨é¡¹&#10;- å¦ä¸€ä¸ªåˆ—è¡¨é¡¹&#10;&#10;**ç²—ä½“** *æ–œä½“* &#10;&#10;```javascript&#10;// ä»£ç å—&#10;console.log('Hello');&#10;```&#10;&#10;> å¼•ç”¨å†…å®¹&#10;&#10;| è¡¨å¤´1 | è¡¨å¤´2 |&#10;|--------|--------|&#10;| å•å…ƒæ ¼1 | å•å…ƒæ ¼2 |"></textarea>
                        
                        <div class="absolute bottom-3 right-4">
                            <div class="text-xs text-slate-500 bg-slate-900/70 px-2 py-1 rounded">
                                <span id="editCharCount">0</span> å­—ç¬¦
                            </div>
                        </div>
                    </div>
                </div>
                
                <div id="previewTab" class="flex-1 overflow-y-auto hidden min-h-0">
                    <div class="text-[10px] uppercase tracking-widest text-slate-400 font-bold ml-1 mb-2 block">
                        Markdown é¢„è§ˆ
                    </div>
                    <div id="markdownPreview" class="markdown-preview p-5 bg-slate-950/50 border border-slate-800 rounded-2xl flex-1 overflow-y-auto min-h-[60vh]">
                        <!-- é¢„è§ˆå†…å®¹å°†é€šè¿‡JSåŠ¨æ€å¡«å…… -->
                    </div>
                </div>
            </div>
            
            <div class="flex gap-3 pt-6 border-t border-white/5">
                <button onclick="closeEdit()"
                    class="flex-1 py-4 text-slate-400 font-semibold rounded-2xl hover:bg-slate-800 transition">
                    å–æ¶ˆ
                </button>
                <button onclick="saveEdit()"
                    class="flex-1 py-4 gradient-btn text-white font-bold rounded-2xl">
                    ä¿å­˜æ›´æ”¹
                </button>
            </div>
            
            <div class="pt-4 border-t border-white/5 text-xs text-slate-500">
                <p class="flex items-center gap-2">
                    <span class="text-yellow-400">âš ï¸</span>
                    æ³¨æ„ï¼šç¼–è¾‘åç¬”è®°å°†ä½¿ç”¨å½“å‰ä¸»å¯†ç é‡æ–°åŠ å¯†ä¿å­˜åˆ°äº‘ç«¯
                </p>
            </div>
        </div>
    </div>

    <!-- å¿«é€Ÿæ·»åŠ ç¬”è®°æ¨¡æ€æ¡† -->
    <div id="addNoteModal"
        class="fixed inset-0 bg-black/60 backdrop-blur-md z-50 flex items-center justify-center hidden p-4">
        <div class="glass w-full max-w-2xl p-8 rounded-[2.5rem] shadow-2xl space-y-6 modal-enter">
            <h2 class="text-2xl font-extrabold tracking-tight flex items-center gap-2">
                <span class="text-blue-400">ğŸ“</span> å¿«é€Ÿæ·»åŠ ç¬”è®°
            </h2>
            
            <div class="space-y-4">
                <div>
                    <label class="text-[10px] uppercase tracking-widest text-slate-400 font-bold ml-1 mb-2 block">
                        è§£å¯†ä¸»å¯†ç 
                    </label>
                    <input id="quickMainPw" type="password" placeholder="è¾“å…¥ä¸»å¯†ç ä»¥åŠ å¯†" 
                        class="w-full bg-slate-950/50 border border-slate-800 p-4 rounded-2xl outline-none focus:ring-2 ring-blue-500/50 transition-all font-mono">
                </div>
                
                <div>
                    <label class="text-[10px] uppercase tracking-widest text-slate-400 font-bold ml-1 mb-2 block">
                        ç¬”è®°å†…å®¹
                    </label>
                    <textarea id="quickNoteInput" placeholder="è¾“å…¥ç¬”è®°å†…å®¹..." 
                        class="w-full bg-slate-950/50 border border-slate-800 p-4 h-40 rounded-2xl outline-none focus:bg-slate-950 transition-all resize-none leading-relaxed"></textarea>
                    <div class="flex items-center gap-2 text-xs text-slate-500 mt-2">
                        <span id="quickNoteCharCount">0</span> å­—ç¬¦
                    </div>
                </div>
            </div>
            
            <div class="flex gap-3">
                <button onclick="closeAddNoteModal()"
                    class="flex-1 py-4 text-slate-400 font-semibold rounded-2xl hover:bg-slate-800 transition">
                    å–æ¶ˆ
                </button>
                <button onclick="quickSaveNote()"
                    class="flex-1 py-4 gradient-btn text-white font-bold rounded-2xl">
                    ä¿å­˜ç¬”è®°
                </button>
            </div>
        </div>
    </div>

    <!-- æ·»åŠ å¯¼èˆªé“¾æ¥æ¨¡æ€æ¡† -->
    <div id="addNavLinkModal"
        class="fixed inset-0 bg-black/60 backdrop-blur-md z-50 flex items-center justify-center hidden p-4">
        <div class="glass w-full max-w-md p-8 rounded-[2.5rem] shadow-2xl space-y-6 modal-enter">
            <h2 class="text-2xl font-extrabold tracking-tight flex items-center gap-2">
                <span class="text-purple-400">ğŸ”—</span> æ·»åŠ å¯¼èˆªé“¾æ¥
            </h2>
            
            <div class="space-y-4">
                <div>
                    <label class="text-[10px] uppercase tracking-widest text-slate-400 font-bold ml-1 mb-2 block">
                        é“¾æ¥æ ‡é¢˜
                    </label>
                    <input id="navLinkTitle" type="text" placeholder="ä¾‹å¦‚ï¼šGitHub" 
                        class="w-full bg-slate-950/50 border border-slate-800 p-4 rounded-2xl outline-none focus:ring-2 ring-purple-500/50 transition-all">
                </div>
                
                <div>
                    <label class="text-[10px] uppercase tracking-widest text-slate-400 font-bold ml-1 mb-2 block">
                        é“¾æ¥åœ°å€
                    </label>
                    <input id="navLinkUrl" type="text" placeholder="https://..." 
                        class="w-full bg-slate-950/50 border border-slate-800 p-4 rounded-2xl outline-none focus:ring-2 ring-purple-500/50 transition-all font-mono text-sm">
                </div>
                
                <div>
                    <label class="text-[10px] uppercase tracking-widest text-slate-400 font-bold ml-1 mb-2 block">
                        åˆ†ç±»æ ‡ç­¾
                    </label>
                    <div class="flex flex-wrap gap-2 mb-2">
                        <button onclick="setNavCategory('å¼€å‘å·¥å…·')" class="px-3 py-1 bg-blue-900/30 text-blue-400 rounded-lg hover:bg-blue-800/50 transition text-xs">å¼€å‘å·¥å…·</button>
                        <button onclick="setNavCategory('æ—¥å¸¸æ•ˆç‡')" class="px-3 py-1 bg-green-900/30 text-green-400 rounded-lg hover:bg-green-800/50 transition text-xs">æ—¥å¸¸æ•ˆç‡</button>
                        <button onclick="setNavCategory('è®¾è®¡èµ„æº')" class="px-3 py-1 bg-purple-900/30 text-purple-400 rounded-lg hover:bg-purple-800/50 transition text-xs">è®¾è®¡èµ„æº</button>
                        <button onclick="setNavCategory('å­¦ä¹ èµ„æº')" class="px-3 py-1 bg-yellow-900/30 text-yellow-400 rounded-lg hover:bg-yellow-800/50 transition text-xs">å­¦ä¹ èµ„æº</button>
                        <button onclick="setNavCategory('ç¤¾äº¤å¨±ä¹')" class="px-3 py-1 bg-pink-900/30 text-pink-400 rounded-lg hover:bg-pink-800/50 transition text-xs">ç¤¾äº¤å¨±ä¹</button>
                    </div>
                    <input id="navLinkCategory" type="text" placeholder="è‡ªå®šä¹‰åˆ†ç±»æˆ–é€‰æ‹©ä¸Šæ–¹æ ‡ç­¾" 
                        class="w-full bg-slate-950/50 border border-slate-800 p-4 rounded-2xl outline-none focus:ring-2 ring-purple-500/50 transition-all">
                </div>
                
                <div>
                    <label class="text-[10px] uppercase tracking-widest text-slate-400 font-bold ml-1 mb-2 block">
                        å›¾æ ‡é€‰æ‹©
                    </label>
                    <div class="flex flex-wrap gap-3 mb-2">
                        <button onclick="setNavIcon('fas fa-globe', 'icon-blue')" class="p-2 bg-slate-800 rounded-lg hover:bg-slate-700 transition"><i class="fas fa-globe icon-blue"></i></button>
                        <button onclick="setNavIcon('fas fa-code', 'icon-green')" class="p-2 bg-slate-800 rounded-lg hover:bg-slate-700 transition"><i class="fas fa-code icon-green"></i></button>
                        <button onclick="setNavIcon('fas fa-tools', 'icon-yellow')" class="p-2 bg-slate-800 rounded-lg hover:bg-slate-700 transition"><i class="fas fa-tools icon-yellow"></i></button>
                        <button onclick="setNavIcon('fas fa-palette', 'icon-purple')" class="p-2 bg-slate-800 rounded-lg hover:bg-slate-700 transition"><i class="fas fa-palette icon-purple"></i></button>
                        <button onclick="setNavIcon('fas fa-book', 'icon-indigo')" class="p-2 bg-slate-800 rounded-lg hover:bg-slate-700 transition"><i class="fas fa-book icon-indigo"></i></button>
                        <button onclick="setNavIcon('fas fa-film', 'icon-pink')" class="p-2 bg-slate-800 rounded-lg hover:bg-slate-700 transition"><i class="fas fa-film icon-pink"></i></button>
                    </div>
                    <input id="navLinkIcon" type="hidden" value="fas fa-globe">
                    <input id="navLinkIconColor" type="hidden" value="icon-blue">
                </div>
                
                <div>
                    <label class="text-[10px] uppercase tracking-widest text-slate-400 font-bold ml-1 mb-2 block">
                        æè¿°ï¼ˆå¯é€‰ï¼‰
                    </label>
                    <textarea id="navLinkDescription" placeholder="é“¾æ¥çš„ç®€è¦æè¿°..." 
                        class="w-full bg-slate-950/50 border border-slate-800 p-4 h-24 rounded-2xl outline-none focus:bg-slate-950 transition-all resize-none"></textarea>
                </div>
            </div>
            
            <div class="flex gap-3">
                <button onclick="closeAddNavLinkModal()"
                    class="flex-1 py-4 text-slate-400 font-semibold rounded-2xl hover:bg-slate-800 transition">
                    å–æ¶ˆ
                </button>
                <button onclick="saveNavLink()"
                    class="flex-1 py-4 nav-gradient text-white font-bold rounded-2xl">
                    ä¿å­˜é“¾æ¥
                </button>
            </div>
        </div>
    </div>

    <!-- ç¼–è¾‘å¯¼èˆªé“¾æ¥æ¨¡æ€æ¡† -->
    <div id="editNavLinkModal"
        class="fixed inset-0 bg-black/60 backdrop-blur-md z-50 flex items-center justify-center hidden p-4">
        <div class="glass w-full max-w-md p-8 rounded-[2.5rem] shadow-2xl space-y-6 modal-enter">
            <h2 class="text-2xl font-extrabold tracking-tight flex items-center gap-2">
                <span class="text-purple-400">âœï¸</span> ç¼–è¾‘å¯¼èˆªé“¾æ¥
                <span id="editNavLinkId" class="text-sm text-slate-400 ml-2 font-mono"></span>
            </h2>
            
            <div class="space-y-4">
                <div>
                    <label class="text-[10px] uppercase tracking-widest text-slate-400 font-bold ml-1 mb-2 block">
                        é“¾æ¥æ ‡é¢˜
                    </label>
                    <input id="editNavLinkTitle" type="text" placeholder="ä¾‹å¦‚ï¼šGitHub" 
                        class="w-full bg-slate-950/50 border border-slate-800 p-4 rounded-2xl outline-none focus:ring-2 ring-purple-500/50 transition-all">
                </div>
                
                <div>
                    <label class="text-[10px] uppercase tracking-widest text-slate-400 font-bold ml-1 mb-2 block">
                        é“¾æ¥åœ°å€
                    </label>
                    <input id="editNavLinkUrl" type="text" placeholder="https://..." 
                        class="w-full bg-slate-950/50 border border-slate-800 p-4 rounded-2xl outline-none focus:ring-2 ring-purple-500/50 transition-all font-mono text-sm">
                </div>
                
                <div>
                    <label class="text-[10px] uppercase tracking-widest text-slate-400 font-bold ml-1 mb-2 block">
                        åˆ†ç±»æ ‡ç­¾
                    </label>
                    <div class="flex flex-wrap gap-2 mb-2">
                        <button onclick="setEditNavCategory('å¼€å‘å·¥å…·')" class="px-3 py-1 bg-blue-900/30 text-blue-400 rounded-lg hover:bg-blue-800/50 transition text-xs">å¼€å‘å·¥å…·</button>
                        <button onclick="setEditNavCategory('æ—¥å¸¸æ•ˆç‡')" class="px-3 py-1 bg-green-900/30 text-green-400 rounded-lg hover:bg-green-800/50 transition text-xs">æ—¥å¸¸æ•ˆç‡</button>
                        <button onclick="setEditNavCategory('è®¾è®¡èµ„æº')" class="px-3 py-1 bg-purple-900/30 text-purple-400 rounded-lg hover:bg-purple-800/50 transition text-xs">è®¾è®¡èµ„æº</button>
                        <button onclick="setEditNavCategory('å­¦ä¹ èµ„æº')" class="px-3 py-1 bg-yellow-900/30 text-yellow-400 rounded-lg hover:bg-yellow-800/50 transition text-xs">å­¦ä¹ èµ„æº</button>
                        <button onclick="setEditNavCategory('ç¤¾äº¤å¨±ä¹')" class="px-3 py-1 bg-pink-900/30 text-pink-400 rounded-lg hover:bg-pink-800/50 transition text-xs">ç¤¾äº¤å¨±ä¹</button>
                    </div>
                    <input id="editNavLinkCategory" type="text" placeholder="è‡ªå®šä¹‰åˆ†ç±»æˆ–é€‰æ‹©ä¸Šæ–¹æ ‡ç­¾" 
                        class="w-full bg-slate-950/50 border border-slate-800 p-4 rounded-2xl outline-none focus:ring-2 ring-purple-500/50 transition-all">
                </div>
                
                <div>
                    <label class="text-[10px] uppercase tracking-widest text-slate-400 font-bold ml-1 mb-2 block">
                        å›¾æ ‡é€‰æ‹©
                    </label>
                    <div class="flex flex-wrap gap-3 mb-2">
                        <button onclick="setEditNavIcon('fas fa-globe', 'icon-blue')" class="p-2 bg-slate-800 rounded-lg hover:bg-slate-700 transition"><i class="fas fa-globe icon-blue"></i></button>
                        <button onclick="setEditNavIcon('fas fa-code', 'icon-green')" class="p-2 bg-slate-800 rounded-lg hover:bg-slate-700 transition"><i class="fas fa-code icon-green"></i></button>
                        <button onclick="setEditNavIcon('fas fa-tools', 'icon-yellow')" class="p-2 bg-slate-800 rounded-lg hover:bg-slate-700 transition"><i class="fas fa-tools icon-yellow"></i></button>
                        <button onclick="setEditNavIcon('fas fa-palette', 'icon-purple')" class="p-2 bg-slate-800 rounded-lg hover:bg-slate-700 transition"><i class="fas fa-palette icon-purple"></i></button>
                        <button onclick="setEditNavIcon('fas fa-book', 'icon-indigo')" class="p-2 bg-slate-800 rounded-lg hover:bg-slate-700 transition"><i class="fas fa-book icon-indigo"></i></button>
                        <button onclick="setEditNavIcon('fas fa-film', 'icon-pink')" class="p-2 bg-slate-800 rounded-lg hover:bg-slate-700 transition"><i class="fas fa-film icon-pink"></i></button>
                    </div>
                    <div id="editNavIconPreview" class="text-center py-2">
                    </div>
                    <input id="editNavLinkIcon" type="hidden">
                    <input id="editNavLinkIconColor" type="hidden">
                </div>
                
                <div>
                    <label class="text-[10px] uppercase tracking-widest text-slate-400 font-bold ml-1 mb-2 block">
                        æè¿°ï¼ˆå¯é€‰ï¼‰
                    </label>
                    <textarea id="editNavLinkDescription" placeholder="é“¾æ¥çš„ç®€è¦æè¿°..." 
                        class="w-full bg-slate-950/50 border border-slate-800 p-4 h-24 rounded-2xl outline-none focus:bg-slate-950 transition-all resize-none"></textarea>
                </div>
            </div>
            
            <div class="flex gap-3">
                <button onclick="closeEditNavLinkModal()"
                    class="flex-1 py-4 text-slate-400 font-semibold rounded-2xl hover:bg-slate-800 transition">
                    å–æ¶ˆ
                </button>
                <button onclick="updateNavLink()"
                    class="flex-1 py-4 nav-gradient text-white font-bold rounded-2xl">
                    æ›´æ–°é“¾æ¥
                </button>
            </div>
            
            <div class="pt-4 border-t border-white/5">
                <button onclick="confirmDeleteNavLink()" class="w-full py-3 bg-rose-900/30 text-rose-400 rounded-2xl hover:bg-rose-800/50 transition font-semibold">
                    ğŸ—‘ï¸ åˆ é™¤æ­¤é“¾æ¥
                </button>
            </div>
        </div>
    </div>

    <!-- å›¾ç‰‡ç®¡ç†å™¨æ¨¡æ€æ¡† -->
    <div id="imageManagerModal"
        class="fixed inset-0 bg-black/60 backdrop-blur-md z-50 flex items-center justify-center hidden p-4">
        <div class="glass w-full max-w-6xl p-8 rounded-[2.5rem] shadow-2xl space-y-6 max-h-[95vh] overflow-hidden flex flex-col modal-enter">
            <h2 class="text-2xl font-extrabold tracking-tight flex items-center gap-2">
                <span class="text-emerald-400">ğŸ–¼ï¸</span> å›¾ç‰‡ç®¡ç†å™¨
                <span class="text-sm text-slate-400 ml-auto" id="imageStats">æ­£åœ¨åŠ è½½...</span>
            </h2>
            
            <div class="images-view-tabs">
                <button onclick="switchImageView('upload')" class="images-view-tab active" id="uploadTabBtn">
                    <i class="fas fa-upload"></i> ä¸Šä¼ å›¾ç‰‡
                </button>
                <button onclick="switchImageView('gallery')" class="images-view-tab" id="galleryTabBtn">
                    <i class="fas fa-images"></i> å›¾ç‰‡åº“
                </button>
                <button onclick="switchImageView('recent')" class="images-view-tab" id="recentTabBtn">
                    <i class="fas fa-history"></i> æœ€è¿‘ä¸Šä¼ 
                </button>
            </div>
            
            <div id="uploadView" class="flex-1 overflow-y-auto min-h-0">
                <div class="space-y-6">
                    <!-- ä¸Šä¼ åŒºåŸŸ -->
                    <div id="imageUploadContainer" class="image-upload-container"
                         ondragover="handleDragOver(event)"
                         ondragleave="handleDragLeave(event)"
                         ondrop="handleDrop(event)">
                        <div class="upload-area-icon">
                            <i class="fas fa-cloud-upload-alt"></i>
                        </div>
                        <div class="upload-area-text">
                            æ‹–æ”¾å›¾ç‰‡åˆ°æ­¤åŒºåŸŸï¼Œæˆ–ç‚¹å‡»é€‰æ‹©æ–‡ä»¶
                        </div>
                        <div class="upload-area-hint">
                            æ”¯æŒ JPGã€PNGã€GIFã€WebPï¼Œæœ€å¤§ 10MB
                        </div>
                        <input type="file" id="imageFileInput" multiple accept="image/*" class="hidden" 
                               onchange="handleFileSelect(event)">
                        <button onclick="document.getElementById('imageFileInput').click()"
                                class="mt-4 image-gradient-btn text-white py-3 px-6 rounded-xl font-bold">
                            é€‰æ‹©å›¾ç‰‡
                        </button>
                    </div>
                    
                    <!-- ä¸Šä¼ è¿›åº¦ -->
                    <div id="uploadProgress" class="hidden space-y-2">
                        <div class="flex justify-between text-sm">
                            <span>ä¸Šä¼ è¿›åº¦</span>
                            <span id="uploadProgressText">0%</span>
                        </div>
                        <div class="image-upload-progress">
                            <div id="uploadProgressBar" class="image-upload-progress-bar" style="width: 0%"></div>
                        </div>
                    </div>
                    
                    <!-- å›¾ç‰‡é¢„è§ˆ -->
                    <div id="imagePreviews" class="space-y-4">
                        <!-- é¢„è§ˆå›¾ç‰‡å°†é€šè¿‡JSåŠ¨æ€æ·»åŠ  -->
                    </div>
                    
                    <!-- ä¸Šä¼ æŒ‰é’® -->
                    <div class="flex gap-3 pt-4">
                        <button onclick="closeImageManager()"
                                class="flex-1 py-4 text-slate-400 font-semibold rounded-2xl hover:bg-slate-800 transition">
                            å–æ¶ˆ
                        </button>
                        <button onclick="uploadImages()"
                                class="flex-1 py-4 image-gradient-btn text-white font-bold rounded-2xl">
                            å¼€å§‹ä¸Šä¼ 
                        </button>
                    </div>
                </div>
            </div>
            
            <div id="galleryView" class="flex-1 overflow-y-auto hidden min-h-0">
                <div class="space-y-6">
                    <div class="flex justify-between items-center">
                        <div class="flex gap-2">
                            <input type="text" id="imageSearch" placeholder="æœç´¢å›¾ç‰‡åç§°..." 
                                   class="bg-slate-900/50 border border-slate-700 p-3 rounded-xl outline-none focus:ring-2 ring-emerald-500/50 w-64"
                                   onkeyup="searchImages()">
                            <select id="imageSort" class="bg-slate-900/50 border border-slate-700 p-3 rounded-xl outline-none focus:ring-2 ring-emerald-500/50"
                                    onchange="loadGalleryImages()">
                                <option value="newest">æœ€æ–°ä¸Šä¼ </option>
                                <option value="oldest">æœ€æ—©ä¸Šä¼ </option>
                                <option value="name_asc">åç§° A-Z</option>
                                <option value="name_desc">åç§° Z-A</option>
                                <option value="size_desc">æ–‡ä»¶å¤§å°</option>
                            </select>
                        </div>
                        <button onclick="loadGalleryImages()" class="text-emerald-400 hover:text-emerald-300 transition">
                            <i class="fas fa-sync-alt"></i> åˆ·æ–°
                        </button>
                    </div>
                    
                    <div id="imageGallery" class="image-grid-view">
                        <!-- å›¾ç‰‡å°†é€šè¿‡JSåŠ¨æ€åŠ è½½ -->
                    </div>
                    
                    <div id="galleryLoading" class="text-center py-12">
                        <div class="loader mx-auto"></div>
                        <p class="text-slate-400 mt-4">åŠ è½½å›¾ç‰‡åº“ä¸­...</p>
                    </div>
                    
                    <div id="noImagesMessage" class="text-center py-20 hidden">
                        <div class="text-5xl text-slate-700 mb-4">ğŸ–¼ï¸</div>
                        <p class="text-slate-600">æš‚æ— å›¾ç‰‡ï¼Œä¸Šä¼ ä½ çš„ç¬¬ä¸€å¼ å›¾ç‰‡å§ï¼</p>
                    </div>
                </div>
            </div>
            
            <div id="recentView" class="flex-1 overflow-y-auto hidden min-h-0">
                <div class="space-y-6">
                    <div class="text-center py-12">
                        <div class="text-4xl text-slate-700 mb-4">ğŸ“Š</div>
                        <h3 class="text-xl font-bold text-slate-300 mb-2">æœ€è¿‘ä¸Šä¼ ç»Ÿè®¡</h3>
                        <p class="text-slate-500">æ˜¾ç¤ºæœ€è¿‘30å¤©çš„ä¸Šä¼ æ´»åŠ¨</p>
                    </div>
                    
                    <div id="recentStats" class="space-y-4">
                        <!-- ç»Ÿè®¡æ•°æ®å°†é€šè¿‡JSåŠ¨æ€åŠ è½½ -->
                    </div>
                    
                    <div id="recentImages" class="space-y-4">
                        <h4 class="text-lg font-bold text-slate-300">æœ€è¿‘ä¸Šä¼ çš„å›¾ç‰‡</h4>
                        <div id="recentImagesGrid" class="image-grid-view">
                            <!-- æœ€è¿‘å›¾ç‰‡å°†é€šè¿‡JSåŠ¨æ€åŠ è½½ -->
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- å›¾ç‰‡è¯¦æƒ…æ¨¡æ€æ¡† -->
    <div id="imageDetailModal"
        class="fixed inset-0 bg-black/60 backdrop-blur-md z-50 flex items-center justify-center hidden p-4">
        <div class="glass w-full max-w-2xl p-8 rounded-[2.5rem] shadow-2xl space-y-6 modal-enter">
            <h2 class="text-2xl font-extrabold tracking-tight flex items-center gap-2">
                <span class="text-emerald-400">ğŸ”</span> å›¾ç‰‡è¯¦æƒ…
                <span id="detailImageName" class="text-sm text-slate-400 ml-2 truncate"></span>
            </h2>
            
            <div class="image-detail-modal text-center">
                <div id="detailImageContainer">
                    <!-- å›¾ç‰‡å°†é€šè¿‡JSåŠ¨æ€åŠ è½½ -->
                </div>
                
                <div class="image-meta">
                    <div class="image-meta-row">
                        <span class="image-meta-label">å›¾ç‰‡åç§°ï¼š</span>
                        <span id="detailName" class="image-meta-value"></span>
                    </div>
                    <div class="image-meta-row">
                        <span class="image-meta-label">æ–‡ä»¶å¤§å°ï¼š</span>
                        <span id="detailSize" class="image-meta-value"></span>
                    </div>
                    <div class="image-meta-row">
                        <span class="image-meta-label">å›¾ç‰‡å°ºå¯¸ï¼š</span>
                        <span id="detailDimensions" class="image-meta-value"></span>
                    </div>
                    <div class="image-meta-row">
                        <span class="image-meta-label">ä¸Šä¼ æ—¶é—´ï¼š</span>
                        <span id="detailUploadTime" class="image-meta-value"></span>
                    </div>
                    <div class="image-meta-row">
                        <span class="image-meta-label">MIMEç±»å‹ï¼š</span>
                        <span id="detailMimeType" class="image-meta-value"></span>
                    </div>
                    <div class="image-meta-row">
                        <span class="image-meta-label">å›¾ç‰‡IDï¼š</span>
                        <span id="detailImageId" class="image-meta-value"></span>
                    </div>
                </div>
                
                <div class="mt-6 p-4 bg-slate-900/30 rounded-xl">
                    <label class="text-[10px] uppercase tracking-widest text-slate-400 font-bold ml-1 mb-2 block">
                        Markdown é“¾æ¥
                    </label>
                    <div class="flex gap-2">
                        <input type="text" id="detailMarkdownLink" readonly
                               class="flex-1 bg-slate-900/50 border border-slate-700 p-3 rounded-xl outline-none font-mono text-sm">
                        <button onclick="copyMarkdownLink()" 
                                class="bg-emerald-600 hover:bg-emerald-700 text-white p-3 rounded-xl transition">
                            <i class="fas fa-copy"></i>
                        </button>
                    </div>
                    <label class="text-[10px] uppercase tracking-widest text-slate-400 font-bold ml-1 mt-4 mb-2 block">
                        ç›´æ¥é“¾æ¥
                    </label>
                    <div class="flex gap-2">
                        <input type="text" id="detailDirectLink" readonly
                               class="flex-1 bg-slate-900/50 border border-slate-700 p-3 rounded-xl outline-none font-mono text-sm">
                        <button onclick="copyDirectLink()" 
                                class="bg-blue-600 hover:bg-blue-700 text-white p-3 rounded-xl transition">
                            <i class="fas fa-copy"></i>
                        </button>
                    </div>
                </div>
            </div>
            
            <div class="flex gap-3 pt-4">
                <button onclick="closeImageDetail()"
                        class="flex-1 py-4 text-slate-400 font-semibold rounded-2xl hover:bg-slate-800 transition">
                    å…³é—­
                </button>
                <button onclick="confirmDeleteImage()"
                        class="flex-1 py-4 bg-rose-600 hover:bg-rose-700 text-white font-bold rounded-2xl">
                    åˆ é™¤å›¾ç‰‡
                </button>
            </div>
        </div>
    </div>

    <!-- é€‰æ‹©å›¾ç‰‡æ¨¡æ€æ¡† -->
    <div id="selectImageModal"
        class="fixed inset-0 bg-black/60 backdrop-blur-md z-50 flex items-center justify-center hidden p-4">
        <div class="glass w-full max-w-4xl p-8 rounded-[2.5rem] shadow-2xl space-y-6 max-h-[95vh] overflow-hidden flex flex-col modal-enter">
            <h2 class="text-2xl font-extrabold tracking-tight flex items-center gap-2">
                <span class="text-blue-400">ğŸ–¼ï¸</span> é€‰æ‹©å›¾ç‰‡æ’å…¥åˆ°ç¬”è®°
                <button onclick="closeSelectImageModal()" class="ml-auto text-slate-400 hover:text-white">
                    <i class="fas fa-times"></i>
                </button>
            </h2>
            
            <div class="flex-1 overflow-y-auto min-h-0">
                <div class="space-y-4">
                    <div class="flex justify-between items-center">
                        <input type="text" id="selectImageSearch" placeholder="æœç´¢å›¾ç‰‡..." 
                               class="bg-slate-900/50 border border-slate-700 p-3 rounded-xl outline-none focus:ring-2 ring-blue-500/50 w-64"
                               onkeyup="searchSelectImages()">
                        <div class="flex gap-2">
                            <button onclick="showImageManager()" class="text-blue-400 hover:text-blue-300 transition px-4 py-2 glass rounded-xl">
                                <i class="fas fa-plus"></i> ä¸Šä¼ æ–°å›¾ç‰‡
                            </button>
                            <button onclick="refreshSelectImages()" class="text-blue-400 hover:text-blue-300 transition px-4 py-2 glass rounded-xl">
                                <i class="fas fa-sync-alt"></i> åˆ·æ–°
                            </button>
                        </div>
                    </div>
                    
                    <div id="selectImageGrid" class="image-grid-view">
                        <!-- é€‰æ‹©å›¾ç‰‡å°†é€šè¿‡JSåŠ¨æ€åŠ è½½ -->
                    </div>
                    
                    <div id="selectImageLoading" class="text-center py-12">
                        <div class="loader mx-auto"></div>
                        <p class="text-slate-400 mt-4">åŠ è½½å›¾ç‰‡ä¸­...</p>
                    </div>
                    
                    <div id="noSelectImagesMessage" class="text-center py-20 hidden">
                        <div class="text-5xl text-slate-700 mb-4">ğŸ–¼ï¸</div>
                        <p class="text-slate-600">æš‚æ— å›¾ç‰‡ï¼Œç‚¹å‡»"ä¸Šä¼ æ–°å›¾ç‰‡"å¼€å§‹ä¸Šä¼ </p>
                    </div>
                </div>
            </div>
            
            <div class="pt-4 border-t border-white/5 text-sm text-slate-500">
                ç‚¹å‡»å›¾ç‰‡é€‰æ‹©å¹¶æ’å…¥åˆ°å½“å‰ç¼–è¾‘ä½ç½®
            </div>
        </div>
    </div>

    <script>
        // ==================== ç³»ç»Ÿé…ç½® ====================
        const urlParams = new URLSearchParams(window.location.search);
        let apiFromUrl = urlParams.get('api');
        const cfgFromUrl = urlParams.get('cfg');
        if (cfgFromUrl) { try { apiFromUrl = atob(cfgFromUrl); } catch (e) { } }
        const shareId = urlParams.get('share');

        let API_URL = apiFromUrl || localStorage.getItem('cf_notes_api') || "";
        let ADMIN_KEY = localStorage.getItem('cf_notes_key') || "";

        let currentEditId = null;
        let currentEditNavLinkId = null;
        let currentImageId = null;
        let currentImageView = 'upload';
        
        let notesCache = {};
        let navLinksCache = {};
        let imagesCache = {};
        let selectImagesCache = {};
        let currentView = 'notes';
        
        // å›¾ç‰‡ä¸Šä¼ ç›¸å…³å˜é‡
        let selectedFiles = [];
        let uploadQueue = [];
        let isUploading = false;
        let uploadProgress = 0;

        // ==================== é˜…åå³ç„šå˜é‡ ====================
        let burningInterval = null;
        let burnCountdownInterval = null;
        let burnTimeLeft = 10; // 10ç§’åè‡ªåŠ¨å¼€å§‹ç„šæ¯
        let originalContent = '';
        let burningChars = [];
        let isBurningActive = false;
        let totalChars = 0;
        let currentCharIndex = 0; // å½“å‰æ­£åœ¨ç„šæ¯çš„å­—ç¬¦ç´¢å¼•
        let burnCursor = null; // ç„šæ¯å…‰æ ‡

        const app = document.getElementById('app');

        // ==================== å®‰å…¨é…ç½® ====================
        const SESSION_KEY = 'cloudnotes_auth_token';
        const ATTEMPTS_KEY = 'cloudnotes_auth_attempts';
        const MAX_ATTEMPTS = 5;
        const LOCKOUT_TIME = 300000;
        const LOCKOUT_KEY = 'cloudnotes_lockout_until';

        // ==================== åŠ è§£å¯†é€»è¾‘ ====================
        async function getK(pw) {
            const enc = new TextEncoder();
            const hash = await crypto.subtle.digest('SHA-256', enc.encode(pw));
            return await crypto.subtle.importKey('raw', hash, { name: 'AES-GCM' }, false, ['encrypt', 'decrypt']);
        }
        
        async function encrypt(text, pw) {
            const enc = new TextEncoder(); 
            const iv = crypto.getRandomValues(new Uint8Array(12)); 
            const key = await getK(pw);
            const cipher = await crypto.subtle.encrypt({ name: 'AES-GCM', iv }, key, enc.encode(text));
            return btoa(JSON.stringify({ iv: Array.from(iv), data: Array.from(new Uint8Array(cipher)) }));
        }
        
        async function decrypt(json, pw) {
            try {
                const { iv, data } = JSON.parse(atob(json)); 
                const key = await getK(pw);
                const dec = await crypto.subtle.decrypt({ name: 'AES-GCM', iv: new Uint8Array(iv) }, key, new Uint8Array(data));
                return new TextDecoder().decode(dec);
            } catch (e) { return null; }
        }

        // Markdown é…ç½® - ç¡®ä¿ä¸åˆ†äº«é¡µé¢ä¸€è‡´
        marked.setOptions({
            breaks: true,
            gfm: true,
            pedantic: false,
            smartLists: true,
            smartypants: true,
            xhtml: false,
            highlight: function(code, lang) {
                if (lang && hljs.getLanguage(lang)) {
                    try {
                        return hljs.highlight(code, { language: lang }).value;
                    } catch (__) {}
                }
                return hljs.highlightAuto(code).value;
            }
        });

        // ==================== å®‰å…¨éªŒè¯å‡½æ•° ====================
        function checkLockout() {
            const lockoutUntil = localStorage.getItem(LOCKOUT_KEY);
            if (lockoutUntil && Date.now() < parseInt(lockoutUntil)) {
                const remainingMinutes = Math.ceil((parseInt(lockoutUntil) - Date.now()) / 60000);
                return {
                    locked: true,
                    remainingMinutes: remainingMinutes
                };
            }
            return { locked: false };
        }
        
        function setLockout() {
            const lockoutUntil = Date.now() + LOCKOUT_TIME;
            localStorage.setItem(LOCKOUT_KEY, lockoutUntil.toString());
            
            setTimeout(() => {
                localStorage.removeItem(LOCKOUT_KEY);
                localStorage.removeItem(ATTEMPTS_KEY);
                location.reload();
            }, LOCKOUT_TIME);
        }
        
        function getRemainingAttempts() {
            const attempts = localStorage.getItem(ATTEMPTS_KEY);
            return attempts ? MAX_ATTEMPTS - parseInt(attempts) : MAX_ATTEMPTS;
        }
        
        function incrementFailedAttempts() {
            let attempts = localStorage.getItem(ATTEMPTS_KEY);
            attempts = attempts ? parseInt(attempts) + 1 : 1;
            localStorage.setItem(ATTEMPTS_KEY, attempts.toString());
            
            if (attempts >= MAX_ATTEMPTS) {
                setLockout();
            }
            
            return attempts;
        }
        
        function resetFailedAttempts() {
            localStorage.removeItem(ATTEMPTS_KEY);
            localStorage.removeItem(LOCKOUT_KEY);
        }
        
        // ==================== ä¸»éªŒè¯å‡½æ•° ====================
        async function checkPassword() {
            const lockoutCheck = checkLockout();
            const input = document.getElementById('authPassword');
            const attemptsCount = document.getElementById('attemptsCount');
            const verifyBtn = document.getElementById('verifyBtn');
            const loadingSpinner = document.getElementById('loadingSpinner');
            
            if (lockoutCheck.locked) {
                attemptsCount.innerHTML = `è´¦æˆ·å·²é”å®šï¼Œ${lockoutCheck.remainingMinutes}åˆ†é’Ÿåé‡è¯•`;
                input.value = '';
                input.classList.add('login-shake');
                input.disabled = true;
                verifyBtn.disabled = true;
                setTimeout(() => input.classList.remove('login-shake'), 500);
                return;
            }
            
            const password = input.value.trim();
            const remainingAttempts = getRemainingAttempts() - 1;
            
            if (!password) {
                attemptsCount.innerHTML = 'å¯†ç ä¸èƒ½ä¸ºç©º';
                input.classList.add('login-shake');
                setTimeout(() => {
                    input.classList.remove('login-shake');
                    attemptsCount.innerHTML = `å‰©ä½™å°è¯•æ¬¡æ•°: ${remainingAttempts + 1}`;
                }, 500);
                return;
            }
            
            verifyBtn.classList.add('hidden');
            loadingSpinner.classList.remove('hidden');
            input.disabled = true;
            
            try {
                const response = await fetch(`${API_URL}/api/verify-password`, {
                    method: 'POST',
                    headers: { 
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ password: password })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    const token = btoa(Date.now() + '-' + Math.random().toString(36).substr(2));
                    sessionStorage.setItem(SESSION_KEY, token);
                    
                    resetFailedAttempts();
                    
                    document.getElementById('authModal').classList.add('hidden');
                    document.getElementById('appContainer').classList.remove('hidden');
                    
                    initApp();
                } else {
                    const attempts = incrementFailedAttempts();
                    const newRemaining = MAX_ATTEMPTS - attempts;
                    
                    if (attempts >= MAX_ATTEMPTS) {
                        attemptsCount.innerHTML = 'è´¦æˆ·å·²é”å®šï¼Œ5åˆ†é’Ÿåé‡è¯•';
                        setLockout();
                    } else {
                        attemptsCount.innerHTML = `å¯†ç é”™è¯¯ï¼Œå‰©ä½™å°è¯•æ¬¡æ•°: ${newRemaining}`;
                    }
                    
                    input.value = '';
                    input.classList.add('login-shake');
                    setTimeout(() => input.classList.remove('login-shake'), 500);
                }
            } catch (error) {
                console.error("éªŒè¯å¤±è´¥:", error);
                attemptsCount.innerHTML = 'ç½‘ç»œé”™è¯¯ï¼Œè¯·æ£€æŸ¥é…ç½®';
                input.value = '';
                input.classList.add('login-shake');
                setTimeout(() => {
                    input.classList.remove('login-shake');
                    attemptsCount.innerHTML = `å‰©ä½™å°è¯•æ¬¡æ•°: ${remainingAttempts + 1}`;
                }, 500);
            } finally {
                verifyBtn.classList.remove('hidden');
                loadingSpinner.classList.add('hidden');
                input.disabled = false;
                input.focus();
            }
        }
        
        // ç™»å‡º
        function logout() {
            sessionStorage.removeItem(SESSION_KEY);
            localStorage.removeItem(ATTEMPTS_KEY);
            localStorage.removeItem(LOCKOUT_KEY);
            location.reload();
        }
        
        // ==================== åº”ç”¨åˆå§‹åŒ–é€»è¾‘ ====================
        function initApp() {
            if (shareId) {
                renderShareView();
            } else if (!API_URL) {
                renderWelcomeView();
            } else {
                renderMainView();
            }
        }
        
        // æ£€æŸ¥ä¼šè¯
        function checkSession() {
            const token = sessionStorage.getItem(SESSION_KEY);
            const apiUrl = localStorage.getItem('cf_notes_api');
            
            if (shareId) {
                document.getElementById('authModal').classList.add('hidden');
                document.getElementById('appContainer').classList.remove('hidden');
                initApp();
                return true;
            }
            
            if (!apiUrl) {
                document.getElementById('authModal').classList.add('hidden');
                document.getElementById('appContainer').classList.remove('hidden');
                initApp();
                return false;
            }
            
            if (token) {
                try {
                    const parts = atob(token).split('-');
                    if (parts.length === 2) {
                        const timestamp = parseInt(parts[0]);
                        const now = Date.now();
                        if (now - timestamp < 8 * 60 * 60 * 1000) {
                            document.getElementById('authModal').classList.add('hidden');
                            document.getElementById('appContainer').classList.remove('hidden');
                            initApp();
                            return true;
                        }
                    }
                } catch (e) {
                    console.error('TokenéªŒè¯å¤±è´¥:', e);
                }
            }
            
            document.getElementById('authModal').classList.remove('hidden');
            document.getElementById('appContainer').classList.add('hidden');
            
            const lockoutCheck = checkLockout();
            if (lockoutCheck.locked) {
                const attemptsCount = document.getElementById('attemptsCount');
                attemptsCount.innerHTML = `è´¦æˆ·å·²é”å®šï¼Œ${lockoutCheck.remainingMinutes}åˆ†é’Ÿåé‡è¯•`;
                document.getElementById('authPassword').disabled = true;
                document.getElementById('verifyBtn').disabled = true;
            } else {
                const remaining = getRemainingAttempts();
                const attemptsCount = document.getElementById('attemptsCount');
                attemptsCount.innerHTML = `å‰©ä½™å°è¯•æ¬¡æ•°: ${remaining}`;
                document.getElementById('authPassword').disabled = false;
                document.getElementById('verifyBtn').disabled = false;
            }
            
            return false;
        }

        // ==================== è§†å›¾æ¸²æŸ“å‡½æ•° ====================
        function renderWelcomeView() {
            app.innerHTML = `
            <div class="glass p-12 rounded-[3rem] text-center space-y-8 animate-in fade-in zoom-in duration-700">
                <div class="inline-flex p-5 bg-gradient-to-r from-blue-500 to-purple-600 rounded-full text-5xl">ğŸš€</div>
                <div class="space-y-2">
                    <h1 class="text-4xl font-extrabold tracking-tight italic">CloudNotes</h1>
                    <p class="text-slate-400 leading-relaxed">æ‚¨çš„ä¸“å±åŠ å¯†ç¬”è®°ä¸ä¸ªäººå¯¼èˆªç³»ç»Ÿ<br>è¯·å…ˆå…³è”æ‚¨çš„ Cloudflare Worker åç«¯</p>
                </div>
                <button onclick="configUrl()" class="px-10 py-5 gradient-btn text-white font-black rounded-3xl shadow-2xl">åˆå§‹åŒ–é…ç½®</button>
            </div>
        `;
        }

        function renderMainView() {
            app.innerHTML = `
            <div class="space-y-12 animate-in fade-in slide-in-from-bottom-4 duration-700">
                <header class="flex justify-between items-end">
                    <div class="space-y-1">
                        <h1 class="text-4xl font-extrabold tracking-tighter bg-gradient-to-r from-white to-slate-500 bg-clip-text text-transparent">CloudNotes</h1>
                        <p class="text-[10px] uppercase tracking-[0.3em] text-blue-500 font-black">ç«¯åˆ°ç«¯åŠ å¯†ç¬”è®° | ä¸ªäººå¯¼èˆªä¸­å¿ƒ | å›¾ç‰‡ç®¡ç†</p>
                    </div>
                    <div class="flex items-center gap-4">
                        <div class="flex gap-2">
                            <button onclick="switchView('notes')" class="px-4 py-2 rounded-xl ${currentView === 'notes' ? 'gradient-btn text-white' : 'glass text-slate-400'} transition">ğŸ“ ç¬”è®°</button>
                            <button onclick="switchView('nav')" class="px-4 py-2 rounded-xl ${currentView === 'nav' ? 'nav-gradient text-white' : 'glass text-slate-400'} transition">ğŸ”— å¯¼èˆª</button>
                            <button onclick="switchView('images')" class="px-4 py-2 rounded-xl ${currentView === 'images' ? 'image-gradient-btn text-white' : 'glass text-slate-400'} transition">ğŸ–¼ï¸ å›¾ç‰‡</button>
                        </div>
                        <button onclick="logout()" class="text-xs text-slate-400 hover:text-white transition px-3 py-1 glass rounded-full" title="é€€å‡ºç™»å½•">
                            é€€å‡º
                        </button>
                        <button onclick="configUrl()" class="p-4 glass rounded-2xl hover:rotate-180 transition-all duration-500 text-xl">âš™ï¸</button>
                    </div>
                </header>

                <div id="notesView" class="${currentView === 'notes' ? '' : 'hidden'}">
                    <main class="glass p-8 rounded-[2.5rem] shadow-2xl space-y-6 border-white/5 mb-8">
                        <div class="space-y-4">
                            <div>
                                <label class="text-[10px] uppercase tracking-widest text-slate-400 font-bold ml-1 mb-2 block">
                                    è§£å¯†ä¸»å¯†ç 
                                </label>
                                <input id="mainPw" type="password" placeholder="è¾“å…¥ä¸»å¯†ç ä»¥åŠ å¯†/è§£å¯†æ•°æ®" 
                                    class="w-full bg-slate-950/50 border border-slate-800 p-4 rounded-2xl outline-none focus:ring-2 ring-blue-500/50 transition-all font-mono">
                            </div>
                            
                            <div>
                                <div class="flex justify-between items-center mb-2">
                                    <label class="text-[10px] uppercase tracking-widest text-slate-400 font-bold ml-1 block">
                                        ç¬”è®°å†…å®¹ (æ”¯æŒ Markdown æ ¼å¼)
                                    </label>
                                    <button onclick="showMarkdownHelp()" class="text-xs text-blue-400 hover:text-blue-300 transition">ğŸ“– Markdown è¯­æ³•å¸®åŠ©</button>
                                </div>
                                <textarea id="noteInput" placeholder="# è¾“å…¥æ‚¨çš„ Markdown ç¬”è®°...&#10;&#10;## æ”¯æŒåŠŸèƒ½&#10;- æ ‡é¢˜ã€åˆ—è¡¨ã€ä»£ç å—&#10;- **ç²—ä½“**ã€*æ–œä½“*ã€[é“¾æ¥]()&#10;- è¡¨æ ¼ã€å¼•ç”¨ã€åˆ†å‰²çº¿" 
                                    class="w-full bg-slate-950/50 border border-slate-800 p-5 h-64 rounded-2xl outline-none focus:bg-slate-950 transition-all resize-none leading-relaxed font-mono"></textarea>
                                <div class="flex items-center gap-2 text-xs text-slate-500 mt-2">
                                    <span id="noteCharCount">0</span> å­—ç¬¦
                                </div>
                            </div>
                        </div>
                        
                        <div class="grid grid-cols-2 gap-4">
                            <button onclick="doSave()" class="gradient-btn text-white py-5 rounded-2xl font-black tracking-widest uppercase text-xs hover:shadow-lg transition">åŠ å¯†å­˜å…¥äº‘ç«¯</button>
                            <button onclick="doAI()" class="glass text-purple-400 py-5 rounded-2xl font-black tracking-widest uppercase text-xs hover:bg-purple-500/10 transition border-purple-500/20">âœ¨ AI æ™ºèƒ½æ€»ç»“</button>
                        </div>
                    </main>

                    <section class="space-y-6">
                        <div class="flex justify-between items-center px-4">
                            <h2 class="text-xs font-black uppercase tracking-[0.2em] text-slate-500 italic">Vault / æˆ‘çš„åŠ å¯†åº“</h2>
                            <div class="flex gap-2">
                                <button onclick="showMarkdownHelp()" class="text-blue-400 text-xs font-black hover:underline">Markdown è¯­æ³•</button>
                                <button onclick="loadNotesList()" class="text-blue-500 text-xs font-black hover:underline uppercase">åˆ·æ–°åˆ—è¡¨</button>
                            </div>
                        </div>
                        <div id="notesList" class="space-y-6">
                            <div class="text-center py-20 text-slate-600 italic text-sm">é…ç½®å®Œæˆåè¾“å…¥å¯†ç å¹¶ç‚¹å‡»åˆ·æ–°ã€‚</div>
                        </div>
                    </section>
                </div>

                <div id="navView" class="${currentView === 'nav' ? '' : 'hidden'}">
                    <main class="glass p-8 rounded-[2.5rem] shadow-2xl space-y-6 border-white/5 mb-8">
                        <div class="space-y-4">
                            <div class="text-center space-y-2">
                                <h2 class="text-2xl font-extrabold tracking-tight text-purple-300">ğŸ”— ä¸ªäººå¯¼èˆªä¸­å¿ƒ</h2>
                                <p class="text-slate-400 text-sm">ç®¡ç†æ‚¨çš„å¸¸ç”¨é“¾æ¥ï¼Œå¿«é€Ÿè®¿é—®é‡è¦èµ„æº</p>
                            </div>
                            
                            <div class="flex flex-wrap gap-3 justify-center">
                                <button onclick="showAddNavLinkModal()" class="px-6 py-3 nav-gradient text-white rounded-2xl font-bold hover:shadow-lg transition flex items-center gap-2">
                                    <i class="fas fa-plus"></i> æ·»åŠ é“¾æ¥
                                </button>
                                <button onclick="loadNavLinks()" class="px-6 py-3 glass text-purple-400 rounded-2xl font-bold hover:bg-purple-500/10 transition flex items-center gap-2">
                                    <i class="fas fa-sync-alt"></i> åˆ·æ–°åˆ—è¡¨
                                </button>
                                <button onclick="exportNavLinks()" class="px-6 py-3 glass text-emerald-400 rounded-2xl font-bold hover:bg-emerald-500/10 transition flex items-center gap-2">
                                    <i class="fas fa-download"></i> å¯¼å‡ºå¤‡ä»½
                                </button>
                            </div>
                        </div>
                    </main>

                    <section class="space-y-8">
                        <div class="flex justify-between items-center px-4">
                            <h2 class="text-xs font-black uppercase tracking-[0.2em] text-slate-500 italic">Navigation / æˆ‘çš„é“¾æ¥åº“</h2>
                            <div class="text-xs text-slate-500" id="navStats">
                            </div>
                        </div>
                        
                        <div id="navCategories" class="space-y-8">
                            <div class="text-center py-20 text-slate-600 italic text-sm">ç‚¹å‡»"åˆ·æ–°åˆ—è¡¨"åŠ è½½æ‚¨çš„å¯¼èˆªé“¾æ¥</div>
                        </div>
                    </section>
                </div>

                <div id="imagesView" class="${currentView === 'images' ? '' : 'hidden'}">
                    <main class="glass p-8 rounded-[2.5rem] shadow-2xl space-y-6 border-white/5 mb-8">
                        <div class="space-y-4">
                            <div class="text-center space-y-2">
                                <h2 class="text-2xl font-extrabold tracking-tight text-emerald-300">ğŸ–¼ï¸ å›¾ç‰‡ç®¡ç†</h2>
                                <p class="text-slate-400 text-sm">ä¸Šä¼ ã€ç®¡ç†å’Œä½¿ç”¨å›¾ç‰‡ï¼Œæ”¯æŒæ‹–æ”¾ä¸Šä¼ </p>
                            </div>
                            
                            <div class="flex flex-wrap gap-3 justify-center">
                                <button onclick="showImageManager()" class="px-6 py-3 image-gradient-btn text-white rounded-2xl font-bold hover:shadow-lg transition flex items-center gap-2">
                                    <i class="fas fa-upload"></i> ä¸Šä¼ å›¾ç‰‡
                                </button>
                                <button onclick="loadImageStats()" class="px-6 py-3 glass text-emerald-400 rounded-2xl font-bold hover:bg-emerald-500/10 transition flex items-center gap-2">
                                    <i class="fas fa-chart-bar"></i> æŸ¥çœ‹ç»Ÿè®¡
                                </button>
                                <button onclick="exportImageList()" class="px-6 py-3 glass text-blue-400 rounded-2xl font-bold hover:bg-blue-500/10 transition flex items-center gap-2">
                                    <i class="fas fa-download"></i> å¯¼å‡ºåˆ—è¡¨
                                </button>
                            </div>
                        </div>
                    </main>

                    <section class="space-y-8">
                        <div class="flex justify-between items-center px-4">
                            <h2 class="text-xs font-black uppercase tracking-[0.2em] text-slate-500 italic">Images / å›¾ç‰‡åº“</h2>
                            <div class="text-xs text-slate-500" id="imagesSummary">
                                æ­£åœ¨åŠ è½½å›¾ç‰‡ç»Ÿè®¡...
                            </div>
                        </div>
                        
                        <div id="imagesContent" class="space-y-8">
                            <div class="text-center py-20 text-slate-600 italic text-sm">
                                ç‚¹å‡»"ä¸Šä¼ å›¾ç‰‡"å¼€å§‹ç®¡ç†æ‚¨çš„å›¾ç‰‡åº“
                            </div>
                        </div>
                    </section>
                </div>
                
                <footer class="text-center pt-8 pb-4 opacity-50 hover:opacity-100 transition duration-500">
                    <span class="text-3xl font-black uppercase tracking-widest text-red-500">
                        è’¼å¤©å·²æ­»ï¼Œé»ƒå¤©ç•¶ç«‹
                    </span>
                </footer>
            </div>
        `;
            
            // æ·»åŠ å­—ç¬¦è®¡æ•°ç›‘å¬
            const noteInput = document.getElementById('noteInput');
            const noteCharCount = document.getElementById('noteCharCount');
            if (noteInput && noteCharCount) {
                noteInput.addEventListener('input', function() {
                    noteCharCount.textContent = this.value.length;
                });
            }
            
            // åŠ è½½é»˜è®¤è§†å›¾æ•°æ®
            if (currentView === 'notes') {
            } else if (currentView === 'nav') {
                loadNavLinks();
            } else if (currentView === 'images') {
                loadImageStats();
            }
            
            // æ˜¾ç¤ºå¿«é€Ÿè®¿é—®æ 
            document.getElementById('quickAccessBar').classList.remove('hidden');
        }

        function renderShareView() {
            app.innerHTML = `
            <div class="space-y-12 animate-in fade-in slide-in-from-bottom-4 duration-700">
                <header class="flex justify-between items-end">
                    <div class="space-y-1">
                        <h1 class="text-4xl font-extrabold tracking-tighter bg-gradient-to-r from-orange-500 to-red-500 bg-clip-text text-transparent">CloudNotes</h1>
                        <p class="text-[10px] uppercase tracking-[0.3em] text-orange-500 font-black">é˜…åå³ç„š | åˆ†äº«è§£å¯†</p>
                    </div>
                    <div class="flex items-center gap-4">
                        <button onclick="window.location.href = window.location.origin + window.location.pathname" 
                                class="text-xs text-slate-400 hover:text-white transition px-3 py-1 glass rounded-full" 
                                title="è¿”å›ä¸»é¡µ">
                            è¿”å›ä¸»é¡µ
                        </button>
                    </div>
                </header>

                <main class="glass p-12 rounded-[3rem] shadow-2xl text-center space-y-8">
                    <div class="text-6xl animate-bounce">ğŸ”¥</div>
                    <div class="space-y-2">
                        <h1 class="text-3xl font-black italic">é˜…åå³ç„šè§£å¯†</h1>
                        <p class="text-slate-400 text-sm">è§£å¯†åæ•°æ®å°†ç«‹å³ä»æœåŠ¡å™¨ç‰©ç†æ“¦é™¤</p>
                    </div>
                    <input id="sharePw" type="password" placeholder="è¯·è¾“å…¥ 6 ä½ä»¥ä¸Šè§£å¯†å¯†ç " 
                           class="w-full bg-slate-950/50 border border-slate-800 p-5 rounded-2xl outline-none focus:ring-2 ring-orange-500/50 text-center font-mono">
                    <button id="unlockBtn" onclick="doUnlockShare()" 
                            class="w-full share-gradient text-white py-5 rounded-2xl font-black uppercase tracking-widest shadow-xl hover:scale-[1.02] transition">
                        è§£å¯†å¹¶é”€æ¯
                    </button>
                    <div id="shareResult" class="mt-8 hidden">
                        <div class="text-left p-6 bg-slate-950/50 rounded-2xl border border-orange-500/20 ring-1 ring-orange-500/10 shadow-inner leading-relaxed">
                            <div class="flex justify-between items-center mb-4">
                                <span class="text-xs uppercase tracking-widest text-slate-400 font-bold">é˜…åå³ç„šå†…å®¹</span>
                                <button onclick="startBurnAnimation()" id="burnNowBtn" class="text-xs text-orange-500 hover:text-red-500 transition font-bold uppercase tracking-widest flex items-center gap-2">
                                    <i class="fas fa-fire"></i>
                                    <span>ç«‹å³ç„šæ¯</span>
                                </button>
                            </div>
                            <div id="burningContent" class="markdown-preview relative"></div>
                            <div class="mt-4 pt-4 border-t border-orange-500/10 space-y-2">
                                <div class="flex items-center justify-between">
                                    <div id="burnProgress" class="text-xs text-slate-500">
                                        å·²ç„šæ¯: <span id="charsBurned">0</span>/<span id="totalChars">0</span>
                                        <span id="burnPercentage" class="ml-2 text-orange-500">0%</span>
                                    </div>
                                    <div id="burnTimer" class="text-xs text-orange-500 hidden flex items-center gap-2">
                                        <i class="fas fa-clock animate-pulse"></i>
                                        <span id="timeLeft">10</span>ç§’åè‡ªåŠ¨ç„šæ¯
                                    </div>
                                </div>
                                <div class="w-full bg-slate-800/50 h-2 rounded-full overflow-hidden">
                                    <div id="burnProgressBar" class="h-full bg-gradient-to-r from-orange-500 to-red-500 rounded-full transition-all duration-300" style="width: 0%"></div>
                                </div>
                                <div class="text-xs text-slate-500 flex justify-between">
                                    <span>å¼€å§‹</span>
                                    <span id="burnSpeed">é€Ÿåº¦: ä¸­</span>
                                    <span>ç»“æŸ</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </main>
                
                <footer class="text-center pt-8 pb-4 opacity-50 hover:opacity-100 transition duration-500">
                    <span class="text-3xl font-black uppercase tracking-widest text-red-500">
                        è’¼å¤©å·²æ­»ï¼Œé»ƒå¤©ç•¶ç«‹
                    </span>
                </footer>
            </div>
        `;
            
            // æ·»åŠ å›è½¦é”®æ”¯æŒ
            const sharePwInput = document.getElementById('sharePw');
            if (sharePwInput) {
                sharePwInput.addEventListener('keydown', function(event) {
                    if (event.key === 'Enter') {
                        doUnlockShare();
                    }
                });
            }
        }

        // ==================== è§†å›¾åˆ‡æ¢ ====================
        function switchView(view) {
            currentView = view;
            renderMainView();
        }

        // ==================== å¯¼èˆªåŠŸèƒ½ ====================
        async function loadNavLinks() {
            try {
                const response = await fetch(`${API_URL}/api/nav/list`, {
                    headers: { 'Authorization': ADMIN_KEY }
                });
                
                if (!response.ok) {
                    throw new Error('è·å–å¯¼èˆªé“¾æ¥å¤±è´¥');
                }
                
                const navLinks = await response.json();
                
                navLinksCache = {};
                navLinks.forEach(link => {
                    navLinksCache[link.id] = link;
                });
                
                const categories = {};
                navLinks.forEach(link => {
                    const category = link.category || 'æœªåˆ†ç±»';
                    if (!categories[category]) {
                        categories[category] = [];
                    }
                    categories[category].push(link);
                });
                
                const navCategoriesDiv = document.getElementById('navCategories');
                if (navLinks.length === 0) {
                    navCategoriesDiv.innerHTML = `
                        <div class="text-center py-20 space-y-4">
                            <div class="text-5xl text-slate-700">ğŸ”—</div>
                            <p class="text-slate-600 italic">æš‚æ— å¯¼èˆªé“¾æ¥ï¼Œç‚¹å‡»"æ·»åŠ é“¾æ¥"å¼€å§‹åˆ›å»º</p>
                        </div>
                    `;
                    document.getElementById('navStats').textContent = '0 ä¸ªé“¾æ¥';
                    return;
                }
                
                let html = '';
                const categoryNames = Object.keys(categories).sort();
                
                categoryNames.forEach(category => {
                    const links = categories[category];
                    html += `
                        <div class="space-y-4">
                            <h3 class="text-lg font-bold text-slate-300 flex items-center gap-2">
                                <span class="category-tag bg-purple-900/30 text-purple-400">${category}</span>
                                <span class="text-sm text-slate-500">(${links.length}ä¸ªé“¾æ¥)</span>
                            </h3>
                            <div class="nav-grid">
                    `;
                    
                    links.forEach(link => {
                        const iconClass = link.icon || 'fas fa-globe';
                        const iconColor = link.icon_color || 'icon-blue';
                        const description = link.description ? `<p class="text-xs text-slate-500 mt-1 line-clamp-2">${link.description}</p>` : '';
                        
                        html += `
                            <div class="nav-link-card glass p-5 rounded-2xl space-y-3 cursor-pointer" onclick="openLinkInNewTab('${link.url}')" title="ç‚¹å‡»è®¿é—®: ${link.url}">
                                <div class="flex items-start justify-between">
                                    <div class="flex items-center gap-3">
                                        <div class="p-2 bg-slate-800/50 rounded-lg">
                                            <i class="${iconClass} ${iconColor} text-lg"></i>
                                        </div>
                                        <div class="flex-1">
                                            <h4 class="font-bold text-slate-200">${link.title}</h4>
                                            ${description}
                                        </div>
                                    </div>
                                    <button onclick="event.stopPropagation(); editNavLink(${link.id})" class="p-2 text-slate-500 hover:text-purple-400 transition" title="ç¼–è¾‘">
                                        <i class="fas fa-edit"></i>
                                    </button>
                                </div>
                                <div class="flex justify-between items-center text-xs text-slate-500">
                                    <span class="truncate font-mono" title="${link.url}">${link.url.replace(/https?:\/\//, '')}</span>
                                    <span>${new Date(link.created_at).toLocaleDateString()}</span>
                                </div>
                            </div>
                        `;
                    });
                    
                    html += `
                            </div>
                        </div>
                    `;
                });
                
                navCategoriesDiv.innerHTML = html;
                
                document.getElementById('navStats').textContent = `${navLinks.length} ä¸ªé“¾æ¥ï¼Œ${categoryNames.length} ä¸ªåˆ†ç±»`;
                
            } catch (error) {
                console.error('åŠ è½½å¯¼èˆªé“¾æ¥å¤±è´¥:', error);
                const navCategoriesDiv = document.getElementById('navCategories');
                navCategoriesDiv.innerHTML = `
                    <div class="text-center py-20 text-slate-700 italic text-sm">
                        åŠ è½½å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥æˆ–é…ç½®
                    </div>
                `;
            }
        }
        
        function openLinkInNewTab(url) {
            window.open(url, '_blank');
        }
        
        function showAddNavLinkModal() {
            document.getElementById('addNavLinkModal').classList.remove('hidden');
            document.getElementById('navLinkTitle').value = '';
            document.getElementById('navLinkUrl').value = '';
            document.getElementById('navLinkCategory').value = 'æ—¥å¸¸æ•ˆç‡';
            document.getElementById('navLinkIcon').value = 'fas fa-globe';
            document.getElementById('navLinkIconColor').value = 'icon-blue';
            document.getElementById('navLinkDescription').value = '';
        }
        
        function closeAddNavLinkModal() {
            document.getElementById('addNavLinkModal').classList.add('hidden');
        }
        
        function setNavCategory(category) {
            document.getElementById('navLinkCategory').value = category;
        }
        
        function setNavIcon(icon, color) {
            document.getElementById('navLinkIcon').value = icon;
            document.getElementById('navLinkIconColor').value = color;
        }
        
        async function saveNavLink() {
            const title = document.getElementById('navLinkTitle').value.trim();
            const url = document.getElementById('navLinkUrl').value.trim();
            const category = document.getElementById('navLinkCategory').value.trim() || 'æœªåˆ†ç±»';
            const icon = document.getElementById('navLinkIcon').value;
            const icon_color = document.getElementById('navLinkIconColor').value;
            const description = document.getElementById('navLinkDescription').value.trim();
            
            if (!title || !url) {
                alert("è¯·å¡«å†™é“¾æ¥æ ‡é¢˜å’Œåœ°å€");
                return;
            }
            
            if (!url.startsWith('http://') && !url.startsWith('https://')) {
                alert("é“¾æ¥åœ°å€æ ¼å¼ä¸æ­£ç¡®ï¼Œè¯·ä»¥ http:// æˆ– https:// å¼€å¤´");
                return;
            }
            
            try {
                const response = await fetch(`${API_URL}/api/nav/save`, {
                    method: 'POST',
                    headers: { 
                        'Content-Type': 'application/json',
                        'Authorization': ADMIN_KEY 
                    },
                    body: JSON.stringify({
                        title,
                        url,
                        category,
                        icon,
                        icon_color,
                        description
                    })
                });
                
                if (response.ok) {
                    alert("âœ… å¯¼èˆªé“¾æ¥å·²ä¿å­˜");
                    closeAddNavLinkModal();
                    loadNavLinks();
                } else {
                    alert("âŒ ä¿å­˜å¤±è´¥");
                }
            } catch (error) {
                console.error('ä¿å­˜å¯¼èˆªé“¾æ¥å¤±è´¥:', error);
                alert("âŒ ç½‘ç»œè¿æ¥å¤±è´¥");
            }
        }
        
        async function editNavLink(id) {
            const link = navLinksCache[id];
            if (!link) {
                alert("é“¾æ¥ä¸å­˜åœ¨");
                return;
            }
            
            currentEditNavLinkId = id;
            document.getElementById('editNavLinkId').textContent = `#${id}`;
            document.getElementById('editNavLinkTitle').value = link.title;
            document.getElementById('editNavLinkUrl').value = link.url;
            document.getElementById('editNavLinkCategory').value = link.category || 'æœªåˆ†ç±»';
            document.getElementById('editNavLinkIcon').value = link.icon || 'fas fa-globe';
            document.getElementById('editNavLinkIconColor').value = link.icon_color || 'icon-blue';
            document.getElementById('editNavLinkDescription').value = link.description || '';
            
            const iconPreview = document.getElementById('editNavIconPreview');
            iconPreview.innerHTML = `<i class="${link.icon || 'fas fa-globe'} ${link.icon_color || 'icon-blue'} text-2xl"></i>`;
            
            document.getElementById('editNavLinkModal').classList.remove('hidden');
        }
        
        function setEditNavCategory(category) {
            document.getElementById('editNavLinkCategory').value = category;
        }
        
        function setEditNavIcon(icon, color) {
            document.getElementById('editNavLinkIcon').value = icon;
            document.getElementById('editNavLinkIconColor').value = color;
            const iconPreview = document.getElementById('editNavIconPreview');
            iconPreview.innerHTML = `<i class="${icon} ${color} text-2xl"></i>`;
        }
        
        function closeEditNavLinkModal() {
            document.getElementById('editNavLinkModal').classList.add('hidden');
            currentEditNavLinkId = null;
        }
        
        async function updateNavLink() {
            const title = document.getElementById('editNavLinkTitle').value.trim();
            const url = document.getElementById('editNavLinkUrl').value.trim();
            const category = document.getElementById('editNavLinkCategory').value.trim() || 'æœªåˆ†ç±»';
            const icon = document.getElementById('editNavLinkIcon').value;
            const icon_color = document.getElementById('editNavLinkIconColor').value;
            const description = document.getElementById('editNavLinkDescription').value.trim();
            
            if (!title || !url) {
                alert("è¯·å¡«å†™é“¾æ¥æ ‡é¢˜å’Œåœ°å€");
                return;
            }
            
            if (!url.startsWith('http://') && !url.startsWith('https://')) {
                alert("é“¾æ¥åœ°å€æ ¼å¼ä¸æ­£ç¡®ï¼Œè¯·ä»¥ http:// æˆ– https:// å¼€å¤´");
                return;
            }
            
            try {
                const response = await fetch(`${API_URL}/api/nav/save`, {
                    method: 'POST',
                    headers: { 
                        'Content-Type': 'application/json',
                        'Authorization': ADMIN_KEY 
                    },
                    body: JSON.stringify({
                        id: currentEditNavLinkId,
                        title,
                        url,
                        category,
                        icon,
                        icon_color,
                        description
                    })
                });
                
                if (response.ok) {
                    alert("âœ… å¯¼èˆªé“¾æ¥å·²æ›´æ–°");
                    closeEditNavLinkModal();
                    loadNavLinks();
                } else {
                    alert("âŒ æ›´æ–°å¤±è´¥");
                }
            } catch (error) {
                console.error('æ›´æ–°å¯¼èˆªé“¾æ¥å¤±è´¥:', error);
                alert("âŒ ç½‘ç»œè¿æ¥å¤±è´¥");
            }
        }
        
        function confirmDeleteNavLink() {
            if (confirm("ç¡®å®šè¦åˆ é™¤è¿™ä¸ªå¯¼èˆªé“¾æ¥å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ’¤é”€ã€‚")) {
                deleteNavLink(currentEditNavLinkId);
            }
        }
        
        async function deleteNavLink(id) {
            try {
                const response = await fetch(`${API_URL}/api/nav/delete`, {
                    method: 'POST',
                    headers: { 
                        'Content-Type': 'application/json',
                        'Authorization': ADMIN_KEY 
                    },
                    body: JSON.stringify({ id })
                });
                
                if (response.ok) {
                    alert("âœ… å¯¼èˆªé“¾æ¥å·²åˆ é™¤");
                    closeEditNavLinkModal();
                    loadNavLinks();
                } else {
                    alert("âŒ åˆ é™¤å¤±è´¥");
                }
            } catch (error) {
                console.error('åˆ é™¤å¯¼èˆªé“¾æ¥å¤±è´¥:', error);
                alert("âŒ ç½‘ç»œè¿æ¥å¤±è´¥");
            }
        }
        
        async function exportNavLinks() {
            try {
                const response = await fetch(`${API_URL}/api/nav/list`, {
                    headers: { 'Authorization': ADMIN_KEY }
                });
                
                if (!response.ok) {
                    throw new Error('è·å–å¯¼èˆªé“¾æ¥å¤±è´¥');
                }
                
                const navLinks = await response.json();
                
                const exportData = {
                    export_date: new Date().toISOString(),
                    total_links: navLinks.length,
                    categories: {},
                    links: navLinks
                };
                
                navLinks.forEach(link => {
                    const category = link.category || 'æœªåˆ†ç±»';
                    if (!exportData.categories[category]) {
                        exportData.categories[category] = [];
                    }
                    exportData.categories[category].push(link.title);
                });
                
                const blob = new Blob([JSON.stringify(exportData, null, 2)], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `CloudNotes_Nav_Export_${new Date().toISOString().split('T')[0]}.json`;
                a.click();
                URL.revokeObjectURL(url);
                
            } catch (error) {
                console.error('å¯¼å‡ºå¯¼èˆªé“¾æ¥å¤±è´¥:', error);
                alert("âŒ å¯¼å‡ºå¤±è´¥");
            }
        }

        // ==================== ç¬”è®°åŠŸèƒ½ ====================
        function showAddNoteModal() {
            document.getElementById('addNoteModal').classList.remove('hidden');
            document.getElementById('quickMainPw').value = '';
            document.getElementById('quickNoteInput').value = '';
            document.getElementById('quickNoteCharCount').textContent = '0';
            
            const quickNoteInput = document.getElementById('quickNoteInput');
            const quickNoteCharCount = document.getElementById('quickNoteCharCount');
            quickNoteInput.addEventListener('input', function() {
                quickNoteCharCount.textContent = this.value.length;
            });
        }
        
        function closeAddNoteModal() {
            document.getElementById('addNoteModal').classList.add('hidden');
        }
        
        async function quickSaveNote() {
            const text = document.getElementById('quickNoteInput').value;
            const pw = document.getElementById('quickMainPw').value;
            
            if (!text || !pw) {
                alert("è¯·å¡«å†™å†…å®¹å’Œå¯†ç ");
                return;
            }
            
            try {
                const cipher = await encrypt(text, pw);
                
                const res = await fetch(`${API_URL}/api/save`, {
                    method: 'POST', 
                    headers: { 
                        'Content-Type': 'application/json', 
                        'Authorization': ADMIN_KEY 
                    },
                    body: JSON.stringify({ content: cipher })
                });
                
                if (res.ok) { 
                    alert("âœ… ç¬”è®°å·²å­˜å…¥å®‰å…¨åº“"); 
                    closeAddNoteModal();
                    if (currentView === 'notes') {
                        loadNotesList();
                    }
                } else {
                    alert("âŒ ä¿å­˜å¤±è´¥");
                }
            } catch (e) { 
                alert("âŒ ç½‘ç»œè¿æ¥å¤±è´¥"); 
            }
        }
        
        // ==================== æ ¸å¿ƒæ”¹è¿›éƒ¨åˆ† ====================
        
        // Base64 ç¼–ç è¾…åŠ©å‡½æ•°ï¼ˆæ”¯æŒä¸­æ–‡ï¼‰
        function base64Encode(str) {
            try {
                return btoa(unescape(encodeURIComponent(str)));
            } catch (e) {
                console.error('Base64ç¼–ç å¤±è´¥:', e);
                return '';
            }
        }
        
        // Base64 è§£ç è¾…åŠ©å‡½æ•°
        function base64Decode(str) {
            try {
                return decodeURIComponent(escape(atob(str)));
            } catch (e) {
                console.error('Base64è§£ç å¤±è´¥:', e);
                return '';
            }
        }
        
        // ä» data å±æ€§å¯¼å‡ºçš„å‡½æ•°
        function exportFromData(button) {
            const id = button.getAttribute('data-note-id');
            const base64Content = button.getAttribute('data-note-content-base64');
            
            if (!base64Content) {
                // å›é€€åˆ°ä»ç¼“å­˜è·å–
                const note = notesCache[id];
                if (note && note.clearText) {
                    doExport(note.clearText, parseInt(id));
                } else {
                    alert('æ— æ³•è·å–ç¬”è®°å†…å®¹');
                }
                return;
            }
            
            try {
                const text = base64Decode(base64Content);
                if (text) {
                    doExport(text, parseInt(id));
                } else {
                    throw new Error('è§£ç å¤±è´¥');
                }
            } catch (e) {
                console.error('å¯¼å‡ºå¤±è´¥:', e);
                alert('å¯¼å‡ºå¤±è´¥ï¼Œè¯·é‡è¯•');
            }
        }
        
        // ä» data å±æ€§ç¼–è¾‘çš„å‡½æ•°
        function editFromData(button) {
            const id = button.getAttribute('data-note-id');
            const base64Content = button.getAttribute('data-note-content-base64');
            
            if (!base64Content) {
                // å›é€€åˆ°ä»ç¼“å­˜è·å–
                const note = notesCache[id];
                if (note && note.clearText) {
                    openEdit(parseInt(id), note.clearText);
                } else {
                    alert('æ— æ³•è·å–ç¬”è®°å†…å®¹');
                }
                return;
            }
            
            try {
                const text = base64Decode(base64Content);
                if (text) {
                    openEdit(parseInt(id), text);
                } else {
                    throw new Error('è§£ç å¤±è´¥');
                }
            } catch (e) {
                console.error('ç¼–è¾‘å¤±è´¥:', e);
                alert('ç¼–è¾‘å¤±è´¥ï¼Œè¯·é‡è¯•');
            }
        }
        
        // ä¿®æ”¹åçš„åŠ è½½ç¬”è®°åˆ—è¡¨å‡½æ•° - åŒ…å«é¡¶éƒ¨å’Œåº•éƒ¨çš„å±•å¼€/æ”¶èµ·æŒ‰é’®
        async function loadNotesList() {
            const pw = document.getElementById('mainPw').value; 
            if (!pw) return alert("è¯·è¾“å…¥å¯†ç è§£å¯†");
            
            const listDiv = document.getElementById('notesList');
            listDiv.innerHTML = '<div class="text-center py-12 text-slate-600 italic text-sm">åŠ è½½ä¸­...</div>';
            
            try {
                const res = await fetch(`${API_URL}/api/list`, { headers: { 'Authorization': ADMIN_KEY } });
                const notes = await res.json(); 
                listDiv.innerHTML = "";
                
                if (notes.length === 0) {
                    listDiv.innerHTML = '<div class="text-center py-20 text-slate-700 italic text-sm">æš‚æ— æ•°æ®</div>';
                    return;
                }
                
                notesCache = {};
                
                for (let n of notes) {
                    const clearText = await decrypt(n.content, pw);
                    if (!clearText) {
                        continue;
                    }
                    
                    notesCache[n.id] = {
                        id: n.id,
                        clearText: clearText,
                        created_at: n.created_at
                    };
                    
                    const isMarkdown = clearText.includes('# ') || clearText.includes('## ') || clearText.includes('```') || 
                                       clearText.includes('**') || clearText.includes('- ') || clearText.includes('> ');
                    
                    const card = document.createElement('div');
                    card.className = "note-card glass p-6 rounded-3xl space-y-4 border border-white/5 shadow-lg group";
                    
                    let previewContent = clearText;
                    let showFullButton = false;
                    
                    if (clearText.length > 300) {
                        previewContent = clearText.substring(0, 300) + '...';
                        showFullButton = true;
                    }
                    
                    const renderedContent = isMarkdown ? marked.parse(previewContent) : 
                                            `<div class="whitespace-pre-wrap">${previewContent.replace(/\n/g, '<br>')}</div>`;
                    
                    // ä½¿ç”¨ Base64 ç¼–ç å†…å®¹å­˜å‚¨åœ¨ data å±æ€§ä¸­
                    const base64Content = base64Encode(clearText);
                    
                    card.innerHTML = `
                        <div class="flex justify-between items-center mb-2">
                            <span class="text-[9px] font-black text-slate-500 tracking-widest uppercase italic">
                                ç´¢å¼•ç¼–å· #${n.id}
                            </span>
                            
                            <div class="flex items-center gap-4">
                                ${showFullButton ? `
                                <button onclick="toggleNoteContent(${n.id})" 
                                        class="toggle-btn flex items-center gap-1 px-2 py-1 text-xs text-blue-400 hover:text-blue-300 hover:bg-blue-900/20 rounded-lg transition"
                                        id="topToggle-${n.id}">
                                    <i class="fas fa-chevron-down text-[10px]"></i>
                                    <span>æ˜¾ç¤ºå…¨éƒ¨å†…å®¹</span>
                                </button>
                                ` : ''}
                                
                                <span class="text-[9px] font-black text-slate-500 tracking-widest uppercase italic">
                                    ${new Date(n.created_at).toLocaleString()}
                                </span>
                            </div>
                        </div>
                        
                        <div class="markdown-preview text-slate-300 text-sm leading-relaxed" id="noteContent-${n.id}">
                            ${renderedContent}
                            ${showFullButton ? `
                            <div class="text-center mt-4">
                                <button onclick="toggleNoteContent(${n.id})" 
                                        class="toggle-btn flex items-center justify-center gap-1 mx-auto px-4 py-2 text-xs text-blue-400 hover:text-blue-300 hover:bg-blue-900/20 rounded-lg transition"
                                        id="bottomToggle-${n.id}">
                                    <i class="fas fa-chevron-down text-[10px]"></i>
                                    <span>æ˜¾ç¤ºå…¨éƒ¨å†…å®¹</span>
                                </button>
                            </div>
                            ` : ''}
                        </div>
                        
                        <div class="pt-4 border-t border-white/5 flex flex-wrap gap-4 items-center">
                            <button onclick="doShareCopy(event, '${n.content.replace(/'/g, "\\'")}')" class="share-btn text-xs font-black text-blue-400 uppercase tracking-widest hover:text-blue-300 transition flex items-center gap-1">
                                <i class="fas fa-share"></i>
                                <span>ç”Ÿæˆåˆ†äº«</span>
                            </button>
                            <button data-note-id="${n.id}" data-note-content-base64="${base64Content}" onclick="exportFromData(this)" class="text-xs font-black text-emerald-500 uppercase tracking-widest hover:text-emerald-400 transition flex items-center gap-1">
                                <i class="fas fa-download"></i>
                                <span>å¯¼å‡ºå¤‡ä»½</span>
                            </button>
                            <button data-note-id="${n.id}" data-note-content-base64="${base64Content}" onclick="editFromData(this)" class="text-xs font-black text-amber-500 uppercase tracking-widest hover:text-amber-400 transition flex items-center gap-1">
                                <i class="fas fa-edit"></i>
                                <span>ç¼–è¾‘</span>
                            </button>
                            <button onclick="doDelete(${n.id})" class="text-xs font-black text-rose-500 uppercase tracking-widest ml-auto opacity-40 group-hover:opacity-100 transition flex items-center gap-1">
                                <i class="fas fa-trash"></i>
                                <span>åˆ é™¤</span>
                            </button>
                        </div>
                    `;
                    listDiv.appendChild(card);
                }
                
                // é«˜äº®ä»£ç å—
                setTimeout(() => {
                    hljs.highlightAll();
                }, 100);
            } catch (e) { 
                console.error('åŠ è½½åˆ—è¡¨å¤±è´¥:', e);
                listDiv.innerHTML = '<div class="text-center py-20 text-slate-700 italic text-sm">æ‹‰å–å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥</div>';
            }
        }

        // ==================== é€šç”¨åŠŸèƒ½ ====================
        function configUrl() {
            document.getElementById('settingsModal').classList.remove('hidden');
            document.getElementById('setApi').value = API_URL;
            document.getElementById('setKey').value = ADMIN_KEY;
        }
        
        function closeSettings() { 
            document.getElementById('settingsModal').classList.add('hidden'); 
        }
        
        function saveSettings() {
            let apiUrl = document.getElementById('setApi').value.trim();
    
    // ç§»é™¤å°¾éƒ¨æ–œæ åç»Ÿä¸€æ·»åŠ 
            apiUrl = apiUrl.replace(/\/+$/, '');
            
            localStorage.setItem('cf_notes_api', apiUrl);
            localStorage.setItem('cf_notes_key', document.getElementById('setKey').value);
            
            location.reload();
        }

        function showMarkdownHelp() {
            const helpContent = `# Markdown è¯­æ³•é€ŸæŸ¥

## æ ‡é¢˜
\`# ä¸€çº§æ ‡é¢˜\`
\`## äºŒçº§æ ‡é¢˜\`
\`### ä¸‰çº§æ ‡é¢˜\`

## æ–‡æœ¬æ ·å¼
- **ç²—ä½“**: \`**ç²—ä½“æ–‡æœ¬**\`
- *æ–œä½“*: \`*æ–œä½“æ–‡æœ¬*\`
- ~~åˆ é™¤çº¿~~: \`~~åˆ é™¤æ–‡æœ¬~~\`
- \`è¡Œå†…ä»£ç \`: \`\` ä»£ç  \`\`

## åˆ—è¡¨
- æ— åºåˆ—è¡¨: \`- é¡¹ç›®\`
- æœ‰åºåˆ—è¡¨: \`1. é¡¹ç›®\`

## é“¾æ¥ä¸å›¾ç‰‡
- [é“¾æ¥](https://example.com): \`[é“¾æ¥æ–‡æœ¬](URL)\`
- ![å›¾ç‰‡](https://example.com/image.jpg): \`![æ›¿ä»£æ–‡æœ¬](å›¾ç‰‡URL)\`

## ä»£ç å—
\`\`\`javascript
// JavaScript ä»£ç 
console.log('Hello');
\`\`\`

## å¼•ç”¨
> å¼•ç”¨å†…å®¹: \`> å¼•ç”¨æ–‡æœ¬\`

## è¡¨æ ¼
| è¡¨å¤´ | è¡¨å¤´ |
|------|------|
| å†…å®¹ | å†…å®¹ |

## åˆ†å‰²çº¿
\`---\` æˆ– \`***\`

## ä»»åŠ¡åˆ—è¡¨
- [ ] æœªå®Œæˆä»»åŠ¡
- [x] å·²å®Œæˆä»»åŠ¡`;

            alert(helpContent);
        }

        // ==================== ç¼–è¾‘æ¨¡å¼åŠŸèƒ½ ====================
        function switchTab(tabName) {
            const editTab = document.getElementById('editTab');
            const previewTab = document.getElementById('previewTab');
            const editTabBtn = document.getElementById('editTabBtn');
            const previewTabBtn = document.getElementById('previewTabBtn');
            const editContent = document.getElementById('editNoteContent');
            
            if (tabName === 'edit') {
                editTab.classList.remove('hidden');
                previewTab.classList.add('hidden');
                editTabBtn.classList.add('active');
                previewTabBtn.classList.remove('active');
            } else {
                editTab.classList.add('hidden');
                previewTab.classList.remove('hidden');
                editTabBtn.classList.remove('active');
                previewTabBtn.classList.add('active');
                
                const previewDiv = document.getElementById('markdownPreview');
                const markdownContent = editContent.value || '';
                
                // ä½¿ç”¨ä¸åˆ†äº«é¡µé¢å®Œå…¨ç›¸åŒçš„æ¸²æŸ“æ–¹å¼
                previewDiv.innerHTML = marked.parse(markdownContent);
                
                // é«˜äº®ä»£ç å— - ä½¿ç”¨ä¸åˆ†äº«é¡µé¢ç›¸åŒçš„è®¾ç½®
                setTimeout(() => {
                    hljs.highlightAll();
                    
                    // ç¡®ä¿æ‰€æœ‰ä»£ç å—éƒ½æœ‰æ­£ç¡®çš„èƒŒæ™¯
                    previewDiv.querySelectorAll('pre code').forEach((block) => {
                        if (!block.classList.contains('hljs')) {
                            hljs.highlightElement(block);
                        }
                    });
                }, 100);
            }
        }

        function insertMarkdown(syntax, placeholder) {
            const textarea = document.getElementById('editNoteContent');
            const start = textarea.selectionStart;
            const end = textarea.selectionEnd;
            const selectedText = textarea.value.substring(start, end);
            
            if (selectedText) {
                // å¤„ç†ä¸åŒçš„è¯­æ³•
                let newText;
                if (syntax === '**') {
                    newText = `**${selectedText}**`;
                } else if (syntax === '*') {
                    newText = `*${selectedText}*`;
                } else if (syntax === '~~') {
                    newText = `~~${selectedText}~~`;
                } else if (syntax === '[é“¾æ¥æ–‡æœ¬](https://)') {
                    newText = `[${selectedText}](https://)`;
                } else if (syntax === '![æ›¿ä»£æ–‡æœ¬](https://)') {
                    newText = `![${selectedText}](https://)`;
                } else {
                    newText = syntax + selectedText;
                }
                
                textarea.value = textarea.value.substring(0, start) + newText + textarea.value.substring(end);
                
                // è®¾ç½®å…‰æ ‡ä½ç½®
                if (syntax === '**' || syntax === '*' || syntax === '~~') {
                    textarea.selectionStart = start + syntax.length;
                    textarea.selectionEnd = end + syntax.length;
                } else if (syntax === '[é“¾æ¥æ–‡æœ¬](https://)') {
                    textarea.selectionStart = start + 1;
                    textarea.selectionEnd = end + 1;
                } else if (syntax === '![æ›¿ä»£æ–‡æœ¬](https://)') {
                    textarea.selectionStart = start + 2;
                    textarea.selectionEnd = end + 2;
                } else {
                    textarea.selectionStart = start + syntax.length;
                    textarea.selectionEnd = start + syntax.length + placeholder.length;
                }
            } else {
                let placeholderText;
                if (syntax === '```javascript\n\n```') {
                    placeholderText = '```javascript\n' + placeholder + '\n```';
                } else if (syntax === '**') {
                    placeholderText = `**${placeholder}**`;
                } else if (syntax === '*') {
                    placeholderText = `*${placeholder}*`;
                } else if (syntax === '~~') {
                    placeholderText = `~~${placeholder}~~`;
                } else if (syntax === '[é“¾æ¥æ–‡æœ¬](https://)') {
                    placeholderText = `[é“¾æ¥æ–‡æœ¬](https://)`;
                } else if (syntax === '![æ›¿ä»£æ–‡æœ¬](https://)') {
                    placeholderText = `![æ›¿ä»£æ–‡æœ¬](https://)`;
                } else {
                    placeholderText = syntax + placeholder;
                }
                
                textarea.value = textarea.value.substring(0, start) + placeholderText + textarea.value.substring(end);
                
                // è®¾ç½®å…‰æ ‡ä½ç½®
                if (syntax === '```javascript\n\n```') {
                    textarea.selectionStart = start + '```javascript\n'.length;
                    textarea.selectionEnd = start + '```javascript\n'.length + placeholder.length;
                } else if (syntax === '**') {
                    textarea.selectionStart = start + 2;
                    textarea.selectionEnd = start + 2 + placeholder.length;
                } else if (syntax === '*') {
                    textarea.selectionStart = start + 1;
                    textarea.selectionEnd = start + 1 + placeholder.length;
                } else if (syntax === '~~') {
                    textarea.selectionStart = start + 2;
                    textarea.selectionEnd = start + 2 + placeholder.length;
                } else if (syntax === '[é“¾æ¥æ–‡æœ¬](https://)') {
                    textarea.selectionStart = start + 1;
                    textarea.selectionEnd = start + 5; // "é“¾æ¥æ–‡æœ¬"çš„é•¿åº¦
                } else if (syntax === '![æ›¿ä»£æ–‡æœ¬](https://)') {
                    textarea.selectionStart = start + 2;
                    textarea.selectionEnd = start + 6; // "æ›¿ä»£æ–‡æœ¬"çš„é•¿åº¦
                } else {
                    textarea.selectionStart = start + syntax.length;
                    textarea.selectionEnd = start + syntax.length + placeholder.length;
                }
            }
            
            textarea.focus();
            updateCharCount();
        }

        function insertImageToMarkdown() {
            // æ‰“å¼€é€‰æ‹©å›¾ç‰‡æ¨¡æ€æ¡†
            showSelectImageModal();
        }

        function updateCharCount() {
            const textarea = document.getElementById('editNoteContent');
            const charCount = document.getElementById('editCharCount');
            if (textarea && charCount) {
                charCount.textContent = textarea.value.length;
            }
        }

        async function doSave(content, id = null) {
            const text = content || document.getElementById('noteInput').value;
            const pw = document.getElementById('mainPw').value;
            
            if (!text || !pw) {
                alert("è¯·å¡«å†™å†…å®¹å’Œå¯†ç ");
                return null;
            }
            
            try {
                const cipher = await encrypt(text, pw);
                
                const body = { content: cipher };
                
                if (id !== null) {
                    body.id = id;
                }
                
                const res = await fetch(`${API_URL}/api/save`, {
                    method: 'POST', 
                    headers: { 
                        'Content-Type': 'application/json', 
                        'Authorization': ADMIN_KEY 
                    },
                    body: JSON.stringify(body)
                });
                
                if (res.ok) { 
                    if (id === null) {
                        alert("âœ… å·²å­˜å…¥å®‰å…¨åº“"); 
                        document.getElementById('noteInput').value = ""; 
                        document.getElementById('noteCharCount').textContent = "0";
                    } else {
                        alert("âœ… ç¬”è®°å·²æ›´æ–°");
                    }
                    loadNotesList();
                    return true;
                } else {
                    alert("âŒ ä¿å­˜å¤±è´¥");
                    return false;
                }
            } catch (e) { 
                alert("âŒ ç½‘ç»œè¿æ¥å¤±è´¥"); 
                return false;
            }
        }

        // ä¿®æ”¹åçš„ toggleNoteContent å‡½æ•°ï¼Œæ”¯æŒé¡¶éƒ¨å’Œåº•éƒ¨æŒ‰é’®åŒæ­¥
        function toggleNoteContent(id) {
            const contentDiv = document.getElementById(`noteContent-${id}`);
            const topToggleBtn = document.getElementById(`topToggle-${id}`);
            const bottomToggleBtn = document.getElementById(`bottomToggle-${id}`);
            const note = notesCache[id];
            
            if (!note) {
                console.error('æœªæ‰¾åˆ°ç¬”è®°ç¼“å­˜:', id);
                return;
            }
            
            const currentContent = contentDiv.innerHTML;
            const showFullText = currentContent.includes('æ˜¾ç¤ºå…¨éƒ¨å†…å®¹');
            
            const isMarkdown = note.clearText.includes('# ') || note.clearText.includes('## ') || 
                               note.clearText.includes('```') || note.clearText.includes('**') ||
                               note.clearText.includes('- ') || note.clearText.includes('> ');
            
            if (showFullText) {
                // æ˜¾ç¤ºå®Œæ•´å†…å®¹ - ä½¿ç”¨ä¸ç¼–è¾‘æ¨¡å¼é¢„è§ˆç›¸åŒçš„æ¸²æŸ“æ–¹å¼
                const renderedContent = isMarkdown ? marked.parse(note.clearText) : 
                                        `<div class="whitespace-pre-wrap">${note.clearText.replace(/\n/g, '<br>')}</div>`;
                contentDiv.innerHTML = renderedContent + 
                    `<div class="text-center mt-4">
                        <button onclick="toggleNoteContent(${id})" 
                                class="toggle-btn expanded flex items-center justify-center gap-1 mx-auto px-4 py-2 text-xs text-blue-400 hover:text-blue-300 hover:bg-blue-900/20 rounded-lg transition"
                                id="bottomToggle-${id}">
                            <i class="fas fa-chevron-up text-[10px]"></i>
                            <span>æ”¶èµ·</span>
                        </button>
                    </div>`;
                
                // æ›´æ–°é¡¶éƒ¨æŒ‰é’®
                if (topToggleBtn) {
                    topToggleBtn.classList.add('expanded');
                    topToggleBtn.innerHTML = `
                        <i class="fas fa-chevron-up text-[10px]"></i>
                        <span>æ”¶èµ·</span>
                    `;
                }
                
                // é«˜äº®ä»£ç å— - ä½¿ç”¨ä¸ç¼–è¾‘æ¨¡å¼é¢„è§ˆç›¸åŒçš„è®¾ç½®
                setTimeout(() => {
                    hljs.highlightAll();
                }, 100);
            } else {
                // æ˜¾ç¤ºé¢„è§ˆå†…å®¹
                let previewContent = note.clearText;
                if (note.clearText.length > 300) {
                    previewContent = note.clearText.substring(0, 300) + '...';
                }
                
                const renderedContent = isMarkdown ? marked.parse(previewContent) : 
                                        `<div class="whitespace-pre-wrap">${previewContent.replace(/\n/g, '<br>')}</div>`;
                contentDiv.innerHTML = renderedContent + 
                    `<div class="text-center mt-4">
                        <button onclick="toggleNoteContent(${id})" 
                                class="toggle-btn flex items-center justify-center gap-1 mx-auto px-4 py-2 text-xs text-blue-400 hover:text-blue-300 hover:bg-blue-900/20 rounded-lg transition"
                                id="bottomToggle-${id}">
                            <i class="fas fa-chevron-down text-[10px]"></i>
                            <span>æ˜¾ç¤ºå…¨éƒ¨å†…å®¹</span>
                        </button>
                    </div>`;
                
                // æ›´æ–°é¡¶éƒ¨æŒ‰é’®
                if (topToggleBtn) {
                    topToggleBtn.classList.remove('expanded');
                    topToggleBtn.innerHTML = `
                        <i class="fas fa-chevron-down text-[10px]"></i>
                        <span>æ˜¾ç¤ºå…¨éƒ¨å†…å®¹</span>
                    `;
                }
            }
        }

        // ==================== ç¼–è¾‘åŠŸèƒ½ ====================
        function openEdit(id, content) {
            currentEditId = id;
            document.getElementById('editNoteId').textContent = `#${id}`;
            
            const textarea = document.getElementById('editNoteContent');
            textarea.value = content;
            
            // åˆå§‹åŒ–å­—ç¬¦è®¡æ•°
            updateCharCount();
            
            // æ·»åŠ è¾“å…¥ç›‘å¬
            textarea.addEventListener('input', updateCharCount);
            
            // æ·»åŠ å®æ—¶é¢„è§ˆç›‘å¬
            textarea.addEventListener('input', function() {
                if (!document.getElementById('previewTab').classList.contains('hidden')) {
                    switchTab('preview');
                }
            });
            
            // é»˜è®¤æ˜¾ç¤ºç¼–è¾‘æ¨¡å¼
            switchTab('edit');
            
            // æ˜¾ç¤ºæ¨¡æ€æ¡†
            document.getElementById('editModal').classList.remove('hidden');
            
            // èšç„¦åˆ°æ–‡æœ¬åŒºåŸŸ
            setTimeout(() => {
                textarea.focus();
            }, 100);
        }
        
        function closeEdit() {
            document.getElementById('editModal').classList.add('hidden');
            currentEditId = null;
        }
        
        async function saveEdit() {
            const newContent = document.getElementById('editNoteContent').value;
            
            if (!newContent.trim()) {
                alert("ç¬”è®°å†…å®¹ä¸èƒ½ä¸ºç©º");
                return;
            }
            
            const success = await doSave(newContent, currentEditId);
            
            if (success) {
                closeEdit();
            }
        }

        // ==================== å›¾ç‰‡ç®¡ç†åŠŸèƒ½ ====================
        function showImageManager() {
            document.getElementById('imageManagerModal').classList.remove('hidden');
            switchImageView('upload');
            resetUploadArea();
        }
        
        function closeImageManager() {
            document.getElementById('imageManagerModal').classList.add('hidden');
            selectedFiles = [];
            uploadQueue = [];
            isUploading = false;
        }
        
        function switchImageView(view) {
            currentImageView = view;
            
            // æ›´æ–°æ ‡ç­¾æŒ‰é’®çŠ¶æ€
            document.getElementById('uploadTabBtn').classList.remove('active');
            document.getElementById('galleryTabBtn').classList.remove('active');
            document.getElementById('recentTabBtn').classList.remove('active');
            
            document.getElementById('uploadView').classList.add('hidden');
            document.getElementById('galleryView').classList.add('hidden');
            document.getElementById('recentView').classList.add('hidden');
            
            if (view === 'upload') {
                document.getElementById('uploadTabBtn').classList.add('active');
                document.getElementById('uploadView').classList.remove('hidden');
                resetUploadArea();
            } else if (view === 'gallery') {
                document.getElementById('galleryTabBtn').classList.add('active');
                document.getElementById('galleryView').classList.remove('hidden');
                loadGalleryImages();
            } else if (view === 'recent') {
                document.getElementById('recentTabBtn').classList.add('active');
                document.getElementById('recentView').classList.remove('hidden');
                loadRecentStats();
            }
        }
        
        function resetUploadArea() {
            const uploadContainer = document.getElementById('imageUploadContainer');
            uploadContainer.classList.remove('dragover');
            document.getElementById('imagePreviews').innerHTML = '';
            document.getElementById('uploadProgress').classList.add('hidden');
            document.getElementById('uploadProgressBar').style.width = '0%';
            document.getElementById('uploadProgressText').textContent = '0%';
            selectedFiles = [];
        }
        
        function handleDragOver(event) {
            event.preventDefault();
            event.stopPropagation();
            const uploadContainer = document.getElementById('imageUploadContainer');
            uploadContainer.classList.add('dragover');
        }
        
        function handleDragLeave(event) {
            event.preventDefault();
            event.stopPropagation();
            const uploadContainer = document.getElementById('imageUploadContainer');
            uploadContainer.classList.remove('dragover');
        }
        
        function handleDrop(event) {
            event.preventDefault();
            event.stopPropagation();
            const uploadContainer = document.getElementById('imageUploadContainer');
            uploadContainer.classList.remove('dragover');
            
            const files = event.dataTransfer.files;
            handleFiles(files);
        }
        
        function handleFileSelect(event) {
            const files = event.target.files;
            handleFiles(files);
        }
        
        function handleFiles(files) {
            const previewsContainer = document.getElementById('imagePreviews');
            const progressContainer = document.getElementById('uploadProgress');
            
            progressContainer.classList.remove('hidden');
            
            for (let i = 0; i < files.length; i++) {
                const file = files[i];
                
                // æ£€æŸ¥æ–‡ä»¶ç±»å‹
                if (!file.type.startsWith('image/')) {
                    alert(`æ–‡ä»¶ "${file.name}" ä¸æ˜¯å›¾ç‰‡æ–‡ä»¶ï¼Œå·²è·³è¿‡`);
                    continue;
                }
                
                // æ£€æŸ¥æ–‡ä»¶å¤§å° (é™åˆ¶ä¸º 10MB)
                if (file.size > 10 * 1024 * 1024) {
                    alert(`æ–‡ä»¶ "${file.name}" è¶…è¿‡ 10MB é™åˆ¶ï¼Œå·²è·³è¿‡`);
                    continue;
                }
                
                selectedFiles.push(file);
                
                // åˆ›å»ºé¢„è§ˆ
                const reader = new FileReader();
                reader.onload = function(e) {
                    const preview = document.createElement('div');
                    preview.className = 'image-preview';
                    preview.innerHTML = `
                        <img src="${e.target.result}" alt="${file.name}">
                        <div class="image-overlay">
                            <div class="image-actions">
                                <button onclick="removePreview(${selectedFiles.length - 1})" class="image-action-btn delete" title="ç§»é™¤">
                                    <i class="fas fa-times"></i>
                                </button>
                            </div>
                        </div>
                        <div class="absolute bottom-0 left-0 right-0 bg-black/70 text-white text-xs p-1 truncate">
                            ${file.name} (${formatFileSize(file.size)})
                        </div>
                    `;
                    previewsContainer.appendChild(preview);
                };
                reader.readAsDataURL(file);
            }
            
            // æ›´æ–°ä¸Šä¼ æŒ‰é’®çŠ¶æ€
            const uploadButton = document.querySelector('#uploadView button[onclick="uploadImages()"]');
            if (uploadButton) {
                uploadButton.disabled = selectedFiles.length === 0;
            }
            
            // æ›´æ–°è¿›åº¦æ˜¾ç¤º
            updateUploadProgress();
        }
        
        function removePreview(index) {
            if (index >= 0 && index < selectedFiles.length) {
                selectedFiles.splice(index, 1);
                
                // é‡æ–°æ¸²æŸ“é¢„è§ˆ
                const previewsContainer = document.getElementById('imagePreviews');
                previewsContainer.innerHTML = '';
                
                selectedFiles.forEach((file, i) => {
                    const reader = new FileReader();
                    reader.onload = function(e) {
                        const preview = document.createElement('div');
                        preview.className = 'image-preview';
                        preview.innerHTML = `
                            <img src="${e.target.result}" alt="${file.name}">
                            <div class="image-overlay">
                                <div class="image-actions">
                                    <button onclick="removePreview(${i})" class="image-action-btn delete" title="ç§»é™¤">
                                        <i class="fas fa-times"></i>
                                    </button>
                                </div>
                            </div>
                            <div class="absolute bottom-0 left-0 right-0 bg-black/70 text-white text-xs p-1 truncate">
                                ${file.name} (${formatFileSize(file.size)})
                            </div>
                        `;
                        previewsContainer.appendChild(preview);
                    };
                    reader.readAsDataURL(file);
                });
                
                updateUploadProgress();
            }
        }
        
        function updateUploadProgress() {
            const totalSize = selectedFiles.reduce((sum, file) => sum + file.size, 0);
            const progressText = `${selectedFiles.length} ä¸ªæ–‡ä»¶ï¼Œå…± ${formatFileSize(totalSize)}`;
            document.getElementById('uploadProgressText').textContent = progressText;
            
            const uploadButton = document.querySelector('#uploadView button[onclick="uploadImages()"]');
            if (uploadButton) {
                uploadButton.disabled = selectedFiles.length === 0;
                uploadButton.textContent = selectedFiles.length > 0 ? 
                    `ä¸Šä¼  ${selectedFiles.length} ä¸ªæ–‡ä»¶` : 'å¼€å§‹ä¸Šä¼ ';
            }
        }
        
        async function uploadImages() {
            if (selectedFiles.length === 0) {
                alert('è¯·é€‰æ‹©è¦ä¸Šä¼ çš„å›¾ç‰‡');
                return;
            }
            
            if (isUploading) {
                alert('æ­£åœ¨ä¸Šä¼ ä¸­ï¼Œè¯·ç¨å€™...');
                return;
            }
            
            isUploading = true;
            const progressBar = document.getElementById('uploadProgressBar');
            const progressText = document.getElementById('uploadProgressText');
            const uploadButton = document.querySelector('#uploadView button[onclick="uploadImages()"]');
            
            if (uploadButton) {
                uploadButton.disabled = true;
                uploadButton.innerHTML = '<i class="fas fa-spinner fa-spin"></i> ä¸Šä¼ ä¸­...';
            }
            
            let uploadedCount = 0;
            let failedFiles = [];
            
            for (let i = 0; i < selectedFiles.length; i++) {
                const file = selectedFiles[i];
                
                try {
                    const formData = new FormData();
                    formData.append('image', file);
                    formData.append('filename', file.name);
                    formData.append('size', file.size);
                    formData.append('type', file.type);
                    
                    const response = await fetch(`${API_URL}/api/images/upload`, {
                        method: 'POST',
                        headers: {
                            'Authorization': ADMIN_KEY
                        },
                        body: formData
                    });
                    
                    if (response.ok) {
                        uploadedCount++;
                        const progress = Math.round((uploadedCount / selectedFiles.length) * 100);
                        progressBar.style.width = `${progress}%`;
                        progressText.textContent = `ä¸Šä¼ ä¸­: ${uploadedCount}/${selectedFiles.length} (${progress}%)`;
                    } else {
                        failedFiles.push(file.name);
                        console.error(`ä¸Šä¼ å¤±è´¥: ${file.name}`, await response.text());
                    }
                } catch (error) {
                    console.error(`ä¸Šä¼ å¤±è´¥: ${file.name}`, error);
                    failedFiles.push(file.name);
                }
            }
            
            // ä¸Šä¼ å®Œæˆ
            isUploading = false;
            progressBar.style.width = '100%';
            
            if (uploadButton) {
                uploadButton.disabled = false;
                uploadButton.innerHTML = 'å¼€å§‹ä¸Šä¼ ';
            }
            
            if (failedFiles.length === 0) {
                progressText.textContent = `âœ… ä¸Šä¼ å®Œæˆ: ${uploadedCount} ä¸ªæ–‡ä»¶`;
                showToast(`æˆåŠŸä¸Šä¼  ${uploadedCount} å¼ å›¾ç‰‡`, 'success');
                
                // æ¸…ç©ºå·²ä¸Šä¼ çš„æ–‡ä»¶
                selectedFiles = [];
                document.getElementById('imagePreviews').innerHTML = '';
                
                // åˆ‡æ¢åˆ°å›¾ç‰‡åº“è§†å›¾
                setTimeout(() => {
                    switchImageView('gallery');
                }, 1500);
            } else {
                progressText.textContent = `âš ï¸ ä¸Šä¼ å®Œæˆ: ${uploadedCount} æˆåŠŸ, ${failedFiles.length} å¤±è´¥`;
                showToast(`ä¸Šä¼ å®Œæˆ: ${uploadedCount} æˆåŠŸ, ${failedFiles.length} å¤±è´¥`, 'error');
                
                if (uploadedCount > 0) {
                    // åˆ‡æ¢åˆ°å›¾ç‰‡åº“è§†å›¾
                    setTimeout(() => {
                        switchImageView('gallery');
                    }, 1500);
                }
            }
            
            // åˆ·æ–°å›¾ç‰‡ç»Ÿè®¡
            loadImageStats();
        }
        
        async function loadGalleryImages() {
            const galleryGrid = document.getElementById('imageGallery');
            const loadingDiv = document.getElementById('galleryLoading');
            const noImagesDiv = document.getElementById('noImagesMessage');
            const sortSelect = document.getElementById('imageSort');
            
            loadingDiv.classList.remove('hidden');
            galleryGrid.innerHTML = '';
            noImagesDiv.classList.add('hidden');
            
            try {
                const sort = sortSelect ? sortSelect.value : 'newest';
                const response = await fetch(`${API_URL}/api/images/list?sort=${sort}`, {
                    headers: { 'Authorization': ADMIN_KEY }
                });
                
                if (!response.ok) {
                    throw new Error('è·å–å›¾ç‰‡åˆ—è¡¨å¤±è´¥');
                }
                
                const images = await response.json();
                imagesCache = {};
                
                if (images.length === 0) {
                    loadingDiv.classList.add('hidden');
                    noImagesDiv.classList.remove('hidden');
                    updateImageStats(images);
                    return;
                }
                
                images.forEach(image => {
                    imagesCache[image.id] = image;
                    
                    const imageCard = document.createElement('div');
                    imageCard.className = 'image-preview cursor-pointer';
                    imageCard.onclick = () => showImageDetail(image.id);
                    
                    // ç”Ÿæˆç¼©ç•¥å›¾URL
                    const imageUrl = `${API_URL}/api/images/${image.id}?thumb=true`;
                    
                    imageCard.innerHTML = `
                        <img src="${imageUrl}" alt="${image.filename}" loading="lazy">
                        <div class="image-overlay">
                            <div class="image-actions">
                                <button onclick="event.stopPropagation(); copyImageLink(${image.id})" class="image-action-btn copy" title="å¤åˆ¶é“¾æ¥">
                                    <i class="fas fa-copy"></i>
                                </button>
                                <button onclick="event.stopPropagation(); deleteImage(${image.id})" class="image-action-btn delete" title="åˆ é™¤">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                        </div>
                        <div class="absolute bottom-0 left-0 right-0 bg-black/70 text-white text-xs p-1 truncate">
                            ${image.filename}
                        </div>
                    `;
                    
                    galleryGrid.appendChild(imageCard);
                });
                
                loadingDiv.classList.add('hidden');
                updateImageStats(images);
                
            } catch (error) {
                console.error('åŠ è½½å›¾ç‰‡åº“å¤±è´¥:', error);
                loadingDiv.classList.add('hidden');
                galleryGrid.innerHTML = `
                    <div class="col-span-full text-center py-12 text-slate-600 italic text-sm">
                        åŠ è½½å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥
                    </div>
                `;
            }
        }
        
        async function loadRecentStats() {
            const statsDiv = document.getElementById('recentStats');
            const recentGrid = document.getElementById('recentImagesGrid');
            
            statsDiv.innerHTML = '<div class="text-center py-8"><div class="loader mx-auto"></div><p class="text-slate-400 mt-4">åŠ è½½ç»Ÿè®¡æ•°æ®ä¸­...</p></div>';
            recentGrid.innerHTML = '';
            
            try {
                const response = await fetch(`${API_URL}/api/images/stats`, {
                    headers: { 'Authorization': ADMIN_KEY }
                });
                
                if (!response.ok) {
                    throw new Error('è·å–ç»Ÿè®¡ä¿¡æ¯å¤±è´¥');
                }
                
                const stats = await response.json();
                
                // æ˜¾ç¤ºç»Ÿè®¡æ•°æ®
                statsDiv.innerHTML = `
                    <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                        <div class="glass p-4 rounded-xl text-center">
                            <div class="text-2xl text-emerald-400">${stats.total_images}</div>
                            <div class="text-xs text-slate-400 mt-1">æ€»å›¾ç‰‡æ•°</div>
                        </div>
                        <div class="glass p-4 rounded-xl text-center">
                            <div class="text-2xl text-blue-400">${formatFileSize(stats.total_size)}</div>
                            <div class="text-xs text-slate-400 mt-1">æ€»å­˜å‚¨ç©ºé—´</div>
                        </div>
                        <div class="glass p-4 rounded-xl text-center">
                            <div class="text-2xl text-purple-400">${stats.today_uploads}</div>
                            <div class="text-xs text-slate-400 mt-1">ä»Šæ—¥ä¸Šä¼ </div>
                        </div>
                        <div class="glass p-4 rounded-xl text-center">
                            <div class="text-2xl text-yellow-400">${stats.last_30_days}</div>
                            <div class="text-xs text-slate-400 mt-1">è¿‘30å¤©</div>
                        </div>
                    </div>
                `;
                
                // æ˜¾ç¤ºæœ€è¿‘ä¸Šä¼ çš„å›¾ç‰‡
                if (stats.recent_images && stats.recent_images.length > 0) {
                    stats.recent_images.forEach(image => {
                        const imageCard = document.createElement('div');
                        imageCard.className = 'image-preview cursor-pointer';
                        imageCard.onclick = () => showImageDetail(image.id);
                        
                        const imageUrl = `${API_URL}/api/images/${image.id}?thumb=true`;
                        
                        imageCard.innerHTML = `
                            <img src="${imageUrl}" alt="${image.filename}" loading="lazy">
                            <div class="absolute bottom-0 left-0 right-0 bg-black/70 text-white text-xs p-1 truncate">
                                ${new Date(image.uploaded_at).toLocaleDateString()}
                            </div>
                        `;
                        
                        recentGrid.appendChild(imageCard);
                    });
                } else {
                    recentGrid.innerHTML = `
                        <div class="col-span-full text-center py-12 text-slate-600 italic text-sm">
                            æš‚æ— æœ€è¿‘ä¸Šä¼ çš„å›¾ç‰‡
                        </div>
                    `;
                }
                
            } catch (error) {
                console.error('åŠ è½½ç»Ÿè®¡æ•°æ®å¤±è´¥:', error);
                statsDiv.innerHTML = `
                    <div class="text-center py-8 text-slate-600 italic text-sm">
                        åŠ è½½ç»Ÿè®¡ä¿¡æ¯å¤±è´¥
                    </div>
                `;
            }
        }
        
        function searchImages() {
            const searchTerm = document.getElementById('imageSearch').value.toLowerCase();
            const galleryGrid = document.getElementById('imageGallery');
            const images = galleryGrid.querySelectorAll('.image-preview');
            
            images.forEach(imageCard => {
                const filename = imageCard.querySelector('img').alt.toLowerCase();
                if (filename.includes(searchTerm)) {
                    imageCard.style.display = 'block';
                } else {
                    imageCard.style.display = 'none';
                }
            });
        }
        
        function showImageDetail(imageId) {
            const image = imagesCache[imageId];
            if (!image) {
                alert('å›¾ç‰‡ä¿¡æ¯åŠ è½½å¤±è´¥');
                return;
            }
            
            currentImageId = imageId;
            document.getElementById('detailImageName').textContent = image.filename;
            document.getElementById('detailName').textContent = image.filename;
            document.getElementById('detailSize').textContent = formatFileSize(image.size);
            document.getElementById('detailDimensions').textContent = image.width ? `${image.width} Ã— ${image.height}` : 'æœªçŸ¥';
            document.getElementById('detailUploadTime').textContent = new Date(image.uploaded_at).toLocaleString();
            document.getElementById('detailMimeType').textContent = image.mime_type;
            document.getElementById('detailImageId').textContent = image.id;
            
            const imageUrl = `${API_URL}/api/images/${image.id}`;
            const markdownLink = `![${image.filename}](${imageUrl})`;
            const directLink = imageUrl;
            
            document.getElementById('detailMarkdownLink').value = markdownLink;
            document.getElementById('detailDirectLink').value = directLink;
            
            const imageContainer = document.getElementById('detailImageContainer');
            imageContainer.innerHTML = `<img src="${imageUrl}" alt="${image.filename}" class="mx-auto">`;
            
            document.getElementById('imageDetailModal').classList.remove('hidden');
        }
        
        function closeImageDetail() {
            document.getElementById('imageDetailModal').classList.add('hidden');
            currentImageId = null;
        }
        
        function copyMarkdownLink() {
            const markdownLink = document.getElementById('detailMarkdownLink').value;
            copyToClipboard(markdownLink);
            showToast('Markdowné“¾æ¥å·²å¤åˆ¶', 'success');
        }
        
        function copyDirectLink() {
            const directLink = document.getElementById('detailDirectLink').value;
            copyToClipboard(directLink);
            showToast('ç›´æ¥é“¾æ¥å·²å¤åˆ¶', 'success');
        }
        
        async function copyImageLink(imageId) {
            const image = imagesCache[imageId];
            if (!image) return;
            
            const imageUrl = `${API_URL}/api/images/${image.id}`;
            const markdownLink = `![${image.filename}](${imageUrl})`;
            
            copyToClipboard(markdownLink);
            showToast('å›¾ç‰‡é“¾æ¥å·²å¤åˆ¶åˆ°å‰ªè´´æ¿', 'success');
        }
        
        function confirmDeleteImage() {
            if (confirm('ç¡®å®šè¦åˆ é™¤è¿™å¼ å›¾ç‰‡å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ’¤é”€ã€‚')) {
                deleteImage(currentImageId);
            }
        }
        
        async function deleteImage(imageId) {
            if (!confirm('ç¡®å®šè¦åˆ é™¤è¿™å¼ å›¾ç‰‡å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ’¤é”€ã€‚')) {
                return;
            }
            
            try {
                const response = await fetch(`${API_URL}/api/images/delete`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': ADMIN_KEY
                    },
                    body: JSON.stringify({ id: imageId })
                });
                
                if (response.ok) {
                    showToast('å›¾ç‰‡å·²åˆ é™¤', 'success');
                    
                    // å…³é—­è¯¦æƒ…æ¨¡æ€æ¡†
                    closeImageDetail();
                    
                    // åˆ·æ–°å›¾ç‰‡åº“
                    if (currentImageView === 'gallery') {
                        loadGalleryImages();
                    }
                    
                    // åˆ·æ–°ç»Ÿè®¡æ•°æ®
                    loadImageStats();
                    
                } else {
                    throw new Error('åˆ é™¤å¤±è´¥');
                }
            } catch (error) {
                console.error('åˆ é™¤å›¾ç‰‡å¤±è´¥:', error);
                showToast('åˆ é™¤å¤±è´¥', 'error');
            }
        }
        
        function updateImageStats(images) {
            const totalImages = images.length;
            const totalSize = images.reduce((sum, image) => sum + (image.size || 0), 0);
            const statsText = `${totalImages} å¼ å›¾ç‰‡ï¼Œå…± ${formatFileSize(totalSize)}`;
            document.getElementById('imageStats').textContent = statsText;
        }
        
        async function loadImageStats() {
            if (currentView !== 'images') return;
            
            try {
                const response = await fetch(`${API_URL}/api/images/stats`, {
                    headers: { 'Authorization': ADMIN_KEY }
                });
                
                if (!response.ok) {
                    throw new Error('è·å–å›¾ç‰‡ç»Ÿè®¡å¤±è´¥');
                }
                
                const stats = await response.json();
                
                const summaryText = `${stats.total_images} å¼ å›¾ç‰‡ï¼Œ${formatFileSize(stats.total_size)}ï¼Œä»Šæ—¥ä¸Šä¼  ${stats.today_uploads} å¼ `;
                document.getElementById('imagesSummary').textContent = summaryText;
                
                // å¦‚æœå½“å‰åœ¨å›¾ç‰‡è§†å›¾ï¼Œæ˜¾ç¤ºå›¾ç‰‡ç½‘æ ¼
                const imagesContent = document.getElementById('imagesContent');
                if (imagesContent && stats.total_images > 0) {
                    // åŠ è½½æœ€æ–°çš„å›¾ç‰‡æ˜¾ç¤º
                    const imagesResponse = await fetch(`${API_URL}/api/images/list?sort=newest&limit=12`, {
                        headers: { 'Authorization': ADMIN_KEY }
                    });
                    
                    if (imagesResponse.ok) {
                        const recentImages = await imagesResponse.json();
                        
                        let html = `
                            <div class="space-y-4">
                                <h3 class="text-lg font-bold text-slate-300">æœ€æ–°å›¾ç‰‡</h3>
                                <div class="image-grid-view">
                        `;
                        
                        recentImages.forEach(image => {
                            const imageUrl = `${API_URL}/api/images/${image.id}?thumb=true`;
                            html += `
                                <div class="image-preview cursor-pointer" onclick="showImageDetail(${image.id})">
                                    <img src="${imageUrl}" alt="${image.filename}" loading="lazy">
                                    <div class="absolute bottom-0 left-0 right-0 bg-black/70 text-white text-xs p-1 truncate">
                                        ${image.filename}
                                    </div>
                                </div>
                            `;
                        });
                        
                        html += `
                                </div>
                                <div class="text-center pt-4">
                                    <button onclick="showImageManager()" class="text-emerald-400 hover:text-emerald-300 transition font-semibold">
                                        <i class="fas fa-images"></i> æŸ¥çœ‹å…¨éƒ¨å›¾ç‰‡
                                    </button>
                                </div>
                            </div>
                        `;
                        
                        imagesContent.innerHTML = html;
                    }
                }
                
            } catch (error) {
                console.error('åŠ è½½å›¾ç‰‡ç»Ÿè®¡å¤±è´¥:', error);
                document.getElementById('imagesSummary').textContent = 'åŠ è½½å¤±è´¥';
            }
        }
        
        async function exportImageList() {
            try {
                const response = await fetch(`${API_URL}/api/images/list?sort=newest`, {
                    headers: { 'Authorization': ADMIN_KEY }
                });
                
                if (!response.ok) {
                    throw new Error('è·å–å›¾ç‰‡åˆ—è¡¨å¤±è´¥');
                }
                
                const images = await response.json();
                
                const exportData = {
                    export_date: new Date().toISOString(),
                    total_images: images.length,
                    total_size: images.reduce((sum, image) => sum + (image.size || 0), 0),
                    images: images.map(image => ({
                        id: image.id,
                        filename: image.filename,
                        size: image.size,
                        mime_type: image.mime_type,
                        uploaded_at: image.uploaded_at,
                        url: `${API_URL}/api/images/${image.id}`
                    }))
                };
                
                const blob = new Blob([JSON.stringify(exportData, null, 2)], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `CloudNotes_Images_Export_${new Date().toISOString().split('T')[0]}.json`;
                a.click();
                URL.revokeObjectURL(url);
                
                showToast('å›¾ç‰‡åˆ—è¡¨å·²å¯¼å‡º', 'success');
                
            } catch (error) {
                console.error('å¯¼å‡ºå›¾ç‰‡åˆ—è¡¨å¤±è´¥:', error);
                showToast('å¯¼å‡ºå¤±è´¥', 'error');
            }
        }
        
        // ==================== é€‰æ‹©å›¾ç‰‡åŠŸèƒ½ ====================
        function showSelectImageModal() {
            document.getElementById('selectImageModal').classList.remove('hidden');
            refreshSelectImages();
        }
        
        function closeSelectImageModal() {
            document.getElementById('selectImageModal').classList.add('hidden');
            selectImagesCache = {};
        }
        
        async function refreshSelectImages() {
            const selectGrid = document.getElementById('selectImageGrid');
            const loadingDiv = document.getElementById('selectImageLoading');
            const noImagesDiv = document.getElementById('noSelectImagesMessage');
            
            loadingDiv.classList.remove('hidden');
            selectGrid.innerHTML = '';
            noImagesDiv.classList.add('hidden');
            
            try {
                const response = await fetch(`${API_URL}/api/images/list?sort=newest&limit=50`, {
                    headers: { 'Authorization': ADMIN_KEY }
                });
                
                if (!response.ok) {
                    throw new Error('è·å–å›¾ç‰‡åˆ—è¡¨å¤±è´¥');
                }
                
                const images = await response.json();
                selectImagesCache = {};
                
                if (images.length === 0) {
                    loadingDiv.classList.add('hidden');
                    noImagesDiv.classList.remove('hidden');
                    return;
                }
                
                images.forEach(image => {
                    selectImagesCache[image.id] = image;
                    
                    const imageCard = document.createElement('div');
                    imageCard.className = 'image-preview cursor-pointer';
                    imageCard.onclick = () => selectImageForInsert(image.id);
                    
                    const imageUrl = `${API_URL}/api/images/${image.id}?thumb=true`;
                    
                    imageCard.innerHTML = `
                        <img src="${imageUrl}" alt="${image.filename}" loading="lazy">
                        <div class="absolute bottom-0 left-0 right-0 bg-black/70 text-white text-xs p-1 truncate">
                            ${image.filename}
                        </div>
                    `;
                    
                    selectGrid.appendChild(imageCard);
                });
                
                loadingDiv.classList.add('hidden');
                
            } catch (error) {
                console.error('åŠ è½½é€‰æ‹©å›¾ç‰‡å¤±è´¥:', error);
                loadingDiv.classList.add('hidden');
                selectGrid.innerHTML = `
                    <div class="col-span-full text-center py-12 text-slate-600 italic text-sm">
                        åŠ è½½å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥
                    </div>
                `;
            }
        }
        
        function searchSelectImages() {
            const searchTerm = document.getElementById('selectImageSearch').value.toLowerCase();
            const selectGrid = document.getElementById('selectImageGrid');
            const images = selectGrid.querySelectorAll('.image-preview');
            
            images.forEach(imageCard => {
                const filename = imageCard.querySelector('img').alt.toLowerCase();
                if (filename.includes(searchTerm)) {
                    imageCard.style.display = 'block';
                } else {
                    imageCard.style.display = 'none';
                }
            });
        }
        
        function selectImageForInsert(imageId) {
            const image = selectImagesCache[imageId];
            if (!image) {
                showToast('å›¾ç‰‡ä¿¡æ¯åŠ è½½å¤±è´¥', 'error');
                return;
            }
            
            const imageUrl = `${API_URL}/api/images/${image.id}`;
            const markdownImage = `![${image.filename}](${imageUrl})`;
            
            const textarea = document.getElementById('editNoteContent');
            if (textarea) {
                const start = textarea.selectionStart;
                const end = textarea.selectionEnd;
                
                textarea.value = textarea.value.substring(0, start) + markdownImage + textarea.value.substring(end);
                textarea.focus();
                textarea.selectionStart = start + markdownImage.length;
                textarea.selectionEnd = start + markdownImage.length;
                
                updateCharCount();
                
                // å¦‚æœå½“å‰åœ¨é¢„è§ˆæ¨¡å¼ï¼Œæ›´æ–°é¢„è§ˆ
                if (!document.getElementById('previewTab').classList.contains('hidden')) {
                    switchTab('preview');
                }
            }
            
            closeSelectImageModal();
            showToast('å›¾ç‰‡å·²æ’å…¥åˆ°ç¼–è¾‘å™¨ä¸­', 'success');
        }

        // ==================== è¾…åŠ©å‡½æ•° ====================
        function formatFileSize(bytes) {
            if (bytes === 0) return '0 B';
            const k = 1024;
            const sizes = ['B', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
        }
        
        function copyToClipboard(text) {
            navigator.clipboard.writeText(text).catch(() => {
                // é™çº§æ–¹æ¡ˆ
                const textarea = document.createElement('textarea');
                textarea.value = text;
                document.body.appendChild(textarea);
                textarea.select();
                document.execCommand('copy');
                document.body.removeChild(textarea);
            });
        }
        
        // ==================== åˆ†äº«åŠŸèƒ½ï¼ˆè‡ªåŠ¨å¤åˆ¶ï¼‰ ====================
        async function doShareCopy(event, cipher) {
            const pid = Math.random().toString(36).substring(2, 12);
            
            // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
            const button = event.target.closest('button');
            const originalText = button.innerHTML;
            button.innerHTML = '<i class="fas fa-spinner fa-spin"></i> ç”Ÿæˆä¸­...';
            button.disabled = true;
            
            try {
                await fetch(`${API_URL}/api/save`, {
                    method: 'POST', 
                    headers: { 
                        'Content-Type': 'application/json', 
                        'Authorization': ADMIN_KEY 
                    },
                    body: JSON.stringify({ 
                        content: cipher, 
                        public_id: pid, 
                        is_share: 1 
                    })
                });
                
                const fullUrl = `${window.location.origin}${window.location.pathname}?share=${pid}&cfg=${btoa(API_URL)}`;
                
                // ä½¿ç”¨ç°ä»£ Clipboard API å¤åˆ¶åˆ°å‰ªè´´æ¿
                try {
                    await navigator.clipboard.writeText(fullUrl);
                    
                    // æ˜¾ç¤ºå¤åˆ¶æˆåŠŸçš„è§†è§‰åé¦ˆ
                    button.innerHTML = '<i class="fas fa-check"></i> å·²å¤åˆ¶';
                    button.style.background = 'linear-gradient(135deg, #10b981, #059669)';
                    button.style.color = 'white';
                    
                    // 3ç§’åæ¢å¤åŸçŠ¶
                    setTimeout(() => {
                        button.innerHTML = originalText;
                        button.disabled = false;
                        button.style.background = '';
                        button.style.color = '';
                    }, 3000);
                    
                    // æ˜¾ç¤º Toast é€šçŸ¥
                    showToast('é“¾æ¥å·²å¤åˆ¶åˆ°å‰ªè´´æ¿ï¼', 'success');
                    
                } catch (clipboardError) {
                    console.error('Clipboard API å¤±è´¥:', clipboardError);
                    
                    // é™çº§æ–¹æ¡ˆï¼šä½¿ç”¨ document.execCommand
                    const textarea = document.createElement('textarea');
                    textarea.value = fullUrl;
                    document.body.appendChild(textarea);
                    textarea.select();
                    
                    try {
                        const success = document.execCommand('copy');
                        if (success) {
                            // æ˜¾ç¤ºå¤åˆ¶æˆåŠŸçš„è§†è§‰åé¦ˆ
                            button.innerHTML = '<i class="fas fa-check"></i> å·²å¤åˆ¶';
                            button.style.background = 'linear-gradient(135deg, #10b981, #059669)';
                            button.style.color = 'white';
                            
                            setTimeout(() => {
                                button.innerHTML = originalText;
                                button.disabled = false;
                                button.style.background = '';
                                button.style.color = '';
                            }, 3000);
                            
                            showToast('é“¾æ¥å·²å¤åˆ¶åˆ°å‰ªè´´æ¿ï¼', 'success');
                        } else {
                            // å¦‚æœ execCommand ä¹Ÿå¤±è´¥ï¼Œå›é€€åˆ° prompt
                            prompt("âœ… é˜…åå³ç„šåŠ å¯†é“¾æ¥å·²ç”Ÿæˆï¼ˆè¯·æ‰‹åŠ¨å¤åˆ¶ï¼‰ï¼š", fullUrl);
                            button.innerHTML = originalText;
                            button.disabled = false;
                        }
                    } catch (execError) {
                        console.error('execCommand å¤±è´¥:', execError);
                        prompt("âœ… é˜…åå³ç„šåŠ å¯†é“¾æ¥å·²ç”Ÿæˆï¼ˆè¯·æ‰‹åŠ¨å¤åˆ¶ï¼‰ï¼š", fullUrl);
                        button.innerHTML = originalText;
                        button.disabled = false;
                    } finally {
                        document.body.removeChild(textarea);
                    }
                }
            } catch (e) { 
                console.error('ç”Ÿæˆåˆ†äº«é“¾æ¥å¤±è´¥:', e);
                
                // æ˜¾ç¤ºé”™è¯¯åé¦ˆ
                button.innerHTML = '<i class="fas fa-exclamation-triangle"></i> å¤±è´¥';
                button.style.background = 'linear-gradient(135deg, #ef4444, #dc2626)';
                button.style.color = 'white';
                
                setTimeout(() => {
                    button.innerHTML = originalText;
                    button.disabled = false;
                    button.style.background = '';
                    button.style.color = '';
                }, 3000);
                
                showToast('åˆ†äº«å¤±è´¥ï¼Œè¯·é‡è¯•', 'error');
            }
        }

        // ==================== Toast é€šçŸ¥å‡½æ•° ====================
        function showToast(message, type = 'info') {
            // ç§»é™¤ç°æœ‰çš„ toast
            const existingToast = document.getElementById('customToast');
            if (existingToast) {
                existingToast.remove();
            }
            
            // åˆ›å»ºæ–°çš„ toast
            const toast = document.createElement('div');
            toast.id = 'customToast';
            toast.className = 'toast ' + type;
            toast.innerHTML = `
                <i class="fas ${type === 'success' ? 'fa-check-circle' : type === 'error' ? 'fa-exclamation-circle' : 'fa-info-circle'}"></i>
                <span>${message}</span>
            `;
            
            document.getElementById('toastContainer').appendChild(toast);
            
            // æ˜¾ç¤ºåŠ¨ç”»
            setTimeout(() => {
                toast.classList.add('show');
            }, 10);
            
            // 3ç§’åè‡ªåŠ¨æ¶ˆå¤±
            setTimeout(() => {
                toast.classList.remove('show');
                setTimeout(() => {
                    if (toast.parentNode) {
                        toast.parentNode.removeChild(toast);
                    }
                }, 300);
            }, 3000);
            
            // ç‚¹å‡»å…³é—­
            toast.addEventListener('click', () => {
                toast.classList.remove('show');
                setTimeout(() => {
                    if (toast.parentNode) {
                        toast.parentNode.removeChild(toast);
                    }
                }, 300);
            });
        }

        function doExport(text, id) {
            const date = new Date().toISOString().split('T')[0];
            const blob = new Blob([text], { type: 'text/plain;charset=utf-8' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a'); 
            a.href = url; 
            a.download = `CloudNote_${id}_${date}.md`; 
            a.click();
        }

        async function doDelete(id) {
            if (!confirm("ç¡®å®šè¦ç‰©ç†æŠ¹é™¤è¿™æ¡è®°å½•å—ï¼Ÿ")) return;
            await fetch(`${API_URL}/api/delete`, {
                method: 'POST', headers: { 'Content-Type': 'application/json', 'Authorization': ADMIN_KEY },
                body: JSON.stringify({ id: id })
            });
            loadNotesList();
        }

        async function doAI() {
            const text = document.getElementById('noteInput').value; 
            if (!text) return alert("ç¬”è®°ä¸ºç©º");
            const btn = event.target; 
            btn.innerText = "æ€è€ƒä¸­..."; 
            btn.disabled = true;
            try {
                const res = await fetch(`${API_URL}/api/ai-sum`, {
                    method: 'POST', headers: { 'Content-Type': 'application/json', 'Authorization': ADMIN_KEY },
                    body: JSON.stringify({ text: text.substring(0, 1000) })
                });
                const data = await res.json();
                document.getElementById('noteInput').value += `\n\n--- âœ¨ AI æ€»ç»“ ---\n\n${data.summary}`;
                document.getElementById('noteCharCount').textContent = document.getElementById('noteInput').value.length;
            } finally { 
                btn.innerText = "âœ¨ AI æ™ºèƒ½æ€»ç»“"; 
                btn.disabled = false; 
            }
        }

        // ==================== é˜…åå³ç„šåŠŸèƒ½ ====================
        async function doUnlockShare() {
            const pw = document.getElementById('sharePw').value; 
            const resDiv = document.getElementById('shareResult');
            const unlockBtn = document.getElementById('unlockBtn');
            const burnTimerDiv = document.getElementById('burnTimer');
            const charsBurnedSpan = document.getElementById('charsBurned');
            const totalCharsSpan = document.getElementById('totalChars');
            const burnPercentageSpan = document.getElementById('burnPercentage');
            const burnProgressBar = document.getElementById('burnProgressBar');
            const burnNowBtn = document.getElementById('burnNowBtn');
            const burnSpeedSpan = document.getElementById('burnSpeed');
            
            if (!pw) {
                alert("è¯·è¾“å…¥è§£å¯†å¯†ç ");
                return;
            }
            
            try {
                unlockBtn.innerText = "è§£å¯†ä¸­...";
                unlockBtn.disabled = true;
                
                const res = await fetch(`${API_URL}/api/share/${shareId}`);
                if (!res.ok) {
                    alert("é“¾æ¥å·²å¤±æ•ˆæˆ–å†…å®¹å·²è¢«ç„šæ¯");
                    return;
                }
                
                const data = await res.json(); 
                const clearText = await decrypt(data.content, pw);
                
                if (clearText) { 
                    // å­˜å‚¨åŸå§‹å†…å®¹
                    originalContent = clearText;
                    
                    // æ¸²æŸ“Markdownå†…å®¹ - ä½¿ç”¨ä¸ç¼–è¾‘æ¨¡å¼é¢„è§ˆç›¸åŒçš„æ¸²æŸ“æ–¹å¼
                    const burningContentDiv = document.getElementById('burningContent');
                    burningContentDiv.innerHTML = marked.parse(clearText);
                    
                    // é«˜äº®ä»£ç å— - ä½¿ç”¨ä¸ç¼–è¾‘æ¨¡å¼é¢„è§ˆç›¸åŒçš„è®¾ç½®
                    hljs.highlightAll();
                    
                    // æ˜¾ç¤ºç»“æœå®¹å™¨
                    resDiv.classList.remove('hidden'); 
                    
                    // æ›´æ–°æŒ‰é’®çŠ¶æ€
                    unlockBtn.innerText = "æ•°æ®å·²è§£å¯†";
                    unlockBtn.classList.remove('share-gradient');
                    unlockBtn.classList.add('bg-gray-600', 'cursor-not-allowed');
                    
                    // å‡†å¤‡ç„šæ¯åŠ¨ç”»ï¼ˆé¡ºåºç„šæ¯ï¼‰
                    prepareSequentialBurnAnimation();
                    
                    // æ›´æ–°å­—ç¬¦ç»Ÿè®¡
                    totalChars = burningChars.length;
                    charsBurnedSpan.textContent = "0";
                    totalCharsSpan.textContent = totalChars;
                    burnPercentageSpan.textContent = "0%";
                    burnProgressBar.style.width = "0%";
                    burnSpeedSpan.textContent = "é€Ÿåº¦: ä¸­";
                    
                    // é‡ç½®ç„šæ¯çŠ¶æ€
                    isBurningActive = false;
                    burnTimeLeft = 10;
                    currentCharIndex = 0;
                    
                    // å¯åŠ¨å€’è®¡æ—¶
                    burnTimerDiv.classList.remove('hidden');
                    startBurnCountdown();
                    
                    // é‡æ–°å¯ç”¨ç„šæ¯æŒ‰é’®
                    burnNowBtn.disabled = false;
                    burnNowBtn.innerHTML = `<i class="fas fa-fire"></i><span>ç«‹å³ç„šæ¯</span>`;
                    
                } else {
                    alert("å¯†ç é”™è¯¯");
                    unlockBtn.innerText = "è§£å¯†å¹¶é”€æ¯";
                    unlockBtn.disabled = false;
                }
            } catch (e) { 
                console.error("è§£å¯†å¤±è´¥:", e);
                alert("ç½‘ç»œå¼‚å¸¸æˆ–è§£å¯†å¤±è´¥");
                unlockBtn.innerText = "è§£å¯†å¹¶é”€æ¯";
                unlockBtn.disabled = false;
            }
        }

        // å‡†å¤‡é¡ºåºç„šæ¯åŠ¨ç”»
        function prepareSequentialBurnAnimation() {
            const contentDiv = document.getElementById('burningContent');
            const textNodes = [];
            
            // æ¸…ç©ºä¹‹å‰çš„ç„šæ¯å­—ç¬¦
            burningChars = [];
            
            // è·å–æ‰€æœ‰æ–‡æœ¬èŠ‚ç‚¹
            function getTextNodes(node) {
                if (node.nodeType === 3) { // æ–‡æœ¬èŠ‚ç‚¹
                    if (node.textContent.trim()) {
                        textNodes.push(node);
                    }
                } else {
                    for (let child of node.childNodes) {
                        getTextNodes(child);
                    }
                }
            }
            
            getTextNodes(contentDiv);
            
            // å°†æ–‡æœ¬èŠ‚ç‚¹æ‹†åˆ†ä¸ºå­—ç¬¦å¹¶åŒ…è£…
            textNodes.forEach(node => {
                const text = node.textContent;
                const parent = node.parentNode;
                
                if (parent && text.trim()) {
                    const chars = text.split('');
                    const charSpans = chars.map((char, index) => {
                        const span = document.createElement('span');
                        span.className = 'burning-char';
                        span.textContent = char;
                        span.dataset.charIndex = burningChars.length + index; // è®¾ç½®å­—ç¬¦ç´¢å¼•
                        return span;
                    });
                    
                    const wrapper = document.createElement('span');
                    wrapper.className = 'burning-text';
                    charSpans.forEach(span => wrapper.appendChild(span));
                    
                    parent.replaceChild(wrapper, node);
                    
                    // æŒ‰é¡ºåºæ·»åŠ åˆ°ç„šæ¯åˆ—è¡¨
                    charSpans.forEach(span => burningChars.push(span));
                }
            });
            
            console.log(`å‡†å¤‡ç„šæ¯ ${burningChars.length} ä¸ªå­—ç¬¦ï¼ˆé¡ºåºç„šæ¯ï¼‰`);
        }

        // å¼€å§‹ç„šæ¯å€’è®¡æ—¶
        function startBurnCountdown() {
            if (burnCountdownInterval) {
                clearInterval(burnCountdownInterval);
            }
            
            burnTimeLeft = 10;
            const timeLeftSpan = document.getElementById('timeLeft');
            const burnTimerDiv = document.getElementById('burnTimer');
            
            burnCountdownInterval = setInterval(() => {
                burnTimeLeft--;
                timeLeftSpan.textContent = burnTimeLeft;
                
                if (burnTimeLeft <= 0) {
                    clearInterval(burnCountdownInterval);
                    burnTimerDiv.classList.add('hidden');
                    startSequentialBurnAnimation();
                }
            }, 1000);
        }

        // å¼€å§‹é¡ºåºç„šæ¯åŠ¨ç”»
        function startSequentialBurnAnimation() {
            if (isBurningActive || burningChars.length === 0) return;
            
            isBurningActive = true;
            const burnNowBtn = document.getElementById('burnNowBtn');
            burnNowBtn.disabled = true;
            burnNowBtn.innerHTML = `<i class="fas fa-fire animate-spin"></i><span>ç„šæ¯ä¸­...</span>`;
            
            const burnTimerDiv = document.getElementById('burnTimer');
            burnTimerDiv.classList.add('hidden');
            
            const charsBurnedSpan = document.getElementById('charsBurned');
            const totalCharsSpan = document.getElementById('totalChars');
            const burnPercentageSpan = document.getElementById('burnPercentage');
            const burnProgressBar = document.getElementById('burnProgressBar');
            const burnSpeedSpan = document.getElementById('burnSpeed');
            
            totalChars = burningChars.length;
            let burnedChars = 0;
            currentCharIndex = 0;
            
            // æ ¹æ®å†…å®¹é•¿åº¦è°ƒæ•´ç„šæ¯é€Ÿåº¦
            let burnDelay;
            if (totalChars < 100) {
                burnDelay = 150; // çŸ­å†…å®¹ï¼Œè¾ƒæ…¢é€Ÿåº¦
                burnSpeedSpan.textContent = "é€Ÿåº¦: æ…¢";
            } else if (totalChars < 500) {
                burnDelay = 120; // ä¸­ç­‰å†…å®¹ï¼Œä¸­ç­‰é€Ÿåº¦
                burnSpeedSpan.textContent = "é€Ÿåº¦: ä¸­";
            } else {
                burnDelay = 100; // é•¿å†…å®¹ï¼Œè¾ƒå¿«é€Ÿåº¦
                burnSpeedSpan.textContent = "é€Ÿåº¦: å¿«";
            }
            
            // åˆ›å»ºç„šæ¯é€šçŸ¥
            showBurnNotification();
            
            // åˆ›å»ºç„šæ¯å…‰æ ‡
            createBurnCursor();
            
            // å¼€å§‹é¡ºåºç„šæ¯
            burningInterval = setInterval(() => {
                if (currentCharIndex >= burningChars.length) {
                    // æ‰€æœ‰å­—ç¬¦å·²ç„šæ¯
                    clearInterval(burningInterval);
                    completeBurnAnimation();
                    return;
                }
                
                // ç„šæ¯å½“å‰å­—ç¬¦
                const charSpan = burningChars[currentCharIndex];
                if (charSpan) {
                    // åˆ›å»ºç«ç„°è½¨è¿¹æ•ˆæœ
                    createFireTrail(charSpan);
                    
                    // é«˜äº®å½“å‰æ­£åœ¨ç„šæ¯çš„å­—ç¬¦
                    charSpan.classList.add('current-burning');
                    
                    // ç¨åå¼€å§‹ç„šæ¯åŠ¨ç”»
                    setTimeout(() => {
                        charSpan.classList.add('char-burning');
                        
                        // å†ç¨åå®Œå…¨ç§»é™¤
                        setTimeout(() => {
                            charSpan.classList.add('char-removed');
                            charSpan.classList.remove('current-burning');
                        }, 300);
                    }, 100);
                    
                    burnedChars++;
                    currentCharIndex++;
                    
                    // æ›´æ–°è¿›åº¦
                    const progress = Math.round((burnedChars / totalChars) * 100);
                    const remainingProgress = 100 - progress;
                    
                    charsBurnedSpan.textContent = burnedChars;
                    burnPercentageSpan.textContent = `${progress}%`;
                    burnProgressBar.style.width = `${progress}%`;
                    
                    // æ›´æ–°ç„šæ¯é€šçŸ¥
                    updateBurnNotification(progress);
                    
                    // æ›´æ–°ç„šæ¯å…‰æ ‡ä½ç½®
                    updateBurnCursor();
                }
            }, burnDelay);
        }

        // åˆ›å»ºç«ç„°è½¨è¿¹æ•ˆæœ
        function createFireTrail(charSpan) {
            const rect = charSpan.getBoundingClientRect();
            
            // åˆ›å»ºå¤šä¸ªç«ç„°ç²’å­å½¢æˆè½¨è¿¹
            const particleCount = Math.floor(Math.random() * 2) + 2; // 2-3ä¸ªç²’å­
            
            for (let i = 0; i < particleCount; i++) {
                const fire = document.createElement('div');
                fire.className = 'fire-trail';
                
                // éšæœºæ–¹å‘åç§»
                const offsetX = (Math.random() - 0.5) * 15;
                const offsetY = Math.random() * -15 - 5;
                
                // è®¾ç½®CSSå˜é‡
                fire.style.setProperty('--tx', `${offsetX}px`);
                fire.style.setProperty('--ty', `${offsetY}px`);
                
                fire.style.left = `${rect.left + rect.width / 2}px`;
                fire.style.top = `${rect.top + rect.height / 2}px`;
                
                document.body.appendChild(fire);
                
                // åŠ¨ç”»ç»“æŸåç§»é™¤
                setTimeout(() => {
                    if (fire.parentNode) {
                        fire.parentNode.removeChild(fire);
                    }
                }, 800);
            }
        }

        // åˆ›å»ºç„šæ¯å…‰æ ‡
        function createBurnCursor() {
            // ç§»é™¤å·²æœ‰çš„å…‰æ ‡
            if (burnCursor) {
                burnCursor.remove();
            }
            
            burnCursor = document.createElement('div');
            burnCursor.className = 'burn-cursor';
            burnCursor.id = 'burnCursor';
            
            const contentDiv = document.getElementById('burningContent');
            contentDiv.appendChild(burnCursor);
            
            // åˆå§‹åŒ–å…‰æ ‡ä½ç½®
            updateBurnCursor();
        }

        // æ›´æ–°ç„šæ¯å…‰æ ‡ä½ç½®
        function updateBurnCursor() {
            if (!burnCursor || currentCharIndex >= burningChars.length) {
                if (burnCursor) {
                    burnCursor.style.display = 'none';
                }
                return;
            }
            
            const charSpan = burningChars[currentCharIndex];
            if (charSpan) {
                const rect = charSpan.getBoundingClientRect();
                const contentRect = document.getElementById('burningContent').getBoundingClientRect();
                
                // è®¡ç®—ç›¸å¯¹ä½ç½®
                burnCursor.style.left = `${rect.left - contentRect.left}px`;
                burnCursor.style.top = `${rect.top - contentRect.top}px`;
                burnCursor.style.height = `${rect.height}px`;
                burnCursor.style.display = 'block';
            }
        }

        // å®Œæˆç„šæ¯åŠ¨ç”»
        function completeBurnAnimation() {
            // ç§»é™¤ç„šæ¯å…‰æ ‡
            if (burnCursor) {
                burnCursor.remove();
                burnCursor = null;
            }
            
            // æ›´æ–°æŒ‰é’®çŠ¶æ€
            const burnNowBtn = document.getElementById('burnNowBtn');
            burnNowBtn.innerHTML = `<i class="fas fa-check"></i><span>å·²ç„šæ¯</span>`;
            burnNowBtn.classList.remove('text-orange-500', 'hover:text-red-500');
            burnNowBtn.classList.add('text-gray-500');
            
            // æ˜¾ç¤ºå®Œæˆæ¶ˆæ¯
            setTimeout(() => {
                const contentDiv = document.getElementById('burningContent');
                contentDiv.innerHTML = `
                    <div class="text-center py-12 space-y-4">
                        <div class="text-4xl animate-pulse">ğŸ”¥</div>
                        <h3 class="text-xl font-bold text-red-500">å†…å®¹å·²ç„šæ¯</h3>
                        <p class="text-slate-400 text-sm">æ‰€æœ‰æ•°æ®å·²ä»æœåŠ¡å™¨æ°¸ä¹…åˆ é™¤</p>
                        <div class="text-xs text-slate-500 mt-4">
                            å­—ç¬¦é¡ºåºç„šæ¯å®Œæˆï¼Œå…±ç„šæ¯ ${totalChars} ä¸ªå­—ç¬¦
                        </div>
                    </div>
                `;
                
                // éšè—è¿›åº¦æ¡
                document.querySelector('.pt-4.border-t').style.display = 'none';
            }, 500);
            
            // å¯é€‰ï¼šè°ƒç”¨æœåŠ¡å™¨åˆ é™¤æ¥å£
            try {
                fetch(`${API_URL}/api/share/delete/${shareId}`);
            } catch (e) {
                console.error('åˆ é™¤æœåŠ¡å™¨æ•°æ®å¤±è´¥:', e);
            }
            
            // éšè—ç„šæ¯é€šçŸ¥
            hideBurnNotification();
        }

        // æ˜¾ç¤ºç„šæ¯é€šçŸ¥
        function showBurnNotification() {
            // ç§»é™¤å·²æœ‰çš„é€šçŸ¥
            const existingNotification = document.getElementById('burnNotification');
            if (existingNotification) {
                existingNotification.remove();
            }
            
            const notification = document.createElement('div');
            notification.id = 'burnNotification';
            notification.className = 'burn-notification';
            notification.innerHTML = `
                <div class="text-white font-bold animate-pulse flex items-center gap-2">
                    <i class="fas fa-fire"></i>
                    <span>å­—ç¬¦é¡ºåºç„šæ¯ä¸­...</span>
                </div>
                <div class="text-xs text-white/80" id="burnNotificationProgress">0%</div>
            `;
            
            document.body.appendChild(notification);
            
            // è‡ªåŠ¨éšè—æ—¶é—´
            const autoHideTime = Math.min(15000, totalChars * 50 + 5000);
            setTimeout(() => {
                if (notification.parentNode && !isBurningActive) {
                    notification.remove();
                }
            }, autoHideTime);
        }

        // æ›´æ–°ç„šæ¯é€šçŸ¥
        function updateBurnNotification(progress) {
            const notification = document.getElementById('burnNotification');
            if (notification) {
                const progressSpan = document.getElementById('burnNotificationProgress');
                if (progressSpan) {
                    progressSpan.textContent = `${progress}%`;
                }
            }
        }

        // éšè—ç„šæ¯é€šçŸ¥
        function hideBurnNotification() {
            const notification = document.getElementById('burnNotification');
            if (notification && notification.parentNode) {
                setTimeout(() => {
                    if (notification.parentNode) {
                        notification.remove();
                    }
                }, 1000);
            }
        }

        // æ‰‹åŠ¨è§¦å‘ç„šæ¯åŠ¨ç”»
        function startBurnAnimation() {
            if (isBurningActive) return;
            
            // ç«‹å³å¼€å§‹ç„šæ¯
            const burnTimerDiv = document.getElementById('burnTimer');
            burnTimerDiv.classList.add('hidden');
            
            if (burnCountdownInterval) {
                clearInterval(burnCountdownInterval);
            }
            
            startSequentialBurnAnimation();
        }

        // é¡µé¢å¸è½½æ—¶æ¸…ç†å®šæ—¶å™¨
        window.addEventListener('beforeunload', () => {
            if (burningInterval) {
                clearInterval(burningInterval);
            }
            if (burnCountdownInterval) {
                clearInterval(burnCountdownInterval);
            }
        });

        // ==================== å¿«é€Ÿè®¿é—®åŠŸèƒ½ ====================
        function scrollToTop() {
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }

        // ==================== åˆå§‹åŒ– ====================
        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.register('./sw.js')
                .then(() => console.log('Service Worker Registered'))
                .catch(err => console.error('Service Worker Registration Failed', err));
        }

        // å¯åŠ¨æ—¶æ£€æŸ¥ä¼šè¯
        document.addEventListener('DOMContentLoaded', checkSession);
    </script>
</body>
</html>
