<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CloudNotes | éšç§åŠ å¯†ç¬”è®°ä¸å¯¼èˆª</title>
    
    <!-- æ ·å¼å’Œè„šæœ¬ä¼˜åŒ–ï¼šç§»é™¤éƒ¨åˆ†å†—ä½™ï¼Œä½¿ç”¨æœ¬åœ°ç¼“å­˜ -->
    <link rel="manifest" href="manifest.json">
    <link rel="apple-touch-icon" href="icon.png">
    <meta name="theme-color" content="#020617">
    
    <!-- ä½¿ç”¨æ›´å°çš„Tailwind CSSç‰ˆæœ¬ -->
    <script src="https://cdn.tailwindcss.com/3.3.3"></script>
    
    <!-- ä½¿ç”¨ä¼˜åŒ–è¿‡çš„highlight.js -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/styles/github-dark.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/highlight.min.js"></script>
    
    <!-- ä¼˜åŒ–markedåŠ è½½ -->
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    
    <!-- ä½¿ç”¨Font Awesomeçš„SVGç‰ˆæœ¬ä»¥è·å¾—æ›´å¥½æ€§èƒ½ -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <style>
        /* ä¼˜åŒ–çš„CSS - ç²¾ç®€å¹¶åˆå¹¶ */
        :root {
            --primary-color: #3b82f6;
            --secondary-color: #8b5cf6;
            --danger-color: #ef4444;
            --success-color: #10b981;
        }
        
        * {
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Inter', system-ui, -apple-system, sans-serif;
            background-color: #020617;
            color: #f8fafc;
            overflow-x: hidden;
        }
        
        /* ç²¾ç®€çš„CSSç±» */
        .glass {
            background: rgba(30, 41, 59, 0.7);
            backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .gradient-btn {
            background: linear-gradient(135deg, var(--primary-color) 0%, #2563eb 100%);
            transition: all 0.3s ease;
        }
        
        .gradient-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px -5px rgba(37, 99, 235, 0.4);
        }
        
        .note-card, .nav-link-card {
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            border: 1px solid rgba(255, 255, 255, 0.05);
        }
        
        .note-card:hover, .nav-link-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px -5px rgba(59, 130, 246, 0.2);
        }
        
        /* Markdowné¢„è§ˆæ ·å¼ç²¾ç®€ */
        .markdown-preview {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            line-height: 1.6;
        }
        
        .markdown-preview h1 { font-size: 2em; margin: 1.5em 0 0.5em; }
        .markdown-preview h2 { font-size: 1.5em; margin: 1.5em 0 0.5em; }
        .markdown-preview h3 { font-size: 1.25em; margin: 1.5em 0 0.5em; }
        .markdown-preview p { margin-bottom: 1em; }
        .markdown-preview code { 
            background: rgba(0, 0, 0, 0.3); 
            padding: 0.2em 0.4em; 
            border-radius: 0.25em; 
            font-family: 'Monaco', 'Menlo', monospace; 
        }
        .markdown-preview pre {
            background: rgba(0, 0, 0, 0.4);
            padding: 1em;
            border-radius: 0.5em;
            overflow-x: auto;
        }
        
        /* åŠ è½½åŠ¨ç”» */
        .loader {
            width: 48px;
            height: 48px;
            border: 5px solid var(--primary-color);
            border-bottom-color: transparent;
            border-radius: 50%;
            animation: rotation 1s linear infinite;
        }
        
        @keyframes rotation {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        /* å“åº”å¼è®¾è®¡ */
        @media (max-width: 768px) {
            .nav-grid, .image-grid {
                grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
                gap: 1rem;
            }
            
            .quick-access-bar {
                bottom: 15px;
                right: 15px;
            }
        }
        
        /* å›¾ç‰‡é¢„è§ˆä¼˜åŒ– */
        .image-preview-container {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
            gap: 0.75rem;
        }
        
        /* ç¦ç”¨æ–‡æœ¬é€‰æ‹©ä»¥æé«˜æ€§èƒ½ */
        button, input, textarea {
            user-select: none;
        }
        
        /* æ»šåŠ¨æ¡ä¼˜åŒ– */
        ::-webkit-scrollbar {
            width: 6px;
            height: 6px;
        }
        
        ::-webkit-scrollbar-track {
            background: rgba(255, 255, 255, 0.05);
        }
        
        ::-webkit-scrollbar-thumb {
            background: rgba(59, 130, 246, 0.5);
            border-radius: 3px;
        }
    </style>
</head>

<body class="min-h-screen">
    <!-- Toast é€šçŸ¥å®¹å™¨ -->
    <div id="toastContainer" class="fixed top-4 right-4 z-[1000] space-y-2"></div>
    
    <!-- ä¸»åº”ç”¨å®¹å™¨ -->
    <div id="appContainer" class="hidden">
        <div id="app" class="max-w-6xl mx-auto px-4 py-8"></div>
    </div>

    <!-- å¿«é€Ÿè®¿é—®æ  - ä½¿ç”¨ç®€åŒ–çš„SVGå›¾æ ‡ -->
    <div id="quickAccessBar" class="fixed bottom-20 right-4 z-40 space-y-2 hidden">
        <button onclick="showAddNavLinkModal()" class="w-12 h-12 nav-gradient text-white rounded-full shadow-lg hover:scale-110 transition">
            <svg class="w-6 h-6 mx-auto" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"/>
            </svg>
        </button>
        <button onclick="showAddNoteModal()" class="w-12 h-12 gradient-btn text-white rounded-full shadow-lg hover:scale-110 transition">
            <svg class="w-6 h-6 mx-auto" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"/>
            </svg>
        </button>
        <button onclick="scrollToTop()" class="w-12 h-12 glass text-white rounded-full shadow-lg hover:scale-110 transition">
            <svg class="w-6 h-6 mx-auto" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 10l7-7m0 0l7 7m-7-7v18"/>
            </svg>
        </button>
    </div>

    <!-- æ‰€æœ‰æ¨¡æ€æ¡†å°†åŠ¨æ€åˆ›å»º -->
    
    <script>
        // ==================== ä¼˜åŒ–åçš„ä»£ç ç»“æ„ ====================
        
        // å…¨å±€é…ç½®
        const CONFIG = {
            API_URL: localStorage.getItem('cf_notes_api') || "",
            ADMIN_KEY: localStorage.getItem('cf_notes_key') || "",
            SESSION_KEY: 'cloudnotes_auth_token',
            MAX_ATTEMPTS: 5,
            LOCKOUT_TIME: 300000
        };
        
        // çŠ¶æ€ç®¡ç†
        const STATE = {
            currentView: 'notes',
            currentEditId: null,
            currentEditNavLinkId: null,
            notesCache: new Map(),
            navLinksCache: new Map(),
            selectedImages: [],
            isUploading: false
        };
        
        // DOM ç¼“å­˜
        const DOM = {
            app: document.getElementById('app'),
            appContainer: document.getElementById('appContainer'),
            quickAccessBar: document.getElementById('quickAccessBar'),
            toastContainer: document.getElementById('toastContainer')
        };
        
        // å·¥å…·å‡½æ•°
        const UTILS = {
            // Base64ç¼–ç è§£ç 
            base64Encode(str) {
                try {
                    return btoa(unescape(encodeURIComponent(str)));
                } catch (e) {
                    console.error('Base64ç¼–ç å¤±è´¥:', e);
                    return '';
                }
            },
            
            base64Decode(str) {
                try {
                    return decodeURIComponent(escape(atob(str)));
                } catch (e) {
                    console.error('Base64è§£ç å¤±è´¥:', e);
                    return '';
                }
            },
            
            // æ–‡ä»¶å¤§å°æ ¼å¼åŒ–
            formatFileSize(bytes) {
                if (bytes === 0) return '0 Bytes';
                const k = 1024;
                const sizes = ['Bytes', 'KB', 'MB', 'GB'];
                const i = Math.floor(Math.log(bytes) / Math.log(k));
                return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
            },
            
            // é˜²æŠ–å‡½æ•°
            debounce(func, wait) {
                let timeout;
                return function executedFunction(...args) {
                    const later = () => {
                        clearTimeout(timeout);
                        func(...args);
                    };
                    clearTimeout(timeout);
                    timeout = setTimeout(later, wait);
                };
            },
            
            // èŠ‚æµå‡½æ•°
            throttle(func, limit) {
                let inThrottle;
                return function(...args) {
                    if (!inThrottle) {
                        func.apply(this, args);
                        inThrottle = true;
                        setTimeout(() => inThrottle = false, limit);
                    }
                };
            },
            
            // åˆ›å»ºToast
            showToast(message, type = 'info') {
                const toast = document.createElement('div');
                toast.className = `px-4 py-3 rounded-lg shadow-lg text-white flex items-center gap-2 animate-fade-in ${
                    type === 'success' ? 'bg-green-500' :
                    type === 'error' ? 'bg-red-500' :
                    type === 'warning' ? 'bg-yellow-500' : 'bg-blue-500'
                }`;
                
                toast.innerHTML = `
                    <span>${message}</span>
                `;
                
                DOM.toastContainer.appendChild(toast);
                
                setTimeout(() => {
                    toast.classList.remove('animate-fade-in');
                    toast.classList.add('animate-fade-out');
                    setTimeout(() => toast.remove(), 300);
                }, 3000);
            },
            
            // åŠ è½½åŠ¨ç”»
            createLoader() {
                const loader = document.createElement('div');
                loader.className = 'loader mx-auto';
                return loader;
            },
            
            // å®‰å…¨çš„fetchåŒ…è£…
            async safeFetch(url, options = {}) {
                try {
                    const response = await fetch(url, {
                        timeout: 10000,
                        ...options
                    });
                    
                    if (!response.ok) {
                        throw new Error(`HTTP ${response.status}`);
                    }
                    
                    return await response.json();
                } catch (error) {
                    console.error('Fetch error:', error);
                    throw error;
                }
            }
        };
        
        // åŠ å¯†æ¨¡å—
        const CRYPTO = {
            async getKey(pw) {
                const enc = new TextEncoder();
                const hash = await crypto.subtle.digest('SHA-256', enc.encode(pw));
                return await crypto.subtle.importKey('raw', hash, { name: 'AES-GCM' }, false, ['encrypt', 'decrypt']);
            },
            
            async encrypt(text, pw) {
                try {
                    const enc = new TextEncoder(); 
                    const iv = crypto.getRandomValues(new Uint8Array(12)); 
                    const key = await this.getKey(pw);
                    const cipher = await crypto.subtle.encrypt({ name: 'AES-GCM', iv }, key, enc.encode(text));
                    return btoa(JSON.stringify({ 
                        iv: Array.from(iv), 
                        data: Array.from(new Uint8Array(cipher)) 
                    }));
                } catch (error) {
                    console.error('Encryption failed:', error);
                    throw error;
                }
            },
            
            async decrypt(json, pw) {
                try {
                    const { iv, data } = JSON.parse(atob(json)); 
                    const key = await this.getKey(pw);
                    const dec = await crypto.subtle.decrypt({ 
                        name: 'AES-GCM', 
                        iv: new Uint8Array(iv) 
                    }, key, new Uint8Array(data));
                    return new TextDecoder().decode(dec);
                } catch (e) { 
                    console.error('Decryption failed:', e);
                    return null; 
                }
            }
        };
        
        // API æ¨¡å—
        const API = {
            async request(endpoint, options = {}) {
                const url = `${CONFIG.API_URL}${endpoint}`;
                const headers = {
                    'Content-Type': 'application/json',
                    'Authorization': CONFIG.ADMIN_KEY,
                    ...options.headers
                };
                
                return await UTILS.safeFetch(url, {
                    ...options,
                    headers
                });
            },
            
            // ç¬”è®°ç›¸å…³
            async saveNote(content, id = null) {
                const body = { content };
                if (id) body.id = id;
                
                return await this.request('/api/save', {
                    method: 'POST',
                    body: JSON.stringify(body)
                });
            },
            
            async getNotes() {
                return await this.request('/api/list');
            },
            
            async deleteNote(id) {
                return await this.request('/api/delete', {
                    method: 'POST',
                    body: JSON.stringify({ id })
                });
            },
            
            // å¯¼èˆªé“¾æ¥ç›¸å…³
            async saveNavLink(data) {
                return await this.request('/api/nav/save', {
                    method: 'POST',
                    body: JSON.stringify(data)
                });
            },
            
            async getNavLinks() {
                return await this.request('/api/nav/list');
            },
            
            async deleteNavLink(id) {
                return await this.request('/api/nav/delete', {
                    method: 'POST',
                    body: JSON.stringify({ id })
                });
            },
            
            // å›¾ç‰‡ç›¸å…³
            async uploadImage(formData) {
                return await UTILS.safeFetch(`${CONFIG.API_URL}/api/images/upload`, {
                    method: 'POST',
                    headers: { 'Authorization': CONFIG.ADMIN_KEY },
                    body: formData
                });
            },
            
            async getImages() {
                return await this.request('/api/images/list');
            },
            
            async deleteImage(id) {
                return await this.request('/api/images/delete', {
                    method: 'POST',
                    body: JSON.stringify({ id })
                });
            }
        };
        
        // è§†å›¾æ¸²æŸ“æ¨¡å—
        const VIEWS = {
            // ä¸»è§†å›¾
            renderMain() {
                DOM.app.innerHTML = `
                    <div class="space-y-8 animate-fade-in">
                        <header class="flex justify-between items-center mb-8">
                            <div>
                                <h1 class="text-3xl font-bold bg-gradient-to-r from-blue-400 to-purple-500 bg-clip-text text-transparent">
                                    CloudNotes
                                </h1>
                                <p class="text-sm text-slate-400 mt-1">ç«¯åˆ°ç«¯åŠ å¯†ç¬”è®°ä¸ä¸ªäººå¯¼èˆª</p>
                            </div>
                            <div class="flex items-center gap-3">
                                <div class="flex bg-slate-800/50 rounded-lg p-1">
                                    <button onclick="switchView('notes')" class="px-4 py-2 rounded ${STATE.currentView === 'notes' ? 'bg-slate-700 text-white' : 'text-slate-400'}">
                                        ç¬”è®°
                                    </button>
                                    <button onclick="switchView('nav')" class="px-4 py-2 rounded ${STATE.currentView === 'nav' ? 'bg-slate-700 text-white' : 'text-slate-400'}">
                                        å¯¼èˆª
                                    </button>
                                    <button onclick="switchView('images')" class="px-4 py-2 rounded ${STATE.currentView === 'images' ? 'bg-slate-700 text-white' : 'text-slate-400'}">
                                        å›¾ç‰‡
                                    </button>
                                </div>
                                <button onclick="logout()" class="text-slate-400 hover:text-white px-3 py-1 text-sm">
                                    é€€å‡º
                                </button>
                            </div>
                        </header>
                        
                        ${this.getCurrentView()}
                    </div>
                `;
                
                DOM.quickAccessBar.classList.remove('hidden');
            },
            
            getCurrentView() {
                switch (STATE.currentView) {
                    case 'notes': return this.renderNotesView();
                    case 'nav': return this.renderNavView();
                    case 'images': return this.renderImagesView();
                    default: return this.renderNotesView();
                }
            },
            
            // ç¬”è®°è§†å›¾
            renderNotesView() {
                return `
                    <div>
                        <div class="glass p-6 rounded-2xl mb-6">
                            <div class="space-y-4">
                                <div>
                                    <label class="text-sm font-medium text-slate-300 mb-2 block">è§£å¯†å¯†ç </label>
                                    <input id="mainPw" type="password" placeholder="è¾“å…¥ä¸»å¯†ç " 
                                        class="w-full bg-slate-900/50 border border-slate-700 rounded-lg p-3 outline-none focus:ring-2 ring-blue-500/50">
                                </div>
                                <div>
                                    <label class="text-sm font-medium text-slate-300 mb-2 block">ç¬”è®°å†…å®¹</label>
                                    <textarea id="noteInput" placeholder="è¾“å…¥ç¬”è®°å†…å®¹..." 
                                        class="w-full bg-slate-900/50 border border-slate-700 rounded-lg p-3 h-48 resize-none outline-none"></textarea>
                                    <div class="text-xs text-slate-500 mt-2 flex justify-between">
                                        <span id="noteCharCount">0 å­—ç¬¦</span>
                                        <button onclick="showMarkdownHelp()" class="text-blue-400 hover:text-blue-300">Markdownå¸®åŠ©</button>
                                    </div>
                                </div>
                                <div class="grid grid-cols-3 gap-3">
                                    <button onclick="doSave()" class="gradient-btn text-white py-3 rounded-lg font-medium">
                                        ä¿å­˜
                                    </button>
                                    <button onclick="loadNotesList()" class="glass py-3 rounded-lg font-medium">
                                        åˆ·æ–°
                                    </button>
                                    <button onclick="showAddNoteModal()" class="bg-emerald-600 text-white py-3 rounded-lg font-medium">
                                        å¿«é€Ÿæ·»åŠ 
                                    </button>
                                </div>
                            </div>
                        </div>
                        
                        <div id="notesList" class="space-y-4">
                            <!-- ç¬”è®°åˆ—è¡¨å°†é€šè¿‡JSåŠ¨æ€å¡«å…… -->
                        </div>
                    </div>
                `;
            },
            
            // å¯¼èˆªè§†å›¾
            renderNavView() {
                return `
                    <div>
                        <div class="glass p-6 rounded-2xl mb-6">
                            <div class="text-center space-y-4">
                                <h2 class="text-xl font-bold text-purple-300">ğŸ”— ä¸ªäººå¯¼èˆª</h2>
                                <p class="text-slate-400">ç®¡ç†æ‚¨çš„å¸¸ç”¨é“¾æ¥</p>
                                <div class="flex justify-center gap-3">
                                    <button onclick="showAddNavLinkModal()" class="px-4 py-2 bg-purple-600 text-white rounded-lg hover:bg-purple-700">
                                        æ·»åŠ é“¾æ¥
                                    </button>
                                    <button onclick="loadNavLinks()" class="px-4 py-2 glass text-purple-400 rounded-lg">
                                        åˆ·æ–°
                                    </button>
                                </div>
                            </div>
                        </div>
                        
                        <div id="navCategories" class="space-y-6">
                            <!-- å¯¼èˆªé“¾æ¥å°†é€šè¿‡JSåŠ¨æ€å¡«å…… -->
                        </div>
                    </div>
                `;
            },
            
            // å›¾ç‰‡è§†å›¾
            renderImagesView() {
                return `
                    <div>
                        <div class="glass p-6 rounded-2xl mb-6">
                            <div class="text-center space-y-4">
                                <h2 class="text-xl font-bold text-emerald-300">ğŸ–¼ï¸ å›¾ç‰‡ç®¡ç†</h2>
                                <p class="text-slate-400">ä¸Šä¼ å’Œç®¡ç†å›¾ç‰‡</p>
                                <div class="flex justify-center gap-3">
                                    <button onclick="showImageUploadModal()" class="px-4 py-2 bg-emerald-600 text-white rounded-lg hover:bg-emerald-700">
                                        ä¸Šä¼ å›¾ç‰‡
                                    </button>
                                    <button onclick="loadImages()" class="px-4 py-2 glass text-emerald-400 rounded-lg">
                                        åˆ·æ–°
                                    </button>
                                </div>
                            </div>
                        </div>
                        
                        <div id="imagesGrid" class="space-y-6">
                            <!-- å›¾ç‰‡å°†é€šè¿‡JSåŠ¨æ€å¡«å…… -->
                        </div>
                    </div>
                `;
            }
        };
        
        // æ¨¡æ€æ¡†ç®¡ç†å™¨
        const MODALS = {
            currentModal: null,
            
            createModal(options) {
                const modal = document.createElement('div');
                modal.className = 'fixed inset-0 bg-black/60 backdrop-blur-sm z-50 flex items-center justify-center p-4';
                modal.innerHTML = `
                    <div class="glass w-full max-w-md p-6 rounded-2xl shadow-xl space-y-4">
                        ${options.title ? `<h2 class="text-xl font-bold">${options.title}</h2>` : ''}
                        <div>${options.content}</div>
                        ${options.buttons ? `
                            <div class="flex gap-3 pt-4 border-t border-white/5">
                                ${options.buttons.map(btn => `
                                    <button onclick="${btn.onclick}" class="flex-1 py-2 rounded-lg ${btn.class || 'glass'}">
                                        ${btn.text}
                                    </button>
                                `).join('')}
                            </div>
                        ` : ''}
                    </div>
                `;
                
                modal.addEventListener('click', (e) => {
                    if (e.target === modal) {
                        this.closeModal();
                    }
                });
                
                return modal;
            },
            
            showModal(options) {
                if (this.currentModal) {
                    this.closeModal();
                }
                
                this.currentModal = this.createModal(options);
                document.body.appendChild(this.currentModal);
            },
            
            closeModal() {
                if (this.currentModal) {
                    this.currentModal.remove();
                    this.currentModal = null;
                }
            },
            
            // å¸¸ç”¨çš„æ¨¡æ€æ¡†
            showSettings() {
                this.showModal({
                    title: 'âš™ï¸ ç³»ç»Ÿè®¾ç½®',
                    content: `
                        <div class="space-y-4">
                            <div>
                                <label class="text-sm font-medium text-slate-300 mb-2 block">Workeråœ°å€</label>
                                <input id="setApi" type="text" placeholder="https://..." 
                                    class="w-full bg-slate-900/50 border border-slate-700 rounded-lg p-3">
                            </div>
                            <div>
                                <label class="text-sm font-medium text-slate-300 mb-2 block">ç®¡ç†å‘˜å¯†é’¥</label>
                                <input id="setKey" type="password" placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢"
                                    class="w-full bg-slate-900/50 border border-slate-700 rounded-lg p-3">
                            </div>
                        </div>
                    `,
                    buttons: [
                        { text: 'å–æ¶ˆ', onclick: 'MODALS.closeModal()' },
                        { text: 'ä¿å­˜', onclick: 'saveSettings()', class: 'gradient-btn text-white' }
                    ]
                });
            }
        };
        
        // äº‹ä»¶å¤„ç†
        const EVENTS = {
            init() {
                // è¾“å…¥æ¡†å­—ç¬¦è®¡æ•°
                document.addEventListener('input', UTILS.debounce((e) => {
                    if (e.target.id === 'noteInput') {
                        const count = e.target.value.length;
                        document.getElementById('noteCharCount').textContent = `${count} å­—ç¬¦`;
                    }
                }, 300));
                
                // é”®ç›˜å¿«æ·é”®
                document.addEventListener('keydown', (e) => {
                    // Ctrl+S ä¿å­˜ç¬”è®°
                    if ((e.ctrlKey || e.metaKey) && e.key === 's') {
                        e.preventDefault();
                        if (STATE.currentView === 'notes') {
                            doSave();
                        }
                    }
                    
                    // Esc å…³é—­æ¨¡æ€æ¡†
                    if (e.key === 'Escape') {
                        MODALS.closeModal();
                    }
                });
            }
        };
        
        // ==================== æ ¸å¿ƒåŠŸèƒ½å‡½æ•° ====================
        
        // è§†å›¾åˆ‡æ¢
        function switchView(view) {
            STATE.currentView = view;
            VIEWS.renderMain();
            
            // å»¶è¿ŸåŠ è½½æ•°æ®ï¼Œé¿å…é˜»å¡æ¸²æŸ“
            setTimeout(() => {
                if (view === 'nav') loadNavLinks();
                else if (view === 'images') loadImages();
            }, 100);
        }
        
        // åŠ è½½ç¬”è®°åˆ—è¡¨ï¼ˆä¼˜åŒ–ç‰ˆï¼‰
        async function loadNotesList() {
            const pw = document.getElementById('mainPw')?.value;
            if (!pw) {
                UTILS.showToast('è¯·è¾“å…¥å¯†ç ', 'warning');
                return;
            }
            
            const listDiv = document.getElementById('notesList');
            listDiv.innerHTML = '<div class="text-center py-12">' + UTILS.createLoader().outerHTML + '</div>';
            
            try {
                const notes = await API.getNotes();
                
                if (!notes.length) {
                    listDiv.innerHTML = '<div class="text-center py-12 text-slate-500">æš‚æ— ç¬”è®°</div>';
                    return;
                }
                
                // æ¸…ç©ºç¼“å­˜
                STATE.notesCache.clear();
                
                let html = '';
                for (const note of notes) {
                    const clearText = await CRYPTO.decrypt(note.content, pw);
                    if (!clearText) continue;
                    
                    STATE.notesCache.set(note.id, {
                        id: note.id,
                        clearText,
                        created_at: note.created_at
                    });
                    
                    const preview = clearText.length > 200 ? clearText.substring(0, 200) + '...' : clearText;
                    const isMarkdown = /^[#\->*`]/.test(clearText.trim());
                    
                    html += `
                        <div class="glass p-4 rounded-xl space-y-3 note-card">
                            <div class="flex justify-between items-start">
                                <div class="text-sm text-slate-500">
                                    #${note.id} Â· ${new Date(note.created_at).toLocaleDateString()}
                                </div>
                                <div class="flex gap-2">
                                    <button onclick="editNote(${note.id})" class="text-blue-400 hover:text-blue-300 text-sm">
                                        ç¼–è¾‘
                                    </button>
                                    <button onclick="deleteNote(${note.id})" class="text-red-400 hover:text-red-300 text-sm">
                                        åˆ é™¤
                                    </button>
                                </div>
                            </div>
                            <div class="text-slate-300 whitespace-pre-wrap">
                                ${isMarkdown ? marked.parse(preview) : preview.replace(/\n/g, '<br>')}
                            </div>
                        </div>
                    `;
                }
                
                listDiv.innerHTML = html;
                
            } catch (error) {
                console.error('åŠ è½½ç¬”è®°å¤±è´¥:', error);
                listDiv.innerHTML = '<div class="text-center py-12 text-red-400">åŠ è½½å¤±è´¥</div>';
            }
        }
        
        // ä¿å­˜ç¬”è®°
        async function doSave(content, id = null) {
            const text = content || document.getElementById('noteInput')?.value;
            const pw = document.getElementById('mainPw')?.value;
            
            if (!text || !pw) {
                UTILS.showToast('è¯·å¡«å†™å†…å®¹å’Œå¯†ç ', 'warning');
                return false;
            }
            
            try {
                const cipher = await CRYPTO.encrypt(text, pw);
                await API.saveNote(cipher, id);
                
                UTILS.showToast(id ? 'ç¬”è®°å·²æ›´æ–°' : 'ç¬”è®°å·²ä¿å­˜', 'success');
                
                if (!id) {
                    document.getElementById('noteInput').value = '';
                }
                
                loadNotesList();
                return true;
            } catch (error) {
                console.error('ä¿å­˜å¤±è´¥:', error);
                UTILS.showToast('ä¿å­˜å¤±è´¥', 'error');
                return false;
            }
        }
        
        // ç¼–è¾‘ç¬”è®°
        function editNote(id) {
            const note = STATE.notesCache.get(id);
            if (!note) {
                UTILS.showToast('ç¬”è®°ä¸å­˜åœ¨', 'error');
                return;
            }
            
            MODALS.showModal({
                title: `ç¼–è¾‘ç¬”è®° #${id}`,
                content: `
                    <div class="space-y-4">
                        <textarea id="editNoteContent" 
                            class="w-full bg-slate-900/50 border border-slate-700 rounded-lg p-3 h-64 resize-none outline-none">${note.clearText}</textarea>
                        <div class="text-xs text-slate-500 flex justify-between">
                            <span>${note.clearText.length} å­—ç¬¦</span>
                            <button onclick="previewMarkdown()" class="text-blue-400">é¢„è§ˆ</button>
                        </div>
                    </div>
                `,
                buttons: [
                    { text: 'å–æ¶ˆ', onclick: 'MODALS.closeModal()' },
                    { text: 'ä¿å­˜', onclick: `saveEditedNote(${id})`, class: 'gradient-btn text-white' }
                ]
            });
        }
        
        async function saveEditedNote(id) {
            const content = document.getElementById('editNoteContent')?.value;
            if (!content) {
                UTILS.showToast('å†…å®¹ä¸èƒ½ä¸ºç©º', 'warning');
                return;
            }
            
            const success = await doSave(content, id);
            if (success) {
                MODALS.closeModal();
            }
        }
        
        // åˆ é™¤ç¬”è®°
        async function deleteNote(id) {
            if (!confirm('ç¡®å®šè¦åˆ é™¤è¿™æ¡ç¬”è®°å—ï¼Ÿ')) return;
            
            try {
                await API.deleteNote(id);
                UTILS.showToast('ç¬”è®°å·²åˆ é™¤', 'success');
                loadNotesList();
            } catch (error) {
                console.error('åˆ é™¤å¤±è´¥:', error);
                UTILS.showToast('åˆ é™¤å¤±è´¥', 'error');
            }
        }
        
        // åŠ è½½å¯¼èˆªé“¾æ¥
        async function loadNavLinks() {
            const container = document.getElementById('navCategories');
            if (!container) return;
            
            container.innerHTML = '<div class="text-center py-12">' + UTILS.createLoader().outerHTML + '</div>';
            
            try {
                const links = await API.getNavLinks();
                
                if (!links.length) {
                    container.innerHTML = '<div class="text-center py-12 text-slate-500">æš‚æ— é“¾æ¥</div>';
                    return;
                }
                
                // æŒ‰åˆ†ç±»åˆ†ç»„
                const categories = {};
                links.forEach(link => {
                    const cat = link.category || 'æœªåˆ†ç±»';
                    if (!categories[cat]) categories[cat] = [];
                    categories[cat].push(link);
                });
                
                let html = '';
                Object.entries(categories).forEach(([category, items]) => {
                    html += `
                        <div class="space-y-3">
                            <h3 class="text-lg font-semibold text-slate-300">${category}</h3>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
                    `;
                    
                    items.forEach(link => {
                        html += `
                            <div class="glass p-3 rounded-lg nav-link-card">
                                <a href="${link.url}" target="_blank" class="flex items-center gap-3 no-underline">
                                    <div class="w-10 h-10 rounded-lg bg-slate-800 flex items-center justify-center">
                                        <i class="${link.icon || 'fas fa-globe'}"></i>
                                    </div>
                                    <div class="flex-1">
                                        <div class="font-medium text-white">${link.title}</div>
                                        <div class="text-xs text-slate-400 truncate">${link.url}</div>
                                    </div>
                                </a>
                            </div>
                        `;
                    });
                    
                    html += `
                            </div>
                        </div>
                    `;
                });
                
                container.innerHTML = html;
            } catch (error) {
                console.error('åŠ è½½é“¾æ¥å¤±è´¥:', error);
                container.innerHTML = '<div class="text-center py-12 text-red-400">åŠ è½½å¤±è´¥</div>';
            }
        }
        
        // åŠ è½½å›¾ç‰‡
        async function loadImages() {
            const container = document.getElementById('imagesGrid');
            if (!container) return;
            
            container.innerHTML = '<div class="text-center py-12">' + UTILS.createLoader().outerHTML + '</div>';
            
            try {
                const images = await API.getImages();
                
                if (!images.length) {
                    container.innerHTML = '<div class="text-center py-12 text-slate-500">æš‚æ— å›¾ç‰‡</div>';
                    return;
                }
                
                let html = '<div class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-4">';
                
                images.forEach(img => {
                    html += `
                        <div class="glass rounded-lg overflow-hidden">
                            <img src="${img.url}" alt="${img.name}" 
                                 class="w-full h-32 object-cover cursor-pointer hover:opacity-90 transition"
                                 onclick="previewImage('${img.url}')">
                            <div class="p-3">
                                <div class="text-sm text-slate-300 truncate">${img.name}</div>
                                <div class="text-xs text-slate-500 mt-1">${UTILS.formatFileSize(img.size)}</div>
                            </div>
                        </div>
                    `;
                });
                
                html += '</div>';
                container.innerHTML = html;
            } catch (error) {
                console.error('åŠ è½½å›¾ç‰‡å¤±è´¥:', error);
                container.innerHTML = '<div class="text-center py-12 text-red-400">åŠ è½½å¤±è´¥</div>';
            }
        }
        
        // å›¾ç‰‡é¢„è§ˆ
        function previewImage(url) {
            MODALS.showModal({
                content: `
                    <div class="text-center">
                        <img src="${url}" class="max-h-[60vh] max-w-full mx-auto rounded-lg">
                    </div>
                `,
                buttons: [
                    { text: 'å…³é—­', onclick: 'MODALS.closeModal()' }
                ]
            });
        }
        
        // ä¿å­˜è®¾ç½®
        function saveSettings() {
            const apiUrl = document.getElementById('setApi')?.value.trim().replace(/\/+$/, '');
            const adminKey = document.getElementById('setKey')?.value;
            
            if (!apiUrl) {
                UTILS.showToast('è¯·è¾“å…¥APIåœ°å€', 'warning');
                return;
            }
            
            localStorage.setItem('cf_notes_api', apiUrl);
            localStorage.setItem('cf_notes_key', adminKey || '');
            
            CONFIG.API_URL = apiUrl;
            CONFIG.ADMIN_KEY = adminKey || '';
            
            UTILS.showToast('è®¾ç½®å·²ä¿å­˜', 'success');
            MODALS.closeModal();
            
            // é‡æ–°åŠ è½½åº”ç”¨
            setTimeout(() => location.reload(), 1000);
        }
        
        // ç™»å‡º
        function logout() {
            sessionStorage.removeItem(CONFIG.SESSION_KEY);
            location.reload();
        }
        
        // Markdownå¸®åŠ©
        function showMarkdownHelp() {
            MODALS.showModal({
                title: 'Markdown å¸®åŠ©',
                content: `
                    <div class="space-y-2 text-sm">
                        <p><code># æ ‡é¢˜</code> - ä¸€çº§æ ‡é¢˜</p>
                        <p><code>## æ ‡é¢˜</code> - äºŒçº§æ ‡é¢˜</p>
                        <p><code>**ç²—ä½“**</code> - ç²—ä½“æ–‡æœ¬</p>
                        <p><code>*æ–œä½“*</code> - æ–œä½“æ–‡æœ¬</p>
                        <p><code>\`ä»£ç \`</code> - è¡Œå†…ä»£ç </p>
                        <p><code>[é“¾æ¥](URL)</code> - è¶…é“¾æ¥</p>
                        <p><code>![å›¾ç‰‡](URL)</code> - æ’å…¥å›¾ç‰‡</p>
                        <p><code>- åˆ—è¡¨</code> - æ— åºåˆ—è¡¨</p>
                        <p><code>1. åˆ—è¡¨</code> - æœ‰åºåˆ—è¡¨</p>
                    </div>
                `,
                buttons: [
                    { text: 'å…³é—­', onclick: 'MODALS.closeModal()' }
                ]
            });
        }
        
        // æ»šåŠ¨åˆ°é¡¶éƒ¨
        function scrollToTop() {
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }
        
        // ==================== åˆå§‹åŒ– ====================
        
        function initApp() {
            // æ£€æŸ¥URLå‚æ•°
            const urlParams = new URLSearchParams(window.location.search);
            const shareId = urlParams.get('share');
            const cfgFromUrl = urlParams.get('cfg');
            
            if (cfgFromUrl) {
                try {
                    CONFIG.API_URL = atob(cfgFromUrl);
                } catch (e) {
                    console.error('è§£ç é…ç½®å¤±è´¥:', e);
                }
            }
            
            // æ£€æŸ¥ä¼šè¯
            const token = sessionStorage.getItem(CONFIG.SESSION_KEY);
            if (!token && !shareId && CONFIG.API_URL) {
                // æ˜¾ç¤ºç™»å½•ç•Œé¢
                showLogin();
                return;
            }
            
            // æ˜¾ç¤ºä¸»åº”ç”¨
            DOM.appContainer.classList.remove('hidden');
            VIEWS.renderMain();
            EVENTS.init();
            
            // å¦‚æœæ˜¯åˆ†äº«æ¨¡å¼ï¼Œæ˜¾ç¤ºåˆ†äº«è§†å›¾
            if (shareId) {
                renderShareView();
            }
        }
        
        function showLogin() {
            DOM.app.innerHTML = `
                <div class="min-h-screen flex items-center justify-center p-4">
                    <div class="glass w-full max-w-md p-8 rounded-2xl space-y-6">
                        <div class="text-center space-y-4">
                            <div class="text-4xl">ğŸ”</div>
                            <h1 class="text-2xl font-bold">CloudNotes</h1>
                            <p class="text-slate-400">è¯·è¾“å…¥è®¿é—®å¯†ç </p>
                        </div>
                        <div class="space-y-4">
                            <input id="loginPassword" type="password" placeholder="å¯†ç " 
                                class="w-full bg-slate-900/50 border border-slate-700 rounded-lg p-3 outline-none focus:ring-2 ring-blue-500/50">
                            <button onclick="checkLogin()" class="w-full gradient-btn text-white py-3 rounded-lg font-medium">
                                ç™»å½•
                            </button>
                        </div>
                    </div>
                </div>
            `;
        }
        
        async function checkLogin() {
            const password = document.getElementById('loginPassword')?.value;
            if (!password) {
                UTILS.showToast('è¯·è¾“å…¥å¯†ç ', 'warning');
                return;
            }
            
            try {
                const response = await fetch(`${CONFIG.API_URL}/api/verify-password`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ password })
                });
                
                if (response.ok) {
                    const token = btoa(Date.now() + '-' + Math.random().toString(36).substr(2));
                    sessionStorage.setItem(CONFIG.SESSION_KEY, token);
                    initApp();
                } else {
                    UTILS.showToast('å¯†ç é”™è¯¯', 'error');
                }
            } catch (error) {
                console.error('ç™»å½•å¤±è´¥:', error);
                UTILS.showToast('ç™»å½•å¤±è´¥', 'error');
            }
        }
        
        // å¯åŠ¨åº”ç”¨
        document.addEventListener('DOMContentLoaded', initApp);
        
        // æ·»åŠ CSSåŠ¨ç”»
        const style = document.createElement('style');
        style.textContent = `
            .animate-fade-in {
                animation: fadeIn 0.3s ease-out;
            }
            
            .animate-fade-out {
                animation: fadeOut 0.3s ease-out;
            }
            
            @keyframes fadeIn {
                from { opacity: 0; transform: translateY(-10px); }
                to { opacity: 1; transform: translateY(0); }
            }
            
            @keyframes fadeOut {
                from { opacity: 1; transform: translateY(0); }
                to { opacity: 0; transform: translateY(-10px); }
            }
        `;
        document.head.appendChild(style);
        
        // æš´éœ²å…¨å±€å‡½æ•°
        window.switchView = switchView;
        window.loadNotesList = loadNotesList;
        window.doSave = doSave;
        window.editNote = editNote;
        window.deleteNote = deleteNote;
        window.loadNavLinks = loadNavLinks;
        window.loadImages = loadImages;
        window.previewImage = previewImage;
        window.saveSettings = saveSettings;
        window.logout = logout;
        window.showMarkdownHelp = showMarkdownHelp;
        window.scrollToTop = scrollToTop;
        window.MODALS = MODALS;
        window.checkLogin = checkLogin;
        
    </script>
</body>
</html>
