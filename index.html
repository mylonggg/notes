<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CloudNotes | éšç§åŠ å¯†ç¬”è®°ä¸å¯¼èˆª</title>
    <link rel="manifest" href="manifest.json">
    <link rel="apple-touch-icon" href="icon.png">
    <meta name="theme-color" content="#020617">
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/styles/github-dark.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/highlight.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap');

        body {
            font-family: 'Inter', sans-serif;
            background-color: #020617;
            color: #f8fafc;
        }

        .glass {
            background: rgba(30, 41, 59, 0.7);
            backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .gradient-btn {
            background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .gradient-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px -5px rgba(37, 99, 235, 0.4);
        }

        .note-card {
            transition: all 0.3s ease;
        }

        .note-card:hover {
            border-color: rgba(59, 130, 246, 0.5);
            background: rgba(30, 41, 59, 0.9);
        }

        ::-webkit-scrollbar {
            width: 0px;
        }

        /* ç»Ÿä¸€çš„Markdowné¢„è§ˆæ ·å¼ */
        .markdown-preview {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            line-height: 1.6;
            overflow-wrap: break-word;
        }

        .markdown-preview h1 {
            font-size: 2em;
            font-weight: 800;
            margin-top: 1.5em;
            margin-bottom: 0.5em;
            padding-bottom: 0.3em;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .markdown-preview h2 {
            font-size: 1.5em;
            font-weight: 700;
            margin-top: 1.5em;
            margin-bottom: 0.5em;
        }

        .markdown-preview h3 {
            font-size: 1.25em;
            font-weight: 600;
            margin-top: 1.5em;
            margin-bottom: 0.5em;
        }

        .markdown-preview h4 {
            font-size: 1.1em;
            font-weight: 600;
            margin-top: 1.5em;
            margin-bottom: 0.5em;
        }

        .markdown-preview p {
            margin-bottom: 1em;
        }

        .markdown-preview ul, .markdown-preview ol {
            margin-left: 1.5em;
            margin-bottom: 1em;
        }

        .markdown-preview li {
            margin-bottom: 0.5em;
        }

        .markdown-preview code {
            background: rgba(0, 0, 0, 0.3);
            padding: 0.2em 0.4em;
            border-radius: 0.25em;
            font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', monospace;
            font-size: 0.9em;
        }

        .markdown-preview pre {
            background: rgba(0, 0, 0, 0.4);
            padding: 1em;
            border-radius: 0.5em;
            overflow-x: auto;
            margin-bottom: 1.5em;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .markdown-preview blockquote {
            border-left: 4px solid #3b82f6;
            padding-left: 1em;
            margin-left: 0;
            margin-bottom: 1.5em;
            color: #94a3b8;
            font-style: italic;
        }

        .markdown-preview table {
            border-collapse: collapse;
            width: 100%;
            margin-bottom: 1.5em;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .markdown-preview th, .markdown-preview td {
            border: 1px solid rgba(255, 255, 255, 0.1);
            padding: 0.75em;
            text-align: left;
        }

        .markdown-preview th {
            background: rgba(0, 0, 0, 0.2);
            font-weight: 600;
        }

        .markdown-preview a {
            color: #60a5fa;
            text-decoration: none;
        }

        .markdown-preview a:hover {
            text-decoration: underline;
        }

        .markdown-preview img {
            max-width: 100%;
            border-radius: 0.5em;
            margin-bottom: 1em;
        }

        .markdown-preview hr {
            border: none;
            height: 1px;
            background: rgba(255, 255, 255, 0.1);
            margin: 2em 0;
        }

        .markdown-preview strong {
            font-weight: 700;
        }

        .markdown-preview em {
            font-style: italic;
        }

        .markdown-preview del {
            text-decoration: line-through;
        }

        .tab-button {
            padding: 0.75em 1.5em;
            background: transparent;
            border: none;
            color: #94a3b8;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: 600;
            border-radius: 0.5em;
        }

        .tab-button:hover {
            background: rgba(255, 255, 255, 0.05);
        }

        .tab-button.active {
            color: #60a5fa;
            background: rgba(59, 130, 246, 0.1);
        }

        .hljs {
            background: transparent !important;
        }
        
        .login-shake {
            animation: shake 0.5s ease-in-out;
        }
        
        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            10%, 30%, 50%, 70%, 90% { transform: translateX(-5px); }
            20%, 40%, 60%, 80% { transform: translateX(5px); }
        }
        
        .login-bg {
            background: linear-gradient(135deg, #0f172a 0%, #1e293b 50%, #0f172a 100%);
        }
        
        .loader {
            width: 48px;
            height: 48px;
            border: 5px solid #3b82f6;
            border-bottom-color: transparent;
            border-radius: 50%;
            display: inline-block;
            box-sizing: border-box;
            animation: rotation 1s linear infinite;
        }

        @keyframes rotation {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .share-gradient {
            background: linear-gradient(135deg, #f97316 0%, #dc2626 100%);
        }
        
        .share-gradient:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px -5px rgba(220, 38, 38, 0.4);
        }
        
        .nav-gradient {
            background: linear-gradient(135deg, #8b5cf6 0%, #7c3aed 100%);
        }
        
        .nav-gradient:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px -5px rgba(124, 58, 237, 0.4);
        }
        
        .nav-link-card {
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            border: 1px solid rgba(255, 255, 255, 0.05);
        }
        
        .nav-link-card:hover {
            transform: translateY(-4px);
            border-color: rgba(139, 92, 246, 0.5);
            box-shadow: 0 10px 25px -5px rgba(139, 92, 246, 0.3);
            background: rgba(30, 41, 59, 0.9);
        }
        
        .category-tag {
            display: inline-block;
            padding: 0.25em 0.75em;
            border-radius: 9999px;
            font-size: 0.75rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }
        
        .icon-blue { color: #60a5fa; }
        .icon-green { color: #34d399; }
        .icon-purple { color: #a78bfa; }
        .icon-red { color: #f87171; }
        .icon-yellow { color: #fbbf24; }
        .icon-pink { color: #f472b6; }
        .icon-indigo { color: #818cf8; }
        
        .quick-access-bar {
            position: fixed;
            bottom: 20px;
            right: 20px;
            z-index: 100;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        
        .quick-access-btn {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.25rem;
            transition: all 0.3s ease;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
        }
        
        .quick-access-btn:hover {
            transform: scale(1.1) rotate(5deg);
        }
        
        .modal-enter {
            animation: modalEnter 0.3s ease-out;
        }
        
        @keyframes modalEnter {
            from {
                opacity: 0;
                transform: scale(0.9) translateY(-20px);
            }
            to {
                opacity: 1;
                transform: scale(1) translateY(0);
            }
        }
        
        .nav-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 1.5rem;
        }
        
        @media (max-width: 768px) {
            .nav-grid {
                grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
                gap: 1rem;
            }
            
            .quick-access-bar {
                bottom: 15px;
                right: 15px;
            }
            
            .quick-access-btn {
                width: 45px;
                height: 45px;
                font-size: 1.1rem;
            }
        }

        .toggle-btn {
            transition: all 0.3s ease;
            border: 1px solid rgba(59, 130, 246, 0.2);
        }
        
        .toggle-btn:hover {
            border-color: rgba(59, 130, 246, 0.4);
            background: rgba(59, 130, 246, 0.1);
        }
        
        .toggle-btn i {
            transition: transform 0.3s ease;
        }
        
        .toggle-btn.expanded i {
            transform: rotate(180deg);
        }
        
        /* Toast é€šçŸ¥æ ·å¼ */
        .toast {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 1000;
            padding: 12px 20px;
            border-radius: 8px;
            color: white;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 10px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
            transform: translateY(-20px);
            opacity: 0;
            transition: all 0.3s ease;
        }
        
        .toast.show {
            transform: translateY(0);
            opacity: 1;
        }
        
        .toast.success {
            background: linear-gradient(135deg, #10b981, #059669);
        }
        
        .toast.error {
            background: linear-gradient(135deg, #ef4444, #dc2626);
        }
        
        .toast.info {
            background: linear-gradient(135deg, #3b82f6, #2563eb);
        }
        
        .share-btn {
            transition: all 0.3s ease;
        }
        
        .share-btn:hover {
            transform: translateY(-2px);
        }
        
        /* Markdownå·¥å…·æ æ ·å¼ */
        .markdown-toolbar {
            display: flex;
            flex-wrap: wrap;
            gap: 0.5rem;
            padding: 0.75rem;
            background: rgba(15, 23, 42, 0.5);
            border-radius: 0.75rem;
            margin-bottom: 1rem;
        }
        
        .markdown-toolbar button {
            padding: 0.5rem 0.75rem;
            background: rgba(30, 41, 59, 0.7);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 0.5rem;
            color: #cbd5e1;
            cursor: pointer;
            transition: all 0.2s ease;
            font-size: 0.875rem;
            display: flex;
            align-items: center;
            gap: 0.25rem;
        }
        
        .markdown-toolbar button:hover {
            background: rgba(59, 130, 246, 0.2);
            border-color: rgba(59, 130, 246, 0.3);
            color: #60a5fa;
        }
        
        .markdown-toolbar button i {
            font-size: 0.75rem;
        }
    </style>
</head>

<body class="min-h-screen selection:bg-blue-500/30">
    <!-- Toast é€šçŸ¥å®¹å™¨ -->
    <div id="toastContainer"></div>
    
    <!-- è®¤è¯æ¨¡æ€æ¡† -->
    <div id="authModal" class="fixed inset-0 z-50 flex items-center justify-center p-4 login-bg">
        <div class="glass w-full max-w-md p-10 rounded-[2.5rem] shadow-2xl space-y-8">
            <div class="text-center space-y-4">
                <div class="inline-flex p-4 bg-gradient-to-r from-blue-500 to-purple-600 rounded-full text-5xl">ğŸ”</div>
                <div class="space-y-2">
                    <h1 class="text-3xl font-extrabold tracking-tight italic">CloudNotes</h1>
                    <p class="text-slate-400 leading-relaxed text-sm">ç§æœ‰åŠ å¯†ç¬”è®°ä¸å¯¼èˆªç³»ç»Ÿ<br>è¯·è¾“å…¥è®¿é—®å¯†ç ä»¥ç»§ç»­</p>
                </div>
            </div>
            
            <div class="space-y-6">
                <div class="space-y-3">
                    <label class="text-xs uppercase tracking-widest text-slate-400 font-bold ml-1">
                        è®¿é—®å¯†ç 
                        <span id="attemptsCount" class="text-rose-500 text-xs ml-2">å‰©ä½™å°è¯•æ¬¡æ•°: 5</span>
                    </label>
                    <input id="authPassword" type="password" 
                           class="w-full bg-slate-900/70 border border-slate-700 p-5 rounded-2xl outline-none focus:ring-2 ring-blue-500/50 text-center font-mono text-lg"
                           placeholder="è¯·è¾“å…¥å¯†ç "
                           autocomplete="off"
                           onkeydown="if(event.key === 'Enter') checkPassword()">
                    <p class="text-xs text-slate-500 text-center">
                        æç¤ºï¼šè¯·åœ¨é…ç½®æ–‡ä»¶ä¸­è®¾ç½®è®¿é—®å¯†ç 
                    </p>
                </div>
                
                <button onclick="checkPassword()" id="verifyBtn"
                        class="w-full gradient-btn text-white py-5 rounded-2xl font-black tracking-widest uppercase text-sm shadow-xl hover:shadow-2xl transition-all">
                    éªŒè¯èº«ä»½
                </button>
                
                <div id="loadingSpinner" class="hidden text-center py-4">
                    <div class="loader mx-auto"></div>
                    <p class="text-slate-400 mt-4 text-sm">éªŒè¯ä¸­...</p>
                </div>
                
                <div class="pt-6 border-t border-white/5 text-center">
                    <p class="text-xs text-slate-500">
                        ğŸ”’ å®‰å…¨æç¤ºï¼šè¯·å‹¿åœ¨å…¬å…±è®¾å¤‡ä¸Šä¿å­˜å¯†ç 
                    </p>
                </div>
            </div>
        </div>
    </div>

    <!-- ä¸»åº”ç”¨å®¹å™¨ -->
    <div id="appContainer" class="hidden">
        <div id="app" class="max-w-6xl mx-auto px-4 py-8 md:py-12">
        </div>
    </div>

    <!-- å¿«é€Ÿè®¿é—®æ  -->
    <div id="quickAccessBar" class="quick-access-bar hidden">
        <button onclick="showAddNavLinkModal()" class="quick-access-btn nav-gradient text-white" title="æ·»åŠ å¯¼èˆªé“¾æ¥">
            <i class="fas fa-plus"></i>
        </button>
        <button onclick="showAddNoteModal()" class="quick-access-btn gradient-btn text-white" title="æ·»åŠ ç¬”è®°">
            <i class="fas fa-edit"></i>
        </button>
        <button onclick="scrollToTop()" class="quick-access-btn glass text-white" title="è¿”å›é¡¶éƒ¨">
            <i class="fas fa-arrow-up"></i>
        </button>
    </div>

    <!-- ç³»ç»Ÿé…ç½®æ¨¡æ€æ¡† -->
    <div id="settingsModal"
        class="fixed inset-0 bg-black/60 backdrop-blur-md z-50 flex items-center justify-center hidden p-4">
        <div class="glass w-full max-w-sm p-8 rounded-[2.5rem] shadow-2xl space-y-6 modal-enter">
            <h2 class="text-2xl font-extrabold tracking-tight">âš™ï¸ ç³»ç»Ÿé…ç½®</h2>
            <div class="space-y-4">
                <div class="space-y-1">
                    <label class="text-[10px] uppercase tracking-widest text-slate-400 font-bold ml-1">Worker
                        æœåŠ¡åœ°å€</label>
                    <input id="setApi" type="text" placeholder="https://..."
                        class="w-full bg-slate-900/50 border border-slate-700 p-4 rounded-2xl outline-none focus:ring-2 ring-blue-500/50 text-sm transition-all">
                </div>
                <div class="space-y-1">
                    <label class="text-[10px] uppercase tracking-widest text-slate-400 font-bold ml-1">ç®¡ç†å‘˜å¯†é’¥</label>
                    <input id="setKey" type="password" placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢"
                        class="w-full bg-slate-900/50 border border-slate-700 p-4 rounded-2xl outline-none focus:ring-2 ring-blue-500/50 text-sm transition-all">
                </div>
            </div>
            <div class="flex gap-3">
                <button onclick="closeSettings()"
                    class="flex-1 py-4 text-slate-400 font-semibold rounded-2xl hover:bg-slate-800 transition">å–æ¶ˆ</button>
                <button onclick="saveSettings()"
                    class="flex-1 py-4 gradient-btn text-white font-bold rounded-2xl">ä¿å­˜</button>
            </div>
        </div>
    </div>

    <!-- ç¼–è¾‘ç¬”è®°æ¨¡æ€æ¡† -->
    <div id="editModal"
        class="fixed inset-0 bg-black/60 backdrop-blur-md z-50 flex items-center justify-center hidden p-4">
        <div class="glass w-full max-w-4xl p-8 rounded-[2.5rem] shadow-2xl space-y-6 max-h-[95vh] overflow-hidden flex flex-col modal-enter">
            <h2 class="text-2xl font-extrabold tracking-tight flex items-center gap-2">
                <span class="text-blue-400">âœï¸</span> ç¼–è¾‘ç¬”è®°
                <span id="editNoteId" class="text-sm text-slate-400 ml-2 font-mono"></span>
            </h2>
            
            <div class="flex gap-2 mb-4">
                <button onclick="switchTab('edit')" class="tab-button active" id="editTabBtn">ç¼–è¾‘æ¨¡å¼</button>
                <button onclick="switchTab('preview')" class="tab-button" id="previewTabBtn">é¢„è§ˆæ¨¡å¼</button>
            </div>
            
            <div class="space-y-4 flex-1 overflow-hidden flex flex-col min-h-0">
                <div id="editTab" class="flex-1 flex flex-col min-h-0">
                    <div class="markdown-toolbar">
                        <button onclick="insertMarkdown('# ', 'æ ‡é¢˜')" title="ä¸€çº§æ ‡é¢˜">
                            <i class="fas fa-heading"></i> H1
                        </button>
                        <button onclick="insertMarkdown('## ', 'äºŒçº§æ ‡é¢˜')" title="äºŒçº§æ ‡é¢˜">
                            <i class="fas fa-heading"></i> H2
                        </button>
                        <button onclick="insertMarkdown('### ', 'ä¸‰çº§æ ‡é¢˜')" title="ä¸‰çº§æ ‡é¢˜">
                            <i class="fas fa-heading"></i> H3
                        </button>
                        <button onclick="insertMarkdown('**', 'ç²—ä½“æ–‡æœ¬')" title="ç²—ä½“">
                            <i class="fas fa-bold"></i>
                        </button>
                        <button onclick="insertMarkdown('*', 'æ–œä½“æ–‡æœ¬')" title="æ–œä½“">
                            <i class="fas fa-italic"></i>
                        </button>
                        <button onclick="insertMarkdown('~~', 'åˆ é™¤çº¿æ–‡æœ¬')" title="åˆ é™¤çº¿">
                            <i class="fas fa-strikethrough"></i>
                        </button>
                        <button onclick="insertMarkdown('- ', 'åˆ—è¡¨é¡¹')" title="æ— åºåˆ—è¡¨">
                            <i class="fas fa-list-ul"></i>
                        </button>
                        <button onclick="insertMarkdown('1. ', 'æœ‰åºåˆ—è¡¨')" title="æœ‰åºåˆ—è¡¨">
                            <i class="fas fa-list-ol"></i>
                        </button>
                        <button onclick="insertMarkdown('[é“¾æ¥æ–‡æœ¬](https://)', '')" title="é“¾æ¥">
                            <i class="fas fa-link"></i>
                        </button>
                        <button onclick="insertMarkdown('![æ›¿ä»£æ–‡æœ¬](https://)', '')" title="å›¾ç‰‡">
                            <i class="fas fa-image"></i>
                        </button>
                        <button onclick="insertMarkdown('> ', 'å¼•ç”¨æ–‡æœ¬')" title="å¼•ç”¨">
                            <i class="fas fa-quote-right"></i>
                        </button>
                        <button onclick="insertMarkdown('```javascript\n\n```', 'ä»£ç ')" title="ä»£ç å—">
                            <i class="fas fa-code"></i>
                        </button>
                        <button onclick="insertMarkdown('---\n', '')" title="åˆ†å‰²çº¿">
                            <i class="fas fa-minus"></i>
                        </button>
                        <button onclick="insertMarkdown('| è¡¨å¤´ | è¡¨å¤´ |\n|------|------|\n| å†…å®¹ | å†…å®¹ |', '')" title="è¡¨æ ¼">
                            <i class="fas fa-table"></i>
                        </button>
                        <button onclick="insertMarkdown('- [ ] ', 'ä»»åŠ¡é¡¹')" title="ä»»åŠ¡åˆ—è¡¨">
                            <i class="fas fa-tasks"></i>
                        </button>
                    </div>
                    
                    <div class="flex-1 min-h-0 border border-slate-800 rounded-2xl overflow-hidden bg-slate-950/50 relative">
                        <textarea id="editNoteContent" 
                            class="w-full h-full bg-transparent p-5 outline-none text-sm transition-all resize-none leading-relaxed font-mono min-h-[45vh] border-0"
                            placeholder="# æ ‡é¢˜&#10;&#10;## äºŒçº§æ ‡é¢˜&#10;&#10;- åˆ—è¡¨é¡¹&#10;- å¦ä¸€ä¸ªåˆ—è¡¨é¡¹&#10;&#10;**ç²—ä½“** *æ–œä½“* &#10;&#10;```javascript&#10;// ä»£ç å—&#10;console.log('Hello');&#10;```&#10;&#10;> å¼•ç”¨å†…å®¹&#10;&#10;| è¡¨å¤´1 | è¡¨å¤´2 |&#10;|--------|--------|&#10;| å•å…ƒæ ¼1 | å•å…ƒæ ¼2 |"></textarea>
                        
                        <div class="absolute bottom-3 right-4">
                            <div class="text-xs text-slate-500 bg-slate-900/70 px-2 py-1 rounded">
                                <span id="editCharCount">0</span> å­—ç¬¦
                            </div>
                        </div>
                    </div>
                </div>
                
                <div id="previewTab" class="flex-1 overflow-y-auto hidden min-h-0">
                    <div class="text-[10px] uppercase tracking-widest text-slate-400 font-bold ml-1 mb-2 block">
                        Markdown é¢„è§ˆ
                    </div>
                    <div id="markdownPreview" class="markdown-preview p-5 bg-slate-950/50 border border-slate-800 rounded-2xl flex-1 overflow-y-auto min-h-[60vh]">
                        <!-- é¢„è§ˆå†…å®¹å°†é€šè¿‡JSåŠ¨æ€å¡«å…… -->
                    </div>
                </div>
            </div>
            
            <div class="flex gap-3 pt-6 border-t border-white/5">
                <button onclick="closeEdit()"
                    class="flex-1 py-4 text-slate-400 font-semibold rounded-2xl hover:bg-slate-800 transition">
                    å–æ¶ˆ
                </button>
                <button onclick="saveEdit()"
                    class="flex-1 py-4 gradient-btn text-white font-bold rounded-2xl">
                    ä¿å­˜æ›´æ”¹
                </button>
            </div>
            
            <div class="pt-4 border-t border-white/5 text-xs text-slate-500">
                <p class="flex items-center gap-2">
                    <span class="text-yellow-400">âš ï¸</span>
                    æ³¨æ„ï¼šç¼–è¾‘åç¬”è®°å°†ä½¿ç”¨å½“å‰ä¸»å¯†ç é‡æ–°åŠ å¯†ä¿å­˜åˆ°äº‘ç«¯
                </p>
            </div>
        </div>
    </div>

    <!-- å¿«é€Ÿæ·»åŠ ç¬”è®°æ¨¡æ€æ¡† -->
    <div id="addNoteModal"
        class="fixed inset-0 bg-black/60 backdrop-blur-md z-50 flex items-center justify-center hidden p-4">
        <div class="glass w-full max-w-2xl p-8 rounded-[2.5rem] shadow-2xl space-y-6 modal-enter">
            <h2 class="text-2xl font-extrabold tracking-tight flex items-center gap-2">
                <span class="text-blue-400">ğŸ“</span> å¿«é€Ÿæ·»åŠ ç¬”è®°
            </h2>
            
            <div class="space-y-4">
                <div>
                    <label class="text-[10px] uppercase tracking-widest text-slate-400 font-bold ml-1 mb-2 block">
                        è§£å¯†ä¸»å¯†ç 
                    </label>
                    <input id="quickMainPw" type="password" placeholder="è¾“å…¥ä¸»å¯†ç ä»¥åŠ å¯†" 
                        class="w-full bg-slate-950/50 border border-slate-800 p-4 rounded-2xl outline-none focus:ring-2 ring-blue-500/50 transition-all font-mono">
                </div>
                
                <div>
                    <label class="text-[10px] uppercase tracking-widest text-slate-400 font-bold ml-1 mb-2 block">
                        ç¬”è®°å†…å®¹
                    </label>
                    <textarea id="quickNoteInput" placeholder="è¾“å…¥ç¬”è®°å†…å®¹..." 
                        class="w-full bg-slate-950/50 border border-slate-800 p-4 h-40 rounded-2xl outline-none focus:bg-slate-950 transition-all resize-none leading-relaxed"></textarea>
                    <div class="flex items-center gap-2 text-xs text-slate-500 mt-2">
                        <span id="quickNoteCharCount">0</span> å­—ç¬¦
                    </div>
                </div>
            </div>
            
            <div class="flex gap-3">
                <button onclick="closeAddNoteModal()"
                    class="flex-1 py-4 text-slate-400 font-semibold rounded-2xl hover:bg-slate-800 transition">
                    å–æ¶ˆ
                </button>
                <button onclick="quickSaveNote()"
                    class="flex-1 py-4 gradient-btn text-white font-bold rounded-2xl">
                    ä¿å­˜ç¬”è®°
                </button>
            </div>
        </div>
    </div>

    <!-- æ·»åŠ å¯¼èˆªé“¾æ¥æ¨¡æ€æ¡† -->
    <div id="addNavLinkModal"
        class="fixed inset-0 bg-black/60 backdrop-blur-md z-50 flex items-center justify-center hidden p-4">
        <div class="glass w-full max-w-md p-8 rounded-[2.5rem] shadow-2xl space-y-6 modal-enter">
            <h2 class="text-2xl font-extrabold tracking-tight flex items-center gap-2">
                <span class="text-purple-400">ğŸ”—</span> æ·»åŠ å¯¼èˆªé“¾æ¥
            </h2>
            
            <div class="space-y-4">
                <div>
                    <label class="text-[10px] uppercase tracking-widest text-slate-400 font-bold ml-1 mb-2 block">
                        é“¾æ¥æ ‡é¢˜
                    </label>
                    <input id="navLinkTitle" type="text" placeholder="ä¾‹å¦‚ï¼šGitHub" 
                        class="w-full bg-slate-950/50 border border-slate-800 p-4 rounded-2xl outline-none focus:ring-2 ring-purple-500/50 transition-all">
                </div>
                
                <div>
                    <label class="text-[10px] uppercase tracking-widest text-slate-400 font-bold ml-1 mb-2 block">
                        é“¾æ¥åœ°å€
                    </label>
                    <input id="navLinkUrl" type="text" placeholder="https://..." 
                        class="w-full bg-slate-950/50 border border-slate-800 p-4 rounded-2xl outline-none focus:ring-2 ring-purple-500/50 transition-all font-mono text-sm">
                </div>
                
                <div>
                    <label class="text-[10px] uppercase tracking-widest text-slate-400 font-bold ml-1 mb-2 block">
                        åˆ†ç±»æ ‡ç­¾
                    </label>
                    <div class="flex flex-wrap gap-2 mb-2">
                        <button onclick="setNavCategory('å¼€å‘å·¥å…·')" class="px-3 py-1 bg-blue-900/30 text-blue-400 rounded-lg hover:bg-blue-800/50 transition text-xs">å¼€å‘å·¥å…·</button>
                        <button onclick="setNavCategory('æ—¥å¸¸æ•ˆç‡')" class="px-3 py-1 bg-green-900/30 text-green-400 rounded-lg hover:bg-green-800/50 transition text-xs">æ—¥å¸¸æ•ˆç‡</button>
                        <button onclick="setNavCategory('è®¾è®¡èµ„æº')" class="px-3 py-1 bg-purple-900/30 text-purple-400 rounded-lg hover:bg-purple-800/50 transition text-xs">è®¾è®¡èµ„æº</button>
                        <button onclick="setNavCategory('å­¦ä¹ èµ„æº')" class="px-3 py-1 bg-yellow-900/30 text-yellow-400 rounded-lg hover:bg-yellow-800/50 transition text-xs">å­¦ä¹ èµ„æº</button>
                        <button onclick="setNavCategory('ç¤¾äº¤å¨±ä¹')" class="px-3 py-1 bg-pink-900/30 text-pink-400 rounded-lg hover:bg-pink-800/50 transition text-xs">ç¤¾äº¤å¨±ä¹</button>
                    </div>
                    <input id="navLinkCategory" type="text" placeholder="è‡ªå®šä¹‰åˆ†ç±»æˆ–é€‰æ‹©ä¸Šæ–¹æ ‡ç­¾" 
                        class="w-full bg-slate-950/50 border border-slate-800 p-4 rounded-2xl outline-none focus:ring-2 ring-purple-500/50 transition-all">
                </div>
                
                <div>
                    <label class="text-[10px] uppercase tracking-widest text-slate-400 font-bold ml-1 mb-2 block">
                        å›¾æ ‡é€‰æ‹©
                    </label>
                    <div class="flex flex-wrap gap-3 mb-2">
                        <button onclick="setNavIcon('fas fa-globe', 'icon-blue')" class="p-2 bg-slate-800 rounded-lg hover:bg-slate-700 transition"><i class="fas fa-globe icon-blue"></i></button>
                        <button onclick="setNavIcon('fas fa-code', 'icon-green')" class="p-2 bg-slate-800 rounded-lg hover:bg-slate-700 transition"><i class="fas fa-code icon-green"></i></button>
                        <button onclick="setNavIcon('fas fa-tools', 'icon-yellow')" class="p-2 bg-slate-800 rounded-lg hover:bg-slate-700 transition"><i class="fas fa-tools icon-yellow"></i></button>
                        <button onclick="setNavIcon('fas fa-palette', 'icon-purple')" class="p-2 bg-slate-800 rounded-lg hover:bg-slate-700 transition"><i class="fas fa-palette icon-purple"></i></button>
                        <button onclick="setNavIcon('fas fa-book', 'icon-indigo')" class="p-2 bg-slate-800 rounded-lg hover:bg-slate-700 transition"><i class="fas fa-book icon-indigo"></i></button>
                        <button onclick="setNavIcon('fas fa-film', 'icon-pink')" class="p-2 bg-slate-800 rounded-lg hover:bg-slate-700 transition"><i class="fas fa-film icon-pink"></i></button>
                    </div>
                    <input id="navLinkIcon" type="hidden" value="fas fa-globe">
                    <input id="navLinkIconColor" type="hidden" value="icon-blue">
                </div>
                
                <div>
                    <label class="text-[10px] uppercase tracking-widest text-slate-400 font-bold ml-1 mb-2 block">
                        æè¿°ï¼ˆå¯é€‰ï¼‰
                    </label>
                    <textarea id="navLinkDescription" placeholder="é“¾æ¥çš„ç®€è¦æè¿°..." 
                        class="w-full bg-slate-950/50 border border-slate-800 p-4 h-24 rounded-2xl outline-none focus:bg-slate-950 transition-all resize-none"></textarea>
                </div>
            </div>
            
            <div class="flex gap-3">
                <button onclick="closeAddNavLinkModal()"
                    class="flex-1 py-4 text-slate-400 font-semibold rounded-2xl hover:bg-slate-800 transition">
                    å–æ¶ˆ
                </button>
                <button onclick="saveNavLink()"
                    class="flex-1 py-4 nav-gradient text-white font-bold rounded-2xl">
                    ä¿å­˜é“¾æ¥
                </button>
            </div>
        </div>
    </div>

    <!-- ç¼–è¾‘å¯¼èˆªé“¾æ¥æ¨¡æ€æ¡† -->
    <div id="editNavLinkModal"
        class="fixed inset-0 bg-black/60 backdrop-blur-md z-50 flex items-center justify-center hidden p-4">
        <div class="glass w-full max-w-md p-8 rounded-[2.5rem] shadow-2xl space-y-6 modal-enter">
            <h2 class="text-2xl font-extrabold tracking-tight flex items-center gap-2">
                <span class="text-purple-400">âœï¸</span> ç¼–è¾‘å¯¼èˆªé“¾æ¥
                <span id="editNavLinkId" class="text-sm text-slate-400 ml-2 font-mono"></span>
            </h2>
            
            <div class="space-y-4">
                <div>
                    <label class="text-[10px] uppercase tracking-widest text-slate-400 font-bold ml-1 mb-2 block">
                        é“¾æ¥æ ‡é¢˜
                    </label>
                    <input id="editNavLinkTitle" type="text" placeholder="ä¾‹å¦‚ï¼šGitHub" 
                        class="w-full bg-slate-950/50 border border-slate-800 p-4 rounded-2xl outline-none focus:ring-2 ring-purple-500/50 transition-all">
                </div>
                
                <div>
                    <label class="text-[10px] uppercase tracking-widest text-slate-400 font-bold ml-1 mb-2 block">
                        é“¾æ¥åœ°å€
                    </label>
                    <input id="editNavLinkUrl" type="text" placeholder="https://..." 
                        class="w-full bg-slate-950/50 border border-slate-800 p-4 rounded-2xl outline-none focus:ring-2 ring-purple-500/50 transition-all font-mono text-sm">
                </div>
                
                <div>
                    <label class="text-[10px] uppercase tracking-widest text-slate-400 font-bold ml-1 mb-2 block">
                        åˆ†ç±»æ ‡ç­¾
                    </label>
                    <div class="flex flex-wrap gap-2 mb-2">
                        <button onclick="setEditNavCategory('å¼€å‘å·¥å…·')" class="px-3 py-1 bg-blue-900/30 text-blue-400 rounded-lg hover:bg-blue-800/50 transition text-xs">å¼€å‘å·¥å…·</button>
                        <button onclick="setEditNavCategory('æ—¥å¸¸æ•ˆç‡')" class="px-3 py-1 bg-green-900/30 text-green-400 rounded-lg hover:bg-green-800/50 transition text-xs">æ—¥å¸¸æ•ˆç‡</button>
                        <button onclick="setEditNavCategory('è®¾è®¡èµ„æº')" class="px-3 py-1 bg-purple-900/30 text-purple-400 rounded-lg hover:bg-purple-800/50 transition text-xs">è®¾è®¡èµ„æº</button>
                        <button onclick="setEditNavCategory('å­¦ä¹ èµ„æº')" class="px-3 py-1 bg-yellow-900/30 text-yellow-400 rounded-lg hover:bg-yellow-800/50 transition text-xs">å­¦ä¹ èµ„æº</button>
                        <button onclick="setEditNavCategory('ç¤¾äº¤å¨±ä¹')" class="px-3 py-1 bg-pink-900/30 text-pink-400 rounded-lg hover:bg-pink-800/50 transition text-xs">ç¤¾äº¤å¨±ä¹</button>
                    </div>
                    <input id="editNavLinkCategory" type="text" placeholder="è‡ªå®šä¹‰åˆ†ç±»æˆ–é€‰æ‹©ä¸Šæ–¹æ ‡ç­¾" 
                        class="w-full bg-slate-950/50 border border-slate-800 p-4 rounded-2xl outline-none focus:ring-2 ring-purple-500/50 transition-all">
                </div>
                
                <div>
                    <label class="text-[10px] uppercase tracking-widest text-slate-400 font-bold ml-1 mb-2 block">
                        å›¾æ ‡é€‰æ‹©
                    </label>
                    <div class="flex flex-wrap gap-3 mb-2">
                        <button onclick="setEditNavIcon('fas fa-globe', 'icon-blue')" class="p-2 bg-slate-800 rounded-lg hover:bg-slate-700 transition"><i class="fas fa-globe icon-blue"></i></button>
                        <button onclick="setEditNavIcon('fas fa-code', 'icon-green')" class="p-2 bg-slate-800 rounded-lg hover:bg-slate-700 transition"><i class="fas fa-code icon-green"></i></button>
                        <button onclick="setEditNavIcon('fas fa-tools', 'icon-yellow')" class="p-2 bg-slate-800 rounded-lg hover:bg-slate-700 transition"><i class="fas fa-tools icon-yellow"></i></button>
                        <button onclick="setEditNavIcon('fas fa-palette', 'icon-purple')" class="p-2 bg-slate-800 rounded-lg hover:bg-slate-700 transition"><i class="fas fa-palette icon-purple"></i></button>
                        <button onclick="setEditNavIcon('fas fa-book', 'icon-indigo')" class="p-2 bg-slate-800 rounded-lg hover:bg-slate-700 transition"><i class="fas fa-book icon-indigo"></i></button>
                        <button onclick="setEditNavIcon('fas fa-film', 'icon-pink')" class="p-2 bg-slate-800 rounded-lg hover:bg-slate-700 transition"><i class="fas fa-film icon-pink"></i></button>
                    </div>
                    <div id="editNavIconPreview" class="text-center py-2">
                    </div>
                    <input id="editNavLinkIcon" type="hidden">
                    <input id="editNavLinkIconColor" type="hidden">
                </div>
                
                <div>
                    <label class="text-[10px] uppercase tracking-widest text-slate-400 font-bold ml-1 mb-2 block">
                        æè¿°ï¼ˆå¯é€‰ï¼‰
                    </label>
                    <textarea id="editNavLinkDescription" placeholder="é“¾æ¥çš„ç®€è¦æè¿°..." 
                        class="w-full bg-slate-950/50 border border-slate-800 p-4 h-24 rounded-2xl outline-none focus:bg-slate-950 transition-all resize-none"></textarea>
                </div>
            </div>
            
            <div class="flex gap-3">
                <button onclick="closeEditNavLinkModal()"
                    class="flex-1 py-4 text-slate-400 font-semibold rounded-2xl hover:bg-slate-800 transition">
                    å–æ¶ˆ
                </button>
                <button onclick="updateNavLink()"
                    class="flex-1 py-4 nav-gradient text-white font-bold rounded-2xl">
                    æ›´æ–°é“¾æ¥
                </button>
            </div>
            
            <div class="pt-4 border-t border-white/5">
                <button onclick="confirmDeleteNavLink()" class="w-full py-3 bg-rose-900/30 text-rose-400 rounded-2xl hover:bg-rose-800/50 transition font-semibold">
                    ğŸ—‘ï¸ åˆ é™¤æ­¤é“¾æ¥
                </button>
            </div>
        </div>
    </div>

    <script>
        // ==================== ç³»ç»Ÿé…ç½® ====================
        const urlParams = new URLSearchParams(window.location.search);
        let apiFromUrl = urlParams.get('api');
        const cfgFromUrl = urlParams.get('cfg');
        if (cfgFromUrl) { 
            try { 
                apiFromUrl = atob(cfgFromUrl); 
            } catch (e) { 
                console.error('è§£ç é…ç½®å¤±è´¥:', e);
            } 
        }
        const shareId = urlParams.get('share');

        let API_URL = apiFromUrl || localStorage.getItem('cf_notes_api') || "";
        let ADMIN_KEY = localStorage.getItem('cf_notes_key') || "";

        let currentEditId = null;
        let currentEditNavLinkId = null;
        
        let notesCache = {};
        let navLinksCache = {};
        let currentView = 'notes';

        const app = document.getElementById('app');

        // ==================== å®‰å…¨é…ç½® ====================
        const SESSION_KEY = 'cloudnotes_auth_token';
        const SESSION_EXPIRY = 8 * 60 * 60 * 1000; // 8å°æ—¶
        const ATTEMPTS_KEY = 'cloudnotes_auth_attempts';
        const MAX_ATTEMPTS = 5;
        const LOCKOUT_TIME = 5 * 60 * 1000; // 5åˆ†é’Ÿ
        const LOCKOUT_KEY = 'cloudnotes_lockout_until';

        // ==================== åŠ è§£å¯†é€»è¾‘ ====================
        async function getKey(password) {
            const encoder = new TextEncoder();
            const hash = await crypto.subtle.digest('SHA-256', encoder.encode(password));
            return await crypto.subtle.importKey('raw', hash, { name: 'AES-GCM' }, false, ['encrypt', 'decrypt']);
        }
        
        async function encrypt(text, password) {
            try {
                const encoder = new TextEncoder(); 
                const iv = crypto.getRandomValues(new Uint8Array(12)); 
                const key = await getKey(password);
                const encrypted = await crypto.subtle.encrypt({ 
                    name: 'AES-GCM', 
                    iv: iv 
                }, key, encoder.encode(text));
                
                return btoa(JSON.stringify({
                    iv: Array.from(iv),
                    data: Array.from(new Uint8Array(encrypted))
                }));
            } catch (error) {
                console.error('åŠ å¯†å¤±è´¥:', error);
                throw new Error('åŠ å¯†å¤±è´¥');
            }
        }
        
        async function decrypt(encryptedData, password) {
            try {
                const { iv, data } = JSON.parse(atob(encryptedData)); 
                const key = await getKey(password);
                const decrypted = await crypto.subtle.decrypt(
                    { 
                        name: 'AES-GCM', 
                        iv: new Uint8Array(iv) 
                    }, 
                    key, 
                    new Uint8Array(data)
                );
                return new TextDecoder().decode(decrypted);
            } catch (error) {
                console.error('è§£å¯†å¤±è´¥:', error);
                return null;
            }
        }

        // Markdown é…ç½®
        marked.setOptions({
            breaks: true,
            gfm: true,
            pedantic: false,
            smartLists: true,
            smartypants: true,
            xhtml: false,
            highlight: function(code, lang) {
                if (lang && hljs.getLanguage(lang)) {
                    try {
                        return hljs.highlight(code, { language: lang }).value;
                    } catch (__) {}
                }
                return hljs.highlightAuto(code).value;
            }
        });

        // ==================== å®‰å…¨éªŒè¯å‡½æ•° ====================
        function checkLockout() {
            const lockoutUntil = localStorage.getItem(LOCKOUT_KEY);
            if (lockoutUntil && Date.now() < parseInt(lockoutUntil)) {
                const remainingMinutes = Math.ceil((parseInt(lockoutUntil) - Date.now()) / 60000);
                return {
                    locked: true,
                    remainingMinutes: remainingMinutes
                };
            }
            return { locked: false };
        }
        
        function setLockout() {
            const lockoutUntil = Date.now() + LOCKOUT_TIME;
            localStorage.setItem(LOCKOUT_KEY, lockoutUntil.toString());
            
            setTimeout(() => {
                localStorage.removeItem(LOCKOUT_KEY);
                localStorage.removeItem(ATTEMPTS_KEY);
                document.getElementById('authPassword').disabled = false;
                document.getElementById('verifyBtn').disabled = false;
                document.getElementById('attemptsCount').textContent = 'å‰©ä½™å°è¯•æ¬¡æ•°: 5';
            }, LOCKOUT_TIME);
        }
        
        function getRemainingAttempts() {
            const attempts = localStorage.getItem(ATTEMPTS_KEY);
            return attempts ? MAX_ATTEMPTS - parseInt(attempts) : MAX_ATTEMPTS;
        }
        
        function incrementFailedAttempts() {
            let attempts = localStorage.getItem(ATTEMPTS_KEY);
            attempts = attempts ? parseInt(attempts) + 1 : 1;
            localStorage.setItem(ATTEMPTS_KEY, attempts.toString());
            
            if (attempts >= MAX_ATTEMPTS) {
                setLockout();
            }
            
            return attempts;
        }
        
        function resetFailedAttempts() {
            localStorage.removeItem(ATTEMPTS_KEY);
            localStorage.removeItem(LOCKOUT_KEY);
        }
        
        // ==================== ä¸»éªŒè¯å‡½æ•° ====================
        async function checkPassword() {
            const lockoutCheck = checkLockout();
            const input = document.getElementById('authPassword');
            const attemptsCount = document.getElementById('attemptsCount');
            const verifyBtn = document.getElementById('verifyBtn');
            const loadingSpinner = document.getElementById('loadingSpinner');
            
            // æ£€æŸ¥æ˜¯å¦è¢«é”å®š
            if (lockoutCheck.locked) {
                attemptsCount.innerHTML = `è´¦æˆ·å·²é”å®šï¼Œ${lockoutCheck.remainingMinutes}åˆ†é’Ÿåé‡è¯•`;
                input.value = '';
                input.classList.add('login-shake');
                input.disabled = true;
                verifyBtn.disabled = true;
                setTimeout(() => input.classList.remove('login-shake'), 500);
                return;
            }
            
            const password = input.value.trim();
            const remainingAttempts = getRemainingAttempts() - 1;
            
            // æ£€æŸ¥å¯†ç æ˜¯å¦ä¸ºç©º
            if (!password) {
                attemptsCount.innerHTML = 'å¯†ç ä¸èƒ½ä¸ºç©º';
                input.classList.add('login-shake');
                setTimeout(() => {
                    input.classList.remove('login-shake');
                    attemptsCount.innerHTML = `å‰©ä½™å°è¯•æ¬¡æ•°: ${remainingAttempts + 1}`;
                }, 500);
                return;
            }
            
            // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
            verifyBtn.classList.add('hidden');
            loadingSpinner.classList.remove('hidden');
            input.disabled = true;
            
            try {
                console.log('å¼€å§‹éªŒè¯å¯†ç ...');
                
                // å¦‚æœAPI_URLæœªè®¾ç½®ï¼Œç›´æ¥ä½¿ç”¨æœ¬åœ°å­˜å‚¨çš„ä¸»å¯†ç éªŒè¯
                if (!API_URL) {
                    const storedPassword = localStorage.getItem('master_password');
                    
                    if (password === storedPassword || (storedPassword && await simpleVerifyPassword(password))) {
                        // éªŒè¯æˆåŠŸ
                        const token = btoa(Date.now() + '-' + Math.random().toString(36).substr(2, 9));
                        sessionStorage.setItem(SESSION_KEY, token);
                        
                        resetFailedAttempts();
                        
                        document.getElementById('authModal').classList.add('hidden');
                        document.getElementById('appContainer').classList.remove('hidden');
                        
                        // ä¿å­˜å¯†ç åˆ°æœ¬åœ°ï¼ˆå¯é€‰ï¼‰
                        if (!storedPassword) {
                            localStorage.setItem('master_password', password);
                        }
                        
                        initApp();
                        return;
                    } else {
                        throw new Error('å¯†ç é”™è¯¯');
                    }
                }
                
                // ä½¿ç”¨APIéªŒè¯
                const response = await fetch(`${API_URL}/api/verify-password`, {
                    method: 'POST',
                    headers: { 
                        'Content-Type': 'application/json',
                        'Authorization': ADMIN_KEY
                    },
                    body: JSON.stringify({ password: password })
                });
                
                console.log('APIå“åº”çŠ¶æ€:', response.status);
                
                if (response.ok) {
                    const result = await response.json();
                    console.log('APIå“åº”æ•°æ®:', result);
                    
                    if (result.success) {
                        // éªŒè¯æˆåŠŸ
                        const token = btoa(Date.now() + '-' + Math.random().toString(36).substr(2, 9));
                        sessionStorage.setItem(SESSION_KEY, token);
                        
                        resetFailedAttempts();
                        
                        document.getElementById('authModal').classList.add('hidden');
                        document.getElementById('appContainer').classList.remove('hidden');
                        
                        initApp();
                    } else {
                        throw new Error(result.error || 'å¯†ç é”™è¯¯');
                    }
                } else {
                    // APIé”™è¯¯ï¼Œå°è¯•æœ¬åœ°éªŒè¯
                    console.log('APIéªŒè¯å¤±è´¥ï¼Œå°è¯•æœ¬åœ°éªŒè¯...');
                    const storedPassword = localStorage.getItem('master_password');
                    
                    if (password === storedPassword) {
                        // æœ¬åœ°éªŒè¯æˆåŠŸ
                        const token = btoa(Date.now() + '-' + Math.random().toString(36).substr(2, 9));
                        sessionStorage.setItem(SESSION_KEY, token);
                        
                        resetFailedAttempts();
                        
                        document.getElementById('authModal').classList.add('hidden');
                        document.getElementById('appContainer').classList.remove('hidden');
                        
                        initApp();
                    } else {
                        throw new Error('APIè¿æ¥å¤±è´¥ä¸”æœ¬åœ°éªŒè¯å¤±è´¥');
                    }
                }
            } catch (error) {
                console.error("éªŒè¯å¤±è´¥:", error);
                
                const attempts = incrementFailedAttempts();
                const newRemaining = MAX_ATTEMPTS - attempts;
                
                if (attempts >= MAX_ATTEMPTS) {
                    attemptsCount.innerHTML = 'è´¦æˆ·å·²é”å®šï¼Œ5åˆ†é’Ÿåé‡è¯•';
                    setLockout();
                } else {
                    attemptsCount.innerHTML = `å¯†ç é”™è¯¯ï¼Œå‰©ä½™å°è¯•æ¬¡æ•°: ${newRemaining}`;
                }
                
                input.value = '';
                input.classList.add('login-shake');
                setTimeout(() => input.classList.remove('login-shake'), 500);
            } finally {
                verifyBtn.classList.remove('hidden');
                loadingSpinner.classList.add('hidden');
                input.disabled = false;
                input.focus();
            }
        }
        
        // ç®€å•çš„å¯†ç éªŒè¯ï¼ˆç”¨äºæœ¬åœ°éªŒè¯ï¼‰
        async function simpleVerifyPassword(password) {
            // è¿™é‡Œå¯ä»¥æ·»åŠ æ›´å¤æ‚çš„æœ¬åœ°éªŒè¯é€»è¾‘
            // ä¾‹å¦‚ï¼šæ£€æŸ¥å¯†ç çš„å“ˆå¸Œå€¼
            const encoder = new TextEncoder();
            const data = encoder.encode(password);
            const hashBuffer = await crypto.subtle.digest('SHA-256', data);
            const hashArray = Array.from(new Uint8Array(hashBuffer));
            const hashHex = hashArray.map(b => b.toString(16).padStart(2, '0')).join('');
            
            const storedHash = localStorage.getItem('password_hash');
            
            if (storedHash) {
                return hashHex === storedHash;
            } else {
                // ç¬¬ä¸€æ¬¡ä½¿ç”¨ï¼Œä¿å­˜å“ˆå¸Œå€¼
                localStorage.setItem('password_hash', hashHex);
                return true;
            }
        }
        
        // ç™»å‡º
        function logout() {
            sessionStorage.removeItem(SESSION_KEY);
            localStorage.removeItem(ATTEMPTS_KEY);
            localStorage.removeItem(LOCKOUT_KEY);
            location.reload();
        }
        
        // ==================== åº”ç”¨åˆå§‹åŒ–é€»è¾‘ ====================
        function initApp() {
            console.log('åˆå§‹åŒ–åº”ç”¨...');
            
            if (shareId) {
                renderShareView();
            } else if (!API_URL) {
                renderWelcomeView();
            } else {
                renderMainView();
            }
        }
        
        // æ£€æŸ¥ä¼šè¯
        function checkSession() {
            console.log('æ£€æŸ¥ä¼šè¯...');
            
            const token = sessionStorage.getItem(SESSION_KEY);
            const apiUrl = localStorage.getItem('cf_notes_api');
            
            // å¦‚æœæœ‰åˆ†äº«IDï¼Œç›´æ¥æ˜¾ç¤ºåˆ†äº«é¡µé¢
            if (shareId) {
                console.log('æ˜¾ç¤ºåˆ†äº«é¡µé¢');
                document.getElementById('authModal').classList.add('hidden');
                document.getElementById('appContainer').classList.remove('hidden');
                initApp();
                return true;
            }
            
            // å¦‚æœæ²¡æœ‰API URLï¼Œæ˜¾ç¤ºæ¬¢è¿é¡µé¢
            if (!apiUrl) {
                console.log('æ²¡æœ‰API URLï¼Œæ˜¾ç¤ºæ¬¢è¿é¡µé¢');
                document.getElementById('authModal').classList.add('hidden');
                document.getElementById('appContainer').classList.remove('hidden');
                initApp();
                return false;
            }
            
            // æ£€æŸ¥ä¼šè¯ä»¤ç‰Œ
            if (token) {
                try {
                    const parts = atob(token).split('-');
                    if (parts.length === 2) {
                        const timestamp = parseInt(parts[0]);
                        const now = Date.now();
                        if (now - timestamp < SESSION_EXPIRY) {
                            console.log('ä¼šè¯æœ‰æ•ˆï¼Œæ˜¾ç¤ºä¸»åº”ç”¨');
                            document.getElementById('authModal').classList.add('hidden');
                            document.getElementById('appContainer').classList.remove('hidden');
                            initApp();
                            return true;
                        }
                    }
                } catch (e) {
                    console.error('TokenéªŒè¯å¤±è´¥:', e);
                }
            }
            
            console.log('éœ€è¦é‡æ–°è®¤è¯');
            // éœ€è¦é‡æ–°è®¤è¯
            document.getElementById('authModal').classList.remove('hidden');
            document.getElementById('appContainer').classList.add('hidden');
            
            const lockoutCheck = checkLockout();
            if (lockoutCheck.locked) {
                const attemptsCount = document.getElementById('attemptsCount');
                attemptsCount.innerHTML = `è´¦æˆ·å·²é”å®šï¼Œ${lockoutCheck.remainingMinutes}åˆ†é’Ÿåé‡è¯•`;
                document.getElementById('authPassword').disabled = true;
                document.getElementById('verifyBtn').disabled = true;
            } else {
                const remaining = getRemainingAttempts();
                const attemptsCount = document.getElementById('attemptsCount');
                attemptsCount.innerHTML = `å‰©ä½™å°è¯•æ¬¡æ•°: ${remaining}`;
                document.getElementById('authPassword').disabled = false;
                document.getElementById('verifyBtn').disabled = false;
                document.getElementById('authPassword').focus();
            }
            
            return false;
        }

        // ==================== è§†å›¾æ¸²æŸ“å‡½æ•° ====================
        function renderWelcomeView() {
            app.innerHTML = `
            <div class="glass p-12 rounded-[3rem] text-center space-y-8 animate-in fade-in zoom-in duration-700">
                <div class="inline-flex p-5 bg-gradient-to-r from-blue-500 to-purple-600 rounded-full text-5xl">ğŸš€</div>
                <div class="space-y-2">
                    <h1 class="text-4xl font-extrabold tracking-tight italic">CloudNotes</h1>
                    <p class="text-slate-400 leading-relaxed">æ‚¨çš„ä¸“å±åŠ å¯†ç¬”è®°ä¸ä¸ªäººå¯¼èˆªç³»ç»Ÿ<br>è¯·å…ˆå…³è”æ‚¨çš„ Cloudflare Worker åç«¯</p>
                </div>
                <button onclick="configUrl()" class="px-10 py-5 gradient-btn text-white font-black rounded-3xl shadow-2xl">åˆå§‹åŒ–é…ç½®</button>
            </div>
        `;
        }

        function renderMainView() {
            app.innerHTML = `
            <div class="space-y-12 animate-in fade-in slide-in-from-bottom-4 duration-700">
                <header class="flex justify-between items-end">
                    <div class="space-y-1">
                        <h1 class="text-4xl font-extrabold tracking-tighter bg-gradient-to-r from-white to-slate-500 bg-clip-text text-transparent">CloudNotes</h1>
                        <p class="text-[10px] uppercase tracking-[0.3em] text-blue-500 font-black">ç«¯åˆ°ç«¯åŠ å¯†ç¬”è®° | ä¸ªäººå¯¼èˆªä¸­å¿ƒ</p>
                    </div>
                    <div class="flex items-center gap-4">
                        <div class="flex gap-2">
                            <button onclick="switchView('notes')" class="px-4 py-2 rounded-xl ${currentView === 'notes' ? 'gradient-btn text-white' : 'glass text-slate-400'} transition">ğŸ“ ç¬”è®°</button>
                            <button onclick="switchView('nav')" class="px-4 py-2 rounded-xl ${currentView === 'nav' ? 'nav-gradient text-white' : 'glass text-slate-400'} transition">ğŸ”— å¯¼èˆª</button>
                        </div>
                        <button onclick="logout()" class="text-xs text-slate-400 hover:text-white transition px-3 py-1 glass rounded-full" title="é€€å‡ºç™»å½•">
                            é€€å‡º
                        </button>
                        <button onclick="configUrl()" class="p-4 glass rounded-2xl hover:rotate-180 transition-all duration-500 text-xl">âš™ï¸</button>
                    </div>
                </header>

                <div id="notesView" class="${currentView === 'notes' ? '' : 'hidden'}">
                    <main class="glass p-8 rounded-[2.5rem] shadow-2xl space-y-6 border-white/5 mb-8">
                        <div class="space-y-4">
                            <div>
                                <label class="text-[10px] uppercase tracking-widest text-slate-400 font-bold ml-1 mb-2 block">
                                    è§£å¯†ä¸»å¯†ç 
                                </label>
                                <input id="mainPw" type="password" placeholder="è¾“å…¥ä¸»å¯†ç ä»¥åŠ å¯†/è§£å¯†æ•°æ®" 
                                    class="w-full bg-slate-950/50 border border-slate-800 p-4 rounded-2xl outline-none focus:ring-2 ring-blue-500/50 transition-all font-mono">
                            </div>
                            
                            <div>
                                <div class="flex justify-between items-center mb-2">
                                    <label class="text-[10px] uppercase tracking-widest text-slate-400 font-bold ml-1 block">
                                        ç¬”è®°å†…å®¹ (æ”¯æŒ Markdown æ ¼å¼)
                                    </label>
                                    <button onclick="showMarkdownHelp()" class="text-xs text-blue-400 hover:text-blue-300 transition">ğŸ“– Markdown è¯­æ³•å¸®åŠ©</button>
                                </div>
                                <textarea id="noteInput" placeholder="# è¾“å…¥æ‚¨çš„ Markdown ç¬”è®°...&#10;&#10;## æ”¯æŒåŠŸèƒ½&#10;- æ ‡é¢˜ã€åˆ—è¡¨ã€ä»£ç å—&#10;- **ç²—ä½“**ã€*æ–œä½“*ã€[é“¾æ¥]()&#10;- è¡¨æ ¼ã€å¼•ç”¨ã€åˆ†å‰²çº¿" 
                                    class="w-full bg-slate-950/50 border border-slate-800 p-5 h-64 rounded-2xl outline-none focus:bg-slate-950 transition-all resize-none leading-relaxed font-mono"></textarea>
                                <div class="flex items-center gap-2 text-xs text-slate-500 mt-2">
                                    <span id="noteCharCount">0</span> å­—ç¬¦
                                </div>
                            </div>
                        </div>
                        
                        <div class="grid grid-cols-2 gap-4">
                            <button onclick="doSave()" class="gradient-btn text-white py-5 rounded-2xl font-black tracking-widest uppercase text-xs hover:shadow-lg transition">åŠ å¯†å­˜å…¥äº‘ç«¯</button>
                            <button onclick="doAI()" class="glass text-purple-400 py-5 rounded-2xl font-black tracking-widest uppercase text-xs hover:bg-purple-500/10 transition border-purple-500/20">âœ¨ AI æ™ºèƒ½æ€»ç»“</button>
                        </div>
                    </main>

                    <section class="space-y-6">
                        <div class="flex justify-between items-center px-4">
                            <h2 class="text-xs font-black uppercase tracking-[0.2em] text-slate-500 italic">Vault / æˆ‘çš„åŠ å¯†åº“</h2>
                            <div class="flex gap-2">
                                <button onclick="showMarkdownHelp()" class="text-blue-400 text-xs font-black hover:underline">Markdown è¯­æ³•</button>
                                <button onclick="loadNotesList()" class="text-blue-500 text-xs font-black hover:underline uppercase">åˆ·æ–°åˆ—è¡¨</button>
                            </div>
                        </div>
                        <div id="notesList" class="space-y-6">
                            <div class="text-center py-20 text-slate-600 italic text-sm">é…ç½®å®Œæˆåè¾“å…¥å¯†ç å¹¶ç‚¹å‡»åˆ·æ–°ã€‚</div>
                        </div>
                    </section>
                </div>

                <div id="navView" class="${currentView === 'nav' ? '' : 'hidden'}">
                    <main class="glass p-8 rounded-[2.5rem] shadow-2xl space-y-6 border-white/5 mb-8">
                        <div class="space-y-4">
                            <div class="text-center space-y-2">
                                <h2 class="text-2xl font-extrabold tracking-tight text-purple-300">ğŸ”— ä¸ªäººå¯¼èˆªä¸­å¿ƒ</h2>
                                <p class="text-slate-400 text-sm">ç®¡ç†æ‚¨çš„å¸¸ç”¨é“¾æ¥ï¼Œå¿«é€Ÿè®¿é—®é‡è¦èµ„æº</p>
                            </div>
                            
                            <div class="flex flex-wrap gap-3 justify-center">
                                <button onclick="showAddNavLinkModal()" class="px-6 py-3 nav-gradient text-white rounded-2xl font-bold hover:shadow-lg transition flex items-center gap-2">
                                    <i class="fas fa-plus"></i> æ·»åŠ é“¾æ¥
                                </button>
                                <button onclick="loadNavLinks()" class="px-6 py-3 glass text-purple-400 rounded-2xl font-bold hover:bg-purple-500/10 transition flex items-center gap-2">
                                    <i class="fas fa-sync-alt"></i> åˆ·æ–°åˆ—è¡¨
                                </button>
                                <button onclick="exportNavLinks()" class="px-6 py-3 glass text-emerald-400 rounded-2xl font-bold hover:bg-emerald-500/10 transition flex items-center gap-2">
                                    <i class="fas fa-download"></i> å¯¼å‡ºå¤‡ä»½
                                </button>
                            </div>
                        </div>
                    </main>

                    <section class="space-y-8">
                        <div class="flex justify-between items-center px-4">
                            <h2 class="text-xs font-black uppercase tracking-[0.2em] text-slate-500 italic">Navigation / æˆ‘çš„é“¾æ¥åº“</h2>
                            <div class="text-xs text-slate-500" id="navStats">
                            </div>
                        </div>
                        
                        <div id="navCategories" class="space-y-8">
                            <div class="text-center py-20 text-slate-600 italic text-sm">ç‚¹å‡»"åˆ·æ–°åˆ—è¡¨"åŠ è½½æ‚¨çš„å¯¼èˆªé“¾æ¥</div>
                        </div>
                    </section>
                </div>
                
                <footer class="text-center pt-8 pb-4 opacity-50 hover:opacity-100 transition duration-500">
                    <span class="text-3xl font-black uppercase tracking-widest text-red-500">
                        è’¼å¤©å·²æ­»ï¼Œé»ƒå¤©ç•¶ç«‹
                    </span>
                </footer>
            </div>
        `;
            
            // æ·»åŠ å­—ç¬¦è®¡æ•°ç›‘å¬
            const noteInput = document.getElementById('noteInput');
            const noteCharCount = document.getElementById('noteCharCount');
            if (noteInput && noteCharCount) {
                noteInput.addEventListener('input', function() {
                    noteCharCount.textContent = this.value.length;
                });
            }
            
            // åŠ è½½é»˜è®¤è§†å›¾æ•°æ®
            if (currentView === 'notes') {
                // å¯ä»¥åœ¨è¿™é‡Œé¢„åŠ è½½ç¬”è®°
            } else {
                loadNavLinks();
            }
            
            // æ˜¾ç¤ºå¿«é€Ÿè®¿é—®æ 
            document.getElementById('quickAccessBar').classList.remove('hidden');
        }

        function renderShareView() {
            app.innerHTML = `
            <div class="space-y-12 animate-in fade-in slide-in-from-bottom-4 duration-700">
                <header class="flex justify-between items-end">
                    <div class="space-y-1">
                        <h1 class="text-4xl font-extrabold tracking-tighter bg-gradient-to-r from-orange-500 to-red-500 bg-clip-text text-transparent">CloudNotes</h1>
                        <p class="text-[10px] uppercase tracking-[0.3em] text-orange-500 font-black">é˜…åå³ç„š | åˆ†äº«è§£å¯†</p>
                    </div>
                    <div class="flex items-center gap-4">
                        <button onclick="window.location.href = window.location.origin + window.location.pathname" 
                                class="text-xs text-slate-400 hover:text-white transition px-3 py-1 glass rounded-full" 
                                title="è¿”å›ä¸»é¡µ">
                            è¿”å›ä¸»é¡µ
                        </button>
                    </div>
                </header>

                <main class="glass p-12 rounded-[3rem] shadow-2xl text-center space-y-8">
                    <div class="text-6xl animate-bounce">ğŸ”¥</div>
                    <div class="space-y-2">
                        <h1 class="text-3xl font-black italic">é˜…åå³ç„šè§£å¯†</h1>
                        <p class="text-slate-400 text-sm">è§£å¯†åæ•°æ®å°†ç«‹å³ä»æœåŠ¡å™¨ç‰©ç†æ“¦é™¤</p>
                    </div>
                    <input id="sharePw" type="password" placeholder="è¯·è¾“å…¥ 6 ä½ä»¥ä¸Šè§£å¯†å¯†ç " 
                           class="w-full bg-slate-950/50 border border-slate-800 p-5 rounded-2xl outline-none focus:ring-2 ring-orange-500/50 text-center font-mono">
                    <button id="unlockBtn" onclick="doUnlockShare()" 
                            class="w-full share-gradient text-white py-5 rounded-2xl font-black uppercase tracking-widest shadow-xl hover:scale-[1.02] transition">
                        è§£å¯†å¹¶é”€æ¯
                    </button>
                    <div id="shareResult" class="mt-8 hidden">
                        <div class="text-left p-6 bg-slate-950/50 rounded-2xl border border-orange-500/20 ring-1 ring-orange-500/10 shadow-inner leading-relaxed">
                            <div class="flex justify-between items-center mb-4">
                                <span class="text-xs uppercase tracking-widest text-slate-400 font-bold">é˜…åå³ç„šå†…å®¹</span>
                                <button onclick="startBurnAnimation()" id="burnNowBtn" class="text-xs text-orange-500 hover:text-red-500 transition font-bold uppercase tracking-widest flex items-center gap-2">
                                    <i class="fas fa-fire"></i>
                                    <span>ç«‹å³ç„šæ¯</span>
                                </button>
                            </div>
                            <div id="burningContent" class="markdown-preview relative"></div>
                        </div>
                    </div>
                </main>
                
                <footer class="text-center pt-8 pb-4 opacity-50 hover:opacity-100 transition duration-500">
                    <span class="text-3xl font-black uppercase tracking-widest text-red-500">
                        è’¼å¤©å·²æ­»ï¼Œé»ƒå¤©ç•¶ç«‹
                    </span>
                </footer>
            </div>
        `;
            
            // æ·»åŠ å›è½¦é”®æ”¯æŒ
            const sharePwInput = document.getElementById('sharePw');
            if (sharePwInput) {
                sharePwInput.addEventListener('keydown', function(event) {
                    if (event.key === 'Enter') {
                        doUnlockShare();
                    }
                });
            }
        }

        // ==================== è§†å›¾åˆ‡æ¢ ====================
        function switchView(view) {
            currentView = view;
            renderMainView();
        }

        // ==================== å¯¼èˆªåŠŸèƒ½ ====================
        async function loadNavLinks() {
            try {
                if (!API_URL) {
                    throw new Error('è¯·å…ˆé…ç½®APIåœ°å€');
                }
                
                const response = await fetch(`${API_URL}/api/nav/list`, {
                    headers: { 'Authorization': ADMIN_KEY }
                });
                
                if (!response.ok) {
                    throw new Error('è·å–å¯¼èˆªé“¾æ¥å¤±è´¥');
                }
                
                const navLinks = await response.json();
                
                navLinksCache = {};
                navLinks.forEach(link => {
                    navLinksCache[link.id] = link;
                });
                
                const categories = {};
                navLinks.forEach(link => {
                    const category = link.category || 'æœªåˆ†ç±»';
                    if (!categories[category]) {
                        categories[category] = [];
                    }
                    categories[category].push(link);
                });
                
                const navCategoriesDiv = document.getElementById('navCategories');
                if (navLinks.length === 0) {
                    navCategoriesDiv.innerHTML = `
                        <div class="text-center py-20 space-y-4">
                            <div class="text-5xl text-slate-700">ğŸ”—</div>
                            <p class="text-slate-600 italic">æš‚æ— å¯¼èˆªé“¾æ¥ï¼Œç‚¹å‡»"æ·»åŠ é“¾æ¥"å¼€å§‹åˆ›å»º</p>
                        </div>
                    `;
                    document.getElementById('navStats').textContent = '0 ä¸ªé“¾æ¥';
                    return;
                }
                
                let html = '';
                const categoryNames = Object.keys(categories).sort();
                
                categoryNames.forEach(category => {
                    const links = categories[category];
                    html += `
                        <div class="space-y-4">
                            <h3 class="text-lg font-bold text-slate-300 flex items-center gap-2">
                                <span class="category-tag bg-purple-900/30 text-purple-400">${category}</span>
                                <span class="text-sm text-slate-500">(${links.length}ä¸ªé“¾æ¥)</span>
                            </h3>
                            <div class="nav-grid">
                    `;
                    
                    links.forEach(link => {
                        const iconClass = link.icon || 'fas fa-globe';
                        const iconColor = link.icon_color || 'icon-blue';
                        const description = link.description ? `<p class="text-xs text-slate-500 mt-1 line-clamp-2">${link.description}</p>` : '';
                        
                        html += `
                            <div class="nav-link-card glass p-5 rounded-2xl space-y-3 cursor-pointer" onclick="openLinkInNewTab('${link.url}')" title="ç‚¹å‡»è®¿é—®: ${link.url}">
                                <div class="flex items-start justify-between">
                                    <div class="flex items-center gap-3">
                                        <div class="p-2 bg-slate-800/50 rounded-lg">
                                            <i class="${iconClass} ${iconColor} text-lg"></i>
                                        </div>
                                        <div class="flex-1">
                                            <h4 class="font-bold text-slate-200">${link.title}</h4>
                                            ${description}
                                        </div>
                                    </div>
                                    <button onclick="event.stopPropagation(); editNavLink(${link.id})" class="p-2 text-slate-500 hover:text-purple-400 transition" title="ç¼–è¾‘">
                                        <i class="fas fa-edit"></i>
                                    </button>
                                </div>
                                <div class="flex justify-between items-center text-xs text-slate-500">
                                    <span class="truncate font-mono" title="${link.url}">${link.url.replace(/https?:\/\//, '')}</span>
                                    <span>${new Date(link.created_at).toLocaleDateString()}</span>
                                </div>
                            </div>
                        `;
                    });
                    
                    html += `
                            </div>
                        </div>
                    `;
                });
                
                navCategoriesDiv.innerHTML = html;
                
                document.getElementById('navStats').textContent = `${navLinks.length} ä¸ªé“¾æ¥ï¼Œ${categoryNames.length} ä¸ªåˆ†ç±»`;
                
            } catch (error) {
                console.error('åŠ è½½å¯¼èˆªé“¾æ¥å¤±è´¥:', error);
                const navCategoriesDiv = document.getElementById('navCategories');
                navCategoriesDiv.innerHTML = `
                    <div class="text-center py-20 text-slate-700 italic text-sm">
                        åŠ è½½å¤±è´¥: ${error.message}
                    </div>
                `;
            }
        }
        
        function openLinkInNewTab(url) {
            window.open(url, '_blank');
        }
        
        function showAddNavLinkModal() {
            document.getElementById('addNavLinkModal').classList.remove('hidden');
            document.getElementById('navLinkTitle').value = '';
            document.getElementById('navLinkUrl').value = '';
            document.getElementById('navLinkCategory').value = 'æ—¥å¸¸æ•ˆç‡';
            document.getElementById('navLinkIcon').value = 'fas fa-globe';
            document.getElementById('navLinkIconColor').value = 'icon-blue';
            document.getElementById('navLinkDescription').value = '';
        }
        
        function closeAddNavLinkModal() {
            document.getElementById('addNavLinkModal').classList.add('hidden');
        }
        
        function setNavCategory(category) {
            document.getElementById('navLinkCategory').value = category;
        }
        
        function setNavIcon(icon, color) {
            document.getElementById('navLinkIcon').value = icon;
            document.getElementById('navLinkIconColor').value = color;
        }
        
        async function saveNavLink() {
            const title = document.getElementById('navLinkTitle').value.trim();
            const url = document.getElementById('navLinkUrl').value.trim();
            const category = document.getElementById('navLinkCategory').value.trim() || 'æœªåˆ†ç±»';
            const icon = document.getElementById('navLinkIcon').value;
            const icon_color = document.getElementById('navLinkIconColor').value;
            const description = document.getElementById('navLinkDescription').value.trim();
            
            if (!title || !url) {
                alert("è¯·å¡«å†™é“¾æ¥æ ‡é¢˜å’Œåœ°å€");
                return;
            }
            
            if (!url.startsWith('http://') && !url.startsWith('https://')) {
                alert("é“¾æ¥åœ°å€æ ¼å¼ä¸æ­£ç¡®ï¼Œè¯·ä»¥ http:// æˆ– https:// å¼€å¤´");
                return;
            }
            
            try {
                const response = await fetch(`${API_URL}/api/nav/save`, {
                    method: 'POST',
                    headers: { 
                        'Content-Type': 'application/json',
                        'Authorization': ADMIN_KEY 
                    },
                    body: JSON.stringify({
                        title,
                        url,
                        category,
                        icon,
                        icon_color,
                        description
                    })
                });
                
                if (response.ok) {
                    showToast("âœ… å¯¼èˆªé“¾æ¥å·²ä¿å­˜", 'success');
                    closeAddNavLinkModal();
                    loadNavLinks();
                } else {
                    const error = await response.text();
                    throw new Error(error || 'ä¿å­˜å¤±è´¥');
                }
            } catch (error) {
                console.error('ä¿å­˜å¯¼èˆªé“¾æ¥å¤±è´¥:', error);
                showToast(`âŒ ä¿å­˜å¤±è´¥: ${error.message}`, 'error');
            }
        }
        
        async function editNavLink(id) {
            const link = navLinksCache[id];
            if (!link) {
                alert("é“¾æ¥ä¸å­˜åœ¨");
                return;
            }
            
            currentEditNavLinkId = id;
            document.getElementById('editNavLinkId').textContent = `#${id}`;
            document.getElementById('editNavLinkTitle').value = link.title;
            document.getElementById('editNavLinkUrl').value = link.url;
            document.getElementById('editNavLinkCategory').value = link.category || 'æœªåˆ†ç±»';
            document.getElementById('editNavLinkIcon').value = link.icon || 'fas fa-globe';
            document.getElementById('editNavLinkIconColor').value = link.icon_color || 'icon-blue';
            document.getElementById('editNavLinkDescription').value = link.description || '';
            
            const iconPreview = document.getElementById('editNavIconPreview');
            iconPreview.innerHTML = `<i class="${link.icon || 'fas fa-globe'} ${link.icon_color || 'icon-blue'} text-2xl"></i>`;
            
            document.getElementById('editNavLinkModal').classList.remove('hidden');
        }
        
        function setEditNavCategory(category) {
            document.getElementById('editNavLinkCategory').value = category;
        }
        
        function setEditNavIcon(icon, color) {
            document.getElementById('editNavLinkIcon').value = icon;
            document.getElementById('editNavLinkIconColor').value = color;
            const iconPreview = document.getElementById('editNavIconPreview');
            iconPreview.innerHTML = `<i class="${icon} ${color} text-2xl"></i>`;
        }
        
        function closeEditNavLinkModal() {
            document.getElementById('editNavLinkModal').classList.add('hidden');
            currentEditNavLinkId = null;
        }
        
        async function updateNavLink() {
            const title = document.getElementById('editNavLinkTitle').value.trim();
            const url = document.getElementById('editNavLinkUrl').value.trim();
            const category = document.getElementById('editNavLinkCategory').value.trim() || 'æœªåˆ†ç±»';
            const icon = document.getElementById('editNavLinkIcon').value;
            const icon_color = document.getElementById('editNavLinkIconColor').value;
            const description = document.getElementById('editNavLinkDescription').value.trim();
            
            if (!title || !url) {
                alert("è¯·å¡«å†™é“¾æ¥æ ‡é¢˜å’Œåœ°å€");
                return;
            }
            
            if (!url.startsWith('http://') && !url.startsWith('https://')) {
                alert("é“¾æ¥åœ°å€æ ¼å¼ä¸æ­£ç¡®ï¼Œè¯·ä»¥ http:// æˆ– https:// å¼€å¤´");
                return;
            }
            
            try {
                const response = await fetch(`${API_URL}/api/nav/save`, {
                    method: 'POST',
                    headers: { 
                        'Content-Type': 'application/json',
                        'Authorization': ADMIN_KEY 
                    },
                    body: JSON.stringify({
                        id: currentEditNavLinkId,
                        title,
                        url,
                        category,
                        icon,
                        icon_color,
                        description
                    })
                });
                
                if (response.ok) {
                    showToast("âœ… å¯¼èˆªé“¾æ¥å·²æ›´æ–°", 'success');
                    closeEditNavLinkModal();
                    loadNavLinks();
                } else {
                    const error = await response.text();
                    throw new Error(error || 'æ›´æ–°å¤±è´¥');
                }
            } catch (error) {
                console.error('æ›´æ–°å¯¼èˆªé“¾æ¥å¤±è´¥:', error);
                showToast(`âŒ æ›´æ–°å¤±è´¥: ${error.message}`, 'error');
            }
        }
        
        function confirmDeleteNavLink() {
            if (confirm("ç¡®å®šè¦åˆ é™¤è¿™ä¸ªå¯¼èˆªé“¾æ¥å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ’¤é”€ã€‚")) {
                deleteNavLink(currentEditNavLinkId);
            }
        }
        
        async function deleteNavLink(id) {
            try {
                const response = await fetch(`${API_URL}/api/nav/delete`, {
                    method: 'POST',
                    headers: { 
                        'Content-Type': 'application/json',
                        'Authorization': ADMIN_KEY 
                    },
                    body: JSON.stringify({ id })
                });
                
                if (response.ok) {
                    showToast("âœ… å¯¼èˆªé“¾æ¥å·²åˆ é™¤", 'success');
                    closeEditNavLinkModal();
                    loadNavLinks();
                } else {
                    const error = await response.text();
                    throw new Error(error || 'åˆ é™¤å¤±è´¥');
                }
            } catch (error) {
                console.error('åˆ é™¤å¯¼èˆªé“¾æ¥å¤±è´¥:', error);
                showToast(`âŒ åˆ é™¤å¤±è´¥: ${error.message}`, 'error');
            }
        }
        
        async function exportNavLinks() {
            try {
                const response = await fetch(`${API_URL}/api/nav/list`, {
                    headers: { 'Authorization': ADMIN_KEY }
                });
                
                if (!response.ok) {
                    throw new Error('è·å–å¯¼èˆªé“¾æ¥å¤±è´¥');
                }
                
                const navLinks = await response.json();
                
                const exportData = {
                    export_date: new Date().toISOString(),
                    total_links: navLinks.length,
                    categories: {},
                    links: navLinks
                };
                
                navLinks.forEach(link => {
                    const category = link.category || 'æœªåˆ†ç±»';
                    if (!exportData.categories[category]) {
                        exportData.categories[category] = [];
                    }
                    exportData.categories[category].push(link.title);
                });
                
                const blob = new Blob([JSON.stringify(exportData, null, 2)], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `CloudNotes_Nav_Export_${new Date().toISOString().split('T')[0]}.json`;
                a.click();
                URL.revokeObjectURL(url);
                
                showToast("âœ… å¯¼èˆªé“¾æ¥å·²å¯¼å‡º", 'success');
                
            } catch (error) {
                console.error('å¯¼å‡ºå¯¼èˆªé“¾æ¥å¤±è´¥:', error);
                showToast(`âŒ å¯¼å‡ºå¤±è´¥: ${error.message}`, 'error');
            }
        }

        // ==================== ç¬”è®°åŠŸèƒ½ ====================
        function showAddNoteModal() {
            document.getElementById('addNoteModal').classList.remove('hidden');
            document.getElementById('quickMainPw').value = '';
            document.getElementById('quickNoteInput').value = '';
            document.getElementById('quickNoteCharCount').textContent = '0';
            
            const quickNoteInput = document.getElementById('quickNoteInput');
            const quickNoteCharCount = document.getElementById('quickNoteCharCount');
            quickNoteInput.addEventListener('input', function() {
                quickNoteCharCount.textContent = this.value.length;
            });
        }
        
        function closeAddNoteModal() {
            document.getElementById('addNoteModal').classList.add('hidden');
        }
        
        async function quickSaveNote() {
            const text = document.getElementById('quickNoteInput').value;
            const pw = document.getElementById('quickMainPw').value;
            
            if (!text || !pw) {
                alert("è¯·å¡«å†™å†…å®¹å’Œå¯†ç ");
                return;
            }
            
            try {
                const cipher = await encrypt(text, pw);
                
                const res = await fetch(`${API_URL}/api/save`, {
                    method: 'POST', 
                    headers: { 
                        'Content-Type': 'application/json', 
                        'Authorization': ADMIN_KEY 
                    },
                    body: JSON.stringify({ content: cipher })
                });
                
                if (res.ok) { 
                    showToast("âœ… ç¬”è®°å·²å­˜å…¥å®‰å…¨åº“", 'success'); 
                    closeAddNoteModal();
                    if (currentView === 'notes') {
                        loadNotesList();
                    }
                } else {
                    const error = await res.text();
                    throw new Error(error || 'ä¿å­˜å¤±è´¥');
                }
            } catch (e) { 
                console.error('ä¿å­˜å¤±è´¥:', e);
                showToast(`âŒ ä¿å­˜å¤±è´¥: ${e.message}`, 'error');
            }
        }
        
        // Base64 ç¼–ç è¾…åŠ©å‡½æ•°ï¼ˆæ”¯æŒä¸­æ–‡ï¼‰
        function base64Encode(str) {
            try {
                return btoa(unescape(encodeURIComponent(str)));
            } catch (e) {
                console.error('Base64ç¼–ç å¤±è´¥:', e);
                return '';
            }
        }
        
        // Base64 è§£ç è¾…åŠ©å‡½æ•°
        function base64Decode(str) {
            try {
                return decodeURIComponent(escape(atob(str)));
            } catch (e) {
                console.error('Base64è§£ç å¤±è´¥:', e);
                return '';
            }
        }
        
        // ä» data å±æ€§å¯¼å‡ºçš„å‡½æ•°
        function exportFromData(button) {
            const id = button.getAttribute('data-note-id');
            const base64Content = button.getAttribute('data-note-content-base64');
            
            if (!base64Content) {
                // å›é€€åˆ°ä»ç¼“å­˜è·å–
                const note = notesCache[id];
                if (note && note.clearText) {
                    doExport(note.clearText, parseInt(id));
                } else {
                    alert('æ— æ³•è·å–ç¬”è®°å†…å®¹');
                }
                return;
            }
            
            try {
                const text = base64Decode(base64Content);
                if (text) {
                    doExport(text, parseInt(id));
                } else {
                    throw new Error('è§£ç å¤±è´¥');
                }
            } catch (e) {
                console.error('å¯¼å‡ºå¤±è´¥:', e);
                showToast('å¯¼å‡ºå¤±è´¥ï¼Œè¯·é‡è¯•', 'error');
            }
        }
        
        // ä» data å±æ€§ç¼–è¾‘çš„å‡½æ•°
        function editFromData(button) {
            const id = button.getAttribute('data-note-id');
            const base64Content = button.getAttribute('data-note-content-base64');
            
            if (!base64Content) {
                // å›é€€åˆ°ä»ç¼“å­˜è·å–
                const note = notesCache[id];
                if (note && note.clearText) {
                    openEdit(parseInt(id), note.clearText);
                } else {
                    alert('æ— æ³•è·å–ç¬”è®°å†…å®¹');
                }
                return;
            }
            
            try {
                const text = base64Decode(base64Content);
                if (text) {
                    openEdit(parseInt(id), text);
                } else {
                    throw new Error('è§£ç å¤±è´¥');
                }
            } catch (e) {
                console.error('ç¼–è¾‘å¤±è´¥:', e);
                showToast('ç¼–è¾‘å¤±è´¥ï¼Œè¯·é‡è¯•', 'error');
            }
        }
        
        // åŠ è½½ç¬”è®°åˆ—è¡¨å‡½æ•°
        async function loadNotesList() {
            const pw = document.getElementById('mainPw').value; 
            if (!pw) {
                showToast('è¯·è¾“å…¥å¯†ç è§£å¯†', 'info');
                return;
            }
            
            const listDiv = document.getElementById('notesList');
            listDiv.innerHTML = '<div class="text-center py-12 text-slate-600 italic text-sm">åŠ è½½ä¸­...</div>';
            
            try {
                const res = await fetch(`${API_URL}/api/list`, { 
                    headers: { 'Authorization': ADMIN_KEY } 
                });
                
                if (!res.ok) {
                    throw new Error('è·å–ç¬”è®°åˆ—è¡¨å¤±è´¥');
                }
                
                const notes = await res.json(); 
                listDiv.innerHTML = "";
                
                if (notes.length === 0) {
                    listDiv.innerHTML = '<div class="text-center py-20 text-slate-700 italic text-sm">æš‚æ— æ•°æ®</div>';
                    return;
                }
                
                notesCache = {};
                
                for (let n of notes) {
                    const clearText = await decrypt(n.content, pw);
                    if (!clearText) {
                        console.warn(`è§£å¯†ç¬”è®° #${n.id} å¤±è´¥`);
                        continue;
                    }
                    
                    notesCache[n.id] = {
                        id: n.id,
                        clearText: clearText,
                        created_at: n.created_at
                    };
                    
                    const isMarkdown = clearText.includes('# ') || clearText.includes('## ') || clearText.includes('```') || 
                                       clearText.includes('**') || clearText.includes('- ') || clearText.includes('> ');
                    
                    const card = document.createElement('div');
                    card.className = "note-card glass p-6 rounded-3xl space-y-4 border border-white/5 shadow-lg group";
                    
                    let previewContent = clearText;
                    let showFullButton = false;
                    
                    if (clearText.length > 300) {
                        previewContent = clearText.substring(0, 300) + '...';
                        showFullButton = true;
                    }
                    
                    const renderedContent = isMarkdown ? marked.parse(previewContent) : 
                                            `<div class="whitespace-pre-wrap">${previewContent.replace(/\n/g, '<br>')}</div>`;
                    
                    // ä½¿ç”¨ Base64 ç¼–ç å†…å®¹å­˜å‚¨åœ¨ data å±æ€§ä¸­
                    const base64Content = base64Encode(clearText);
                    
                    card.innerHTML = `
                        <div class="flex justify-between items-center mb-2">
                            <span class="text-[9px] font-black text-slate-500 tracking-widest uppercase italic">
                                ç´¢å¼•ç¼–å· #${n.id}
                            </span>
                            
                            <div class="flex items-center gap-4">
                                ${showFullButton ? `
                                <button onclick="toggleNoteContent(${n.id})" 
                                        class="toggle-btn flex items-center gap-1 px-2 py-1 text-xs text-blue-400 hover:text-blue-300 hover:bg-blue-900/20 rounded-lg transition"
                                        id="topToggle-${n.id}">
                                    <i class="fas fa-chevron-down text-[10px]"></i>
                                    <span>æ˜¾ç¤ºå…¨éƒ¨å†…å®¹</span>
                                </button>
                                ` : ''}
                                
                                <span class="text-[9px] font-black text-slate-500 tracking-widest uppercase italic">
                                    ${new Date(n.created_at).toLocaleString()}
                                </span>
                            </div>
                        </div>
                        
                        <div class="markdown-preview text-slate-300 text-sm leading-relaxed" id="noteContent-${n.id}">
                            ${renderedContent}
                            ${showFullButton ? `
                            <div class="text-center mt-4">
                                <button onclick="toggleNoteContent(${n.id})" 
                                        class="toggle-btn flex items-center justify-center gap-1 mx-auto px-4 py-2 text-xs text-blue-400 hover:text-blue-300 hover:bg-blue-900/20 rounded-lg transition"
                                        id="bottomToggle-${n.id}">
                                    <i class="fas fa-chevron-down text-[10px]"></i>
                                    <span>æ˜¾ç¤ºå…¨éƒ¨å†…å®¹</span>
                                </button>
                            </div>
                            ` : ''}
                        </div>
                        
                        <div class="pt-4 border-t border-white/5 flex flex-wrap gap-4 items-center">
                            <button onclick="doShareCopy(event, '${n.content.replace(/'/g, "\\'")}')" class="share-btn text-xs font-black text-blue-400 uppercase tracking-widest hover:text-blue-300 transition flex items-center gap-1">
                                <i class="fas fa-share"></i>
                                <span>ç”Ÿæˆåˆ†äº«</span>
                            </button>
                            <button data-note-id="${n.id}" data-note-content-base64="${base64Content}" onclick="exportFromData(this)" class="text-xs font-black text-emerald-500 uppercase tracking-widest hover:text-emerald-400 transition flex items-center gap-1">
                                <i class="fas fa-download"></i>
                                <span>å¯¼å‡ºå¤‡ä»½</span>
                            </button>
                            <button data-note-id="${n.id}" data-note-content-base64="${base64Content}" onclick="editFromData(this)" class="text-xs font-black text-amber-500 uppercase tracking-widest hover:text-amber-400 transition flex items-center gap-1">
                                <i class="fas fa-edit"></i>
                                <span>ç¼–è¾‘</span>
                            </button>
                            <button onclick="doDelete(${n.id})" class="text-xs font-black text-rose-500 uppercase tracking-widest ml-auto opacity-40 group-hover:opacity-100 transition flex items-center gap-1">
                                <i class="fas fa-trash"></i>
                                <span>åˆ é™¤</span>
                            </button>
                        </div>
                    `;
                    listDiv.appendChild(card);
                }
                
                // é«˜äº®ä»£ç å—
                setTimeout(() => {
                    hljs.highlightAll();
                }, 100);
                
            } catch (e) { 
                console.error('åŠ è½½åˆ—è¡¨å¤±è´¥:', e);
                listDiv.innerHTML = '<div class="text-center py-20 text-slate-700 italic text-sm">æ‹‰å–å¤±è´¥: ' + e.message + '</div>';
            }
        }

        // ==================== é€šç”¨åŠŸèƒ½ ====================
        function configUrl() {
            document.getElementById('settingsModal').classList.remove('hidden');
            document.getElementById('setApi').value = API_URL;
            document.getElementById('setKey').value = ADMIN_KEY;
        }
        
        function closeSettings() { 
            document.getElementById('settingsModal').classList.add('hidden'); 
        }
        
        function saveSettings() {
            let apiUrl = document.getElementById('setApi').value.trim();
    
            // ç§»é™¤å°¾éƒ¨æ–œæ åç»Ÿä¸€æ·»åŠ 
            apiUrl = apiUrl.replace(/\/+$/, '');
            
            localStorage.setItem('cf_notes_api', apiUrl);
            localStorage.setItem('cf_notes_key', document.getElementById('setKey').value);
            
            location.reload();
        }

        function showMarkdownHelp() {
            const helpContent = `# Markdown è¯­æ³•é€ŸæŸ¥

## æ ‡é¢˜
\`# ä¸€çº§æ ‡é¢˜\`
\`## äºŒçº§æ ‡é¢˜\`
\`### ä¸‰çº§æ ‡é¢˜\`

## æ–‡æœ¬æ ·å¼
- **ç²—ä½“**: \`**ç²—ä½“æ–‡æœ¬**\`
- *æ–œä½“*: \`*æ–œä½“æ–‡æœ¬*\`
- ~~åˆ é™¤çº¿~~: \`~~åˆ é™¤æ–‡æœ¬~~\`
- \`è¡Œå†…ä»£ç \`: \`\` ä»£ç  \`\`

## åˆ—è¡¨
- æ— åºåˆ—è¡¨: \`- é¡¹ç›®\`
- æœ‰åºåˆ—è¡¨: \`1. é¡¹ç›®\`

## é“¾æ¥ä¸å›¾ç‰‡
- [é“¾æ¥](https://example.com): \`[é“¾æ¥æ–‡æœ¬](URL)\`
- ![å›¾ç‰‡](https://example.com/image.jpg): \`![æ›¿ä»£æ–‡æœ¬](å›¾ç‰‡URL)\`

## ä»£ç å—
\`\`\`javascript
// JavaScript ä»£ç 
console.log('Hello');
\`\`\`

## å¼•ç”¨
> å¼•ç”¨å†…å®¹: \`> å¼•ç”¨æ–‡æœ¬\`

## è¡¨æ ¼
| è¡¨å¤´ | è¡¨å¤´ |
|------|------|
| å†…å®¹ | å†…å®¹ |

## åˆ†å‰²çº¿
\`---\` æˆ– \`***\`

## ä»»åŠ¡åˆ—è¡¨
- [ ] æœªå®Œæˆä»»åŠ¡
- [x] å·²å®Œæˆä»»åŠ¡`;

            alert(helpContent);
        }

        // ==================== ç¼–è¾‘æ¨¡å¼åŠŸèƒ½ ====================
        function switchTab(tabName) {
            const editTab = document.getElementById('editTab');
            const previewTab = document.getElementById('previewTab');
            const editTabBtn = document.getElementById('editTabBtn');
            const previewTabBtn = document.getElementById('previewTabBtn');
            const editContent = document.getElementById('editNoteContent');
            
            if (tabName === 'edit') {
                editTab.classList.remove('hidden');
                previewTab.classList.add('hidden');
                editTabBtn.classList.add('active');
                previewTabBtn.classList.remove('active');
            } else {
                editTab.classList.add('hidden');
                previewTab.classList.remove('hidden');
                editTabBtn.classList.remove('active');
                previewTabBtn.classList.add('active');
                
                const previewDiv = document.getElementById('markdownPreview');
                const markdownContent = editContent.value || '';
                
                // ä½¿ç”¨ä¸åˆ†äº«é¡µé¢å®Œå…¨ç›¸åŒçš„æ¸²æŸ“æ–¹å¼
                previewDiv.innerHTML = marked.parse(markdownContent);
                
                // é«˜äº®ä»£ç å—
                setTimeout(() => {
                    hljs.highlightAll();
                    
                    // ç¡®ä¿æ‰€æœ‰ä»£ç å—éƒ½æœ‰æ­£ç¡®çš„èƒŒæ™¯
                    previewDiv.querySelectorAll('pre code').forEach((block) => {
                        if (!block.classList.contains('hljs')) {
                            hljs.highlightElement(block);
                        }
                    });
                }, 100);
            }
        }

        function insertMarkdown(syntax, placeholder) {
            const textarea = document.getElementById('editNoteContent');
            const start = textarea.selectionStart;
            const end = textarea.selectionEnd;
            const selectedText = textarea.value.substring(start, end);
            
            if (selectedText) {
                // å¤„ç†ä¸åŒçš„è¯­æ³•
                let newText;
                if (syntax === '**') {
                    newText = `**${selectedText}**`;
                } else if (syntax === '*') {
                    newText = `*${selectedText}*`;
                } else if (syntax === '~~') {
                    newText = `~~${selectedText}~~`;
                } else if (syntax === '[é“¾æ¥æ–‡æœ¬](https://)') {
                    newText = `[${selectedText}](https://)`;
                } else if (syntax === '![æ›¿ä»£æ–‡æœ¬](https://)') {
                    newText = `![${selectedText}](https://)`;
                } else {
                    newText = syntax + selectedText;
                }
                
                textarea.value = textarea.value.substring(0, start) + newText + textarea.value.substring(end);
                
                // è®¾ç½®å…‰æ ‡ä½ç½®
                if (syntax === '**' || syntax === '*' || syntax === '~~') {
                    textarea.selectionStart = start + syntax.length;
                    textarea.selectionEnd = end + syntax.length;
                } else if (syntax === '[é“¾æ¥æ–‡æœ¬](https://)') {
                    textarea.selectionStart = start + 1;
                    textarea.selectionEnd = end + 1;
                } else if (syntax === '![æ›¿ä»£æ–‡æœ¬](https://)') {
                    textarea.selectionStart = start + 2;
                    textarea.selectionEnd = end + 2;
                } else {
                    textarea.selectionStart = start + syntax.length;
                    textarea.selectionEnd = start + syntax.length + placeholder.length;
                }
            } else {
                let placeholderText;
                if (syntax === '```javascript\n\n```') {
                    placeholderText = '```javascript\n' + placeholder + '\n```';
                } else if (syntax === '**') {
                    placeholderText = `**${placeholder}**`;
                } else if (syntax === '*') {
                    placeholderText = `*${placeholder}*`;
                } else if (syntax === '~~') {
                    placeholderText = `~~${placeholder}~~`;
                } else if (syntax === '[é“¾æ¥æ–‡æœ¬](https://)') {
                    placeholderText = `[é“¾æ¥æ–‡æœ¬](https://)`;
                } else if (syntax === '![æ›¿ä»£æ–‡æœ¬](https://)') {
                    placeholderText = `![æ›¿ä»£æ–‡æœ¬](https://)`;
                } else {
                    placeholderText = syntax + placeholder;
                }
                
                textarea.value = textarea.value.substring(0, start) + placeholderText + textarea.value.substring(end);
                
                // è®¾ç½®å…‰æ ‡ä½ç½®
                if (syntax === '```javascript\n\n```') {
                    textarea.selectionStart = start + '```javascript\n'.length;
                    textarea.selectionEnd = start + '```javascript\n'.length + placeholder.length;
                } else if (syntax === '**') {
                    textarea.selectionStart = start + 2;
                    textarea.selectionEnd = start + 2 + placeholder.length;
                } else if (syntax === '*') {
                    textarea.selectionStart = start + 1;
                    textarea.selectionEnd = start + 1 + placeholder.length;
                } else if (syntax === '~~') {
                    textarea.selectionStart = start + 2;
                    textarea.selectionEnd = start + 2 + placeholder.length;
                } else if (syntax === '[é“¾æ¥æ–‡æœ¬](https://)') {
                    textarea.selectionStart = start + 1;
                    textarea.selectionEnd = start + 5; // "é“¾æ¥æ–‡æœ¬"çš„é•¿åº¦
                } else if (syntax === '![æ›¿ä»£æ–‡æœ¬](https://)') {
                    textarea.selectionStart = start + 2;
                    textarea.selectionEnd = start + 6; // "æ›¿ä»£æ–‡æœ¬"çš„é•¿åº¦
                } else {
                    textarea.selectionStart = start + syntax.length;
                    textarea.selectionEnd = start + syntax.length + placeholder.length;
                }
            }
            
            textarea.focus();
            updateCharCount();
        }

        function updateCharCount() {
            const textarea = document.getElementById('editNoteContent');
            const charCount = document.getElementById('editCharCount');
            if (textarea && charCount) {
                charCount.textContent = textarea.value.length;
            }
        }

        async function doSave(content, id = null) {
            const text = content || document.getElementById('noteInput').value;
            const pw = document.getElementById('mainPw').value;
            
            if (!text || !pw) {
                showToast('è¯·å¡«å†™å†…å®¹å’Œå¯†ç ', 'info');
                return null;
            }
            
            try {
                const cipher = await encrypt(text, pw);
                
                const body = { content: cipher };
                
                if (id !== null) {
                    body.id = id;
                }
                
                const res = await fetch(`${API_URL}/api/save`, {
                    method: 'POST', 
                    headers: { 
                        'Content-Type': 'application/json', 
                        'Authorization': ADMIN_KEY 
                    },
                    body: JSON.stringify(body)
                });
                
                if (res.ok) { 
                    if (id === null) {
                        showToast("âœ… å·²å­˜å…¥å®‰å…¨åº“", 'success'); 
                        document.getElementById('noteInput').value = ""; 
                        document.getElementById('noteCharCount').textContent = "0";
                    } else {
                        showToast("âœ… ç¬”è®°å·²æ›´æ–°", 'success');
                    }
                    loadNotesList();
                    return true;
                } else {
                    const error = await res.text();
                    throw new Error(error || 'ä¿å­˜å¤±è´¥');
                }
            } catch (e) { 
                console.error('ä¿å­˜å¤±è´¥:', e);
                showToast(`âŒ ä¿å­˜å¤±è´¥: ${e.message}`, 'error');
                return false;
            }
        }

        // ä¿®æ”¹åçš„ toggleNoteContent å‡½æ•°ï¼Œæ”¯æŒé¡¶éƒ¨å’Œåº•éƒ¨æŒ‰é’®åŒæ­¥
        function toggleNoteContent(id) {
            const contentDiv = document.getElementById(`noteContent-${id}`);
            const topToggleBtn = document.getElementById(`topToggle-${id}`);
            const bottomToggleBtn = document.getElementById(`bottomToggle-${id}`);
            const note = notesCache[id];
            
            if (!note) {
                console.error('æœªæ‰¾åˆ°ç¬”è®°ç¼“å­˜:', id);
                return;
            }
            
            const currentContent = contentDiv.innerHTML;
            const showFullText = currentContent.includes('æ˜¾ç¤ºå…¨éƒ¨å†…å®¹');
            
            const isMarkdown = note.clearText.includes('# ') || note.clearText.includes('## ') || 
                               note.clearText.includes('```') || note.clearText.includes('**') ||
                               note.clearText.includes('- ') || note.clearText.includes('> ');
            
            if (showFullText) {
                // æ˜¾ç¤ºå®Œæ•´å†…å®¹
                const renderedContent = isMarkdown ? marked.parse(note.clearText) : 
                                        `<div class="whitespace-pre-wrap">${note.clearText.replace(/\n/g, '<br>')}</div>`;
                contentDiv.innerHTML = renderedContent + 
                    `<div class="text-center mt-4">
                        <button onclick="toggleNoteContent(${id})" 
                                class="toggle-btn expanded flex items-center justify-center gap-1 mx-auto px-4 py-2 text-xs text-blue-400 hover:text-blue-300 hover:bg-blue-900/20 rounded-lg transition"
                                id="bottomToggle-${id}">
                            <i class="fas fa-chevron-up text-[10px]"></i>
                            <span>æ”¶èµ·</span>
                        </button>
                    </div>`;
                
                // æ›´æ–°é¡¶éƒ¨æŒ‰é’®
                if (topToggleBtn) {
                    topToggleBtn.classList.add('expanded');
                    topToggleBtn.innerHTML = `
                        <i class="fas fa-chevron-up text-[10px]"></i>
                        <span>æ”¶èµ·</span>
                    `;
                }
                
                // é«˜äº®ä»£ç å—
                setTimeout(() => {
                    hljs.highlightAll();
                }, 100);
            } else {
                // æ˜¾ç¤ºé¢„è§ˆå†…å®¹
                let previewContent = note.clearText;
                if (note.clearText.length > 300) {
                    previewContent = note.clearText.substring(0, 300) + '...';
                }
                
                const renderedContent = isMarkdown ? marked.parse(previewContent) : 
                                        `<div class="whitespace-pre-wrap">${previewContent.replace(/\n/g, '<br>')}</div>`;
                contentDiv.innerHTML = renderedContent + 
                    `<div class="text-center mt-4">
                        <button onclick="toggleNoteContent(${id})" 
                                class="toggle-btn flex items-center justify-center gap-1 mx-auto px-4 py-2 text-xs text-blue-400 hover:text-blue-300 hover:bg-blue-900/20 rounded-lg transition"
                                id="bottomToggle-${id}">
                            <i class="fas fa-chevron-down text-[10px]"></i>
                            <span>æ˜¾ç¤ºå…¨éƒ¨å†…å®¹</span>
                        </button>
                    </div>`;
                
                // æ›´æ–°é¡¶éƒ¨æŒ‰é’®
                if (topToggleBtn) {
                    topToggleBtn.classList.remove('expanded');
                    topToggleBtn.innerHTML = `
                        <i class="fas fa-chevron-down text-[10px]"></i>
                        <span>æ˜¾ç¤ºå…¨éƒ¨å†…å®¹</span>
                    `;
                }
            }
        }

        // ==================== ç¼–è¾‘åŠŸèƒ½ ====================
        function openEdit(id, content) {
            currentEditId = id;
            document.getElementById('editNoteId').textContent = `#${id}`;
            
            const textarea = document.getElementById('editNoteContent');
            textarea.value = content;
            
            // åˆå§‹åŒ–å­—ç¬¦è®¡æ•°
            updateCharCount();
            
            // æ·»åŠ è¾“å…¥ç›‘å¬
            textarea.addEventListener('input', updateCharCount);
            
            // æ·»åŠ å®æ—¶é¢„è§ˆç›‘å¬
            textarea.addEventListener('input', function() {
                if (!document.getElementById('previewTab').classList.contains('hidden')) {
                    switchTab('preview');
                }
            });
            
            // é»˜è®¤æ˜¾ç¤ºç¼–è¾‘æ¨¡å¼
            switchTab('edit');
            
            // æ˜¾ç¤ºæ¨¡æ€æ¡†
            document.getElementById('editModal').classList.remove('hidden');
            
            // èšç„¦åˆ°æ–‡æœ¬åŒºåŸŸ
            setTimeout(() => {
                textarea.focus();
            }, 100);
        }
        
        function closeEdit() {
            document.getElementById('editModal').classList.add('hidden');
            currentEditId = null;
        }
        
        async function saveEdit() {
            const newContent = document.getElementById('editNoteContent').value;
            
            if (!newContent.trim()) {
                showToast("ç¬”è®°å†…å®¹ä¸èƒ½ä¸ºç©º", 'info');
                return;
            }
            
            const success = await doSave(newContent, currentEditId);
            
            if (success) {
                closeEdit();
            }
        }

        // ==================== åˆ†äº«åŠŸèƒ½ ====================
        async function doShareCopy(event, cipher) {
            const pid = Math.random().toString(36).substring(2, 12);
            
            // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
            const button = event.target.closest('button');
            const originalText = button.innerHTML;
            button.innerHTML = '<i class="fas fa-spinner fa-spin"></i> ç”Ÿæˆä¸­...';
            button.disabled = true;
            
            try {
                const response = await fetch(`${API_URL}/api/save`, {
                    method: 'POST', 
                    headers: { 
                        'Content-Type': 'application/json', 
                        'Authorization': ADMIN_KEY 
                    },
                    body: JSON.stringify({ 
                        content: cipher, 
                        public_id: pid, 
                        is_share: 1 
                    })
                });
                
                if (!response.ok) {
                    const error = await response.text();
                    throw new Error(error || 'ç”Ÿæˆåˆ†äº«é“¾æ¥å¤±è´¥');
                }
                
                const fullUrl = `${window.location.origin}${window.location.pathname}?share=${pid}&cfg=${btoa(API_URL)}`;
                
                // ä½¿ç”¨ Clipboard API å¤åˆ¶åˆ°å‰ªè´´æ¿
                try {
                    await navigator.clipboard.writeText(fullUrl);
                    
                    // æ˜¾ç¤ºå¤åˆ¶æˆåŠŸçš„è§†è§‰åé¦ˆ
                    button.innerHTML = '<i class="fas fa-check"></i> å·²å¤åˆ¶';
                    button.style.background = 'linear-gradient(135deg, #10b981, #059669)';
                    button.style.color = 'white';
                    
                    // 3ç§’åæ¢å¤åŸçŠ¶
                    setTimeout(() => {
                        button.innerHTML = originalText;
                        button.disabled = false;
                        button.style.background = '';
                        button.style.color = '';
                    }, 3000);
                    
                    showToast('åˆ†äº«é“¾æ¥å·²å¤åˆ¶åˆ°å‰ªè´´æ¿ï¼', 'success');
                    
                } catch (clipboardError) {
                    console.error('Clipboard API å¤±è´¥:', clipboardError);
                    
                    // é™çº§æ–¹æ¡ˆ
                    const textarea = document.createElement('textarea');
                    textarea.value = fullUrl;
                    document.body.appendChild(textarea);
                    textarea.select();
                    
                    try {
                        const success = document.execCommand('copy');
                        if (success) {
                            button.innerHTML = '<i class="fas fa-check"></i> å·²å¤åˆ¶';
                            button.style.background = 'linear-gradient(135deg, #10b981, #059669)';
                            button.style.color = 'white';
                            
                            setTimeout(() => {
                                button.innerHTML = originalText;
                                button.disabled = false;
                                button.style.background = '';
                                button.style.color = '';
                            }, 3000);
                            
                            showToast('åˆ†äº«é“¾æ¥å·²å¤åˆ¶åˆ°å‰ªè´´æ¿ï¼', 'success');
                        } else {
                            // å¦‚æœ execCommand ä¹Ÿå¤±è´¥ï¼Œå›é€€åˆ° prompt
                            prompt("âœ… é˜…åå³ç„šåŠ å¯†é“¾æ¥å·²ç”Ÿæˆï¼ˆè¯·æ‰‹åŠ¨å¤åˆ¶ï¼‰ï¼š", fullUrl);
                            button.innerHTML = originalText;
                            button.disabled = false;
                        }
                    } catch (execError) {
                        console.error('execCommand å¤±è´¥:', execError);
                        prompt("âœ… é˜…åå³ç„šåŠ å¯†é“¾æ¥å·²ç”Ÿæˆï¼ˆè¯·æ‰‹åŠ¨å¤åˆ¶ï¼‰ï¼š", fullUrl);
                        button.innerHTML = originalText;
                        button.disabled = false;
                    } finally {
                        document.body.removeChild(textarea);
                    }
                }
            } catch (e) { 
                console.error('ç”Ÿæˆåˆ†äº«é“¾æ¥å¤±è´¥:', e);
                
                // æ˜¾ç¤ºé”™è¯¯åé¦ˆ
                button.innerHTML = '<i class="fas fa-exclamation-triangle"></i> å¤±è´¥';
                button.style.background = 'linear-gradient(135deg, #ef4444, #dc2626)';
                button.style.color = 'white';
                
                setTimeout(() => {
                    button.innerHTML = originalText;
                    button.disabled = false;
                    button.style.background = '';
                    button.style.color = '';
                }, 3000);
                
                showToast(`åˆ†äº«å¤±è´¥: ${e.message}`, 'error');
            }
        }

        // ==================== Toast é€šçŸ¥å‡½æ•° ====================
        function showToast(message, type = 'info') {
            // ç§»é™¤ç°æœ‰çš„ toast
            const existingToast = document.getElementById('customToast');
            if (existingToast) {
                existingToast.remove();
            }
            
            // åˆ›å»ºæ–°çš„ toast
            const toast = document.createElement('div');
            toast.id = 'customToast';
            toast.className = 'toast ' + type;
            toast.innerHTML = `
                <i class="fas ${type === 'success' ? 'fa-check-circle' : type === 'error' ? 'fa-exclamation-circle' : 'fa-info-circle'}"></i>
                <span>${message}</span>
            `;
            
            document.getElementById('toastContainer').appendChild(toast);
            
            // æ˜¾ç¤ºåŠ¨ç”»
            setTimeout(() => {
                toast.classList.add('show');
            }, 10);
            
            // 3ç§’åè‡ªåŠ¨æ¶ˆå¤±
            setTimeout(() => {
                toast.classList.remove('show');
                setTimeout(() => {
                    if (toast.parentNode) {
                        toast.parentNode.removeChild(toast);
                    }
                }, 300);
            }, 3000);
            
            // ç‚¹å‡»å…³é—­
            toast.addEventListener('click', () => {
                toast.classList.remove('show');
                setTimeout(() => {
                    if (toast.parentNode) {
                        toast.parentNode.removeChild(toast);
                    }
                }, 300);
            });
        }

        function doExport(text, id) {
            const date = new Date().toISOString().split('T')[0];
            const blob = new Blob([text], { type: 'text/plain;charset=utf-8' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a'); 
            a.href = url; 
            a.download = `CloudNote_${id}_${date}.md`; 
            a.click();
            URL.revokeObjectURL(url);
            
            showToast('ç¬”è®°å·²å¯¼å‡º', 'success');
        }

        async function doDelete(id) {
            if (!confirm("ç¡®å®šè¦ç‰©ç†æŠ¹é™¤è¿™æ¡è®°å½•å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ’¤é”€ã€‚")) return;
            
            try {
                const response = await fetch(`${API_URL}/api/delete`, {
                    method: 'POST', 
                    headers: { 
                        'Content-Type': 'application/json', 
                        'Authorization': ADMIN_KEY 
                    },
                    body: JSON.stringify({ id: id })
                });
                
                if (response.ok) {
                    showToast('ç¬”è®°å·²åˆ é™¤', 'success');
                    loadNotesList();
                } else {
                    const error = await response.text();
                    throw new Error(error || 'åˆ é™¤å¤±è´¥');
                }
            } catch (error) {
                console.error('åˆ é™¤å¤±è´¥:', error);
                showToast(`åˆ é™¤å¤±è´¥: ${error.message}`, 'error');
            }
        }

        async function doAI() {
            const text = document.getElementById('noteInput').value; 
            if (!text) {
                showToast('ç¬”è®°ä¸ºç©º', 'info');
                return;
            }
            
            const btn = event.target; 
            const originalText = btn.innerText;
            btn.innerText = "æ€è€ƒä¸­..."; 
            btn.disabled = true;
            
            try {
                const res = await fetch(`${API_URL}/api/ai-sum`, {
                    method: 'POST', 
                    headers: { 
                        'Content-Type': 'application/json', 
                        'Authorization': ADMIN_KEY 
                    },
                    body: JSON.stringify({ text: text.substring(0, 1000) })
                });
                
                if (res.ok) {
                    const data = await res.json();
                    document.getElementById('noteInput').value += `\n\n--- âœ¨ AI æ€»ç»“ ---\n\n${data.summary}`;
                    document.getElementById('noteCharCount').textContent = document.getElementById('noteInput').value.length;
                    showToast('AIæ€»ç»“å·²å®Œæˆ', 'success');
                } else {
                    const error = await res.text();
                    throw new Error(error || 'AIæ€»ç»“å¤±è´¥');
                }
            } catch (error) {
                console.error('AIæ€»ç»“å¤±è´¥:', error);
                showToast(`AIæ€»ç»“å¤±è´¥: ${error.message}`, 'error');
            } finally { 
                btn.innerText = originalText; 
                btn.disabled = false; 
            }
        }

        // ==================== é˜…åå³ç„šåŠŸèƒ½ ====================
        async function doUnlockShare() {
            const pw = document.getElementById('sharePw').value; 
            const resDiv = document.getElementById('shareResult');
            const unlockBtn = document.getElementById('unlockBtn');
            
            if (!pw) {
                showToast('è¯·è¾“å…¥è§£å¯†å¯†ç ', 'info');
                return;
            }
            
            try {
                unlockBtn.innerText = "è§£å¯†ä¸­...";
                unlockBtn.disabled = true;
                
                const res = await fetch(`${API_URL}/api/share/${shareId}`);
                if (!res.ok) {
                    throw new Error('é“¾æ¥å·²å¤±æ•ˆæˆ–å†…å®¹å·²è¢«ç„šæ¯');
                }
                
                const data = await res.json(); 
                const clearText = await decrypt(data.content, pw);
                
                if (clearText) { 
                    // æ¸²æŸ“Markdownå†…å®¹
                    const burningContentDiv = document.getElementById('burningContent');
                    burningContentDiv.innerHTML = marked.parse(clearText);
                    
                    // é«˜äº®ä»£ç å—
                    hljs.highlightAll();
                    
                    // æ˜¾ç¤ºç»“æœå®¹å™¨
                    resDiv.classList.remove('hidden'); 
                    
                    // æ›´æ–°æŒ‰é’®çŠ¶æ€
                    unlockBtn.innerText = "æ•°æ®å·²è§£å¯†";
                    unlockBtn.classList.remove('share-gradient');
                    unlockBtn.classList.add('bg-gray-600', 'cursor-not-allowed');
                    
                    // æ»šåŠ¨åˆ°ç»“æœ
                    burningContentDiv.scrollIntoView({ behavior: 'smooth' });
                    
                    // å¯é€‰ï¼šè°ƒç”¨æœåŠ¡å™¨åˆ é™¤æ¥å£
                    try {
                        await fetch(`${API_URL}/api/share/delete/${shareId}`, {
                            method: 'DELETE'
                        });
                    } catch (e) {
                        console.error('åˆ é™¤æœåŠ¡å™¨æ•°æ®å¤±è´¥:', e);
                    }
                    
                } else {
                    throw new Error('å¯†ç é”™è¯¯');
                }
            } catch (e) { 
                console.error("è§£å¯†å¤±è´¥:", e);
                showToast(`è§£å¯†å¤±è´¥: ${e.message}`, 'error');
                unlockBtn.innerText = "è§£å¯†å¹¶é”€æ¯";
                unlockBtn.disabled = false;
            }
        }

        // ==================== å¿«é€Ÿè®¿é—®åŠŸèƒ½ ====================
        function scrollToTop() {
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }

        // ==================== åˆå§‹åŒ– ====================
        // å¯åŠ¨æ—¶æ£€æŸ¥ä¼šè¯
        document.addEventListener('DOMContentLoaded', function() {
            console.log('é¡µé¢åŠ è½½å®Œæˆï¼Œæ£€æŸ¥ä¼šè¯...');
            checkSession();
            
            // æ·»åŠ å›è½¦é”®æ”¯æŒ
            const authPasswordInput = document.getElementById('authPassword');
            if (authPasswordInput) {
                authPasswordInput.addEventListener('keydown', function(event) {
                    if (event.key === 'Enter') {
                        checkPassword();
                    }
                });
            }
        });
    </script>
</body>
</html>
