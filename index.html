<!DOCTYPE html>
<html>
<head>
    <title>图片上传测试</title>
    <style>
        body { font-family: Arial; padding: 20px; }
        .container { max-width: 500px; margin: 0 auto; }
        input, button { margin: 10px 0; padding: 10px; width: 100%; }
        #result { 
            margin-top: 20px; 
            padding: 15px; 
            background: #f5f5f5; 
            border-radius: 5px; 
            white-space: pre-wrap; 
            word-break: break-all;
        }
        .success { background: #d4edda !important; }
        .error { background: #f8d7da !important; }
    </style>
</head>
<body>
    <div class="container">
        <h2>CloudNotes 图片上传测试</h2>
        
        <div>
            <label>Worker URL:</label>
            <input type="text" id="apiUrl" value="https://" placeholder="https://your-worker.workers.dev">
        </div>
        
        <div>
            <label>Admin Key:</label>
            <input type="text" id="adminKey" value="" placeholder="输入ADMIN_KEY">
        </div>
        
        <div>
            <label>选择图片文件:</label>
            <input type="file" id="fileInput" accept="image/*">
        </div>
        
        <button onclick="uploadImage()">上传测试</button>
        <button onclick="testConnection()">测试连接</button>
        <button onclick="clearLog()">清空日志</button>
        
        <div id="log"></div>
        <div id="result"></div>
    </div>

    <script>
        let logContent = '';
        
        function log(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            logContent += `[${timestamp}] ${message}\n`;
            document.getElementById('log').textContent = logContent;
            console.log(`[${type.toUpperCase()}] ${message}`);
        }
        
        function clearLog() {
            logContent = '';
            document.getElementById('log').textContent = '';
            document.getElementById('result').innerHTML = '';
            document.getElementById('result').className = '';
        }
        
        async function testConnection() {
            clearLog();
            const apiUrl = document.getElementById('apiUrl').value.trim();
            const adminKey = document.getElementById('adminKey').value.trim();
            
            if (!apiUrl || !adminKey) {
                alert('请填写API URL和Admin Key');
                return;
            }
            
            log(`测试连接到: ${apiUrl}`);
            
            try {
                // 测试健康检查
                log('测试健康检查接口...');
                const healthResponse = await fetch(`${apiUrl}/api/health`);
                const healthData = await healthResponse.json();
                log(`✅ 健康检查: ${JSON.stringify(healthData)}`);
                
                // 测试图片列表
                log('测试图片列表接口...');
                const listResponse = await fetch(`${apiUrl}/api/images/list`, {
                    headers: { 'Authorization': adminKey }
                });
                
                if (listResponse.status === 401) {
                    log('❌ 认证失败: Admin Key 错误');
                    return;
                }
                
                const listData = await listResponse.json();
                log(`✅ 图片列表: 获取到 ${Array.isArray(listData) ? listData.length : 0} 张图片`);
                
                showResult('连接测试成功！', 'success');
                
            } catch (error) {
                log(`❌ 连接测试失败: ${error.message}`);
                showResult(`连接失败: ${error.message}`, 'error');
            }
        }
        
        async function uploadImage() {
            clearLog();
            
            const apiUrl = document.getElementById('apiUrl').value.trim();
            const adminKey = document.getElementById('adminKey').value.trim();
            const fileInput = document.getElementById('fileInput');
            const file = fileInput.files[0];
            
            if (!apiUrl || !adminKey) {
                alert('请填写API URL和Admin Key');
                return;
            }
            
            if (!file) {
                alert('请选择图片文件');
                return;
            }
            
            log(`开始上传: ${file.name} (${(file.size / 1024).toFixed(2)} KB)`);
            log(`文件类型: ${file.type}`);
            
            // 验证文件大小
            if (file.size > 5 * 1024 * 1024) {
                log('❌ 文件过大: 超过5MB限制');
                showResult('文件超过5MB限制', 'error');
                return;
            }
            
            // 验证文件类型
            const allowedTypes = ['image/jpeg', 'image/jpg', 'image/png', 'image/gif', 'image/webp'];
            if (!allowedTypes.includes(file.type.toLowerCase())) {
                log(`❌ 文件类型不支持: ${file.type}`);
                showResult(`不支持的文件类型: ${file.type}`, 'error');
                return;
            }
            
            // 创建FormData
            const formData = new FormData();
            formData.append('image', file);
            
            log('创建FormData成功');
            
            try {
                // 发送请求
                log('发送上传请求...');
                const startTime = Date.now();
                
                const response = await fetch(`${apiUrl}/api/images/upload`, {
                    method: 'POST',
                    headers: {
                        'Authorization': adminKey
                        // 注意：不要设置 Content-Type，浏览器会自动设置 multipart/form-data
                    },
                    body: formData
                });
                
                const endTime = Date.now();
                log(`请求完成，耗时: ${endTime - startTime}ms`);
                log(`状态码: ${response.status} ${response.statusText}`);
                
                // 尝试解析响应
                let result;
                try {
                    result = await response.json();
                } catch (parseError) {
                    log('❌ 响应解析失败，获取原始文本...');
                    const text = await response.text();
                    log(`原始响应: ${text.substring(0, 500)}`);
                    showResult(`解析失败: ${parseError.message}\n原始响应: ${text}`, 'error');
                    return;
                }
                
                if (response.ok) {
                    log(`✅ 上传成功! ID: ${result.data?.id}`);
                    log(`文件名: ${result.data?.filename}`);
                    log(`URL: ${result.data?.url}`);
                    showResult(JSON.stringify(result, null, 2), 'success');
                    
                    // 测试查看图片
                    if (result.data?.url) {
                        log('测试查看图片...');
                        const img = new Image();
                        img.onload = () => log('✅ 图片加载成功');
                        img.onerror = () => log('❌ 图片加载失败');
                        img.src = `${apiUrl}${result.data.url}`;
                    }
                } else {
                    log(`❌ 上传失败: ${result.error || '未知错误'}`);
                    log(`详情: ${JSON.stringify(result)}`);
                    showResult(JSON.stringify(result, null, 2), 'error');
                }
                
            } catch (error) {
                log(`❌ 请求异常: ${error.message}`);
                log(`堆栈: ${error.stack}`);
                showResult(`请求异常: ${error.message}`, 'error');
            }
        }
        
        function showResult(message, type = 'info') {
            const resultDiv = document.getElementById('result');
            resultDiv.textContent = message;
            resultDiv.className = type;
        }
        
        // 自动填充上次使用的配置
        document.addEventListener('DOMContentLoaded', () => {
            const savedApiUrl = localStorage.getItem('cloudnotes_api_url');
            const savedAdminKey = localStorage.getItem('cloudnotes_admin_key');
            
            if (savedApiUrl) document.getElementById('apiUrl').value = savedApiUrl;
            if (savedAdminKey) document.getElementById('adminKey').value = savedAdminKey;
            
            // 保存配置
            document.getElementById('apiUrl').addEventListener('change', function() {
                localStorage.setItem('cloudnotes_api_url', this.value);
            });
            
            document.getElementById('adminKey').addEventListener('change', function() {
                localStorage.setItem('cloudnotes_admin_key', this.value);
            });
        });
    </script>
</body>
</html>
