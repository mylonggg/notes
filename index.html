<!DOCTYPE html>
<html>
<head>
    <title>图片上传测试</title>
    <style>
        body { font-family: Arial; padding: 20px; }
        .container { max-width: 500px; margin: 0 auto; }
        input, button { margin: 10px 0; padding: 10px; width: 100%; }
        #result, #log { 
            margin-top: 20px; 
            padding: 15px; 
            background: #f5f5f5; 
            border-radius: 5px; 
            white-space: pre-wrap; 
            word-break: break-all;
            font-size: 12px;
        }
        .success { background: #d4edda !important; }
        .error { background: #f8d7da !important; }
        .preview { 
            margin-top: 20px; 
            max-width: 300px; 
            border: 1px solid #ddd;
            padding: 10px;
        }
        .preview img { max-width: 100%; }
    </style>
</head>
<body>
    <div class="container">
        <h2>CloudNotes 图片上传测试</h2>
        
        <div>
            <label>Worker URL:</label>
            <input type="text" id="apiUrl" value="https://" placeholder="https://your-worker.workers.dev">
        </div>
        
        <div>
            <label>Admin Key:</label>
            <input type="text" id="adminKey" value="" placeholder="输入ADMIN_KEY">
        </div>
        
        <div>
            <label>选择图片文件:</label>
            <input type="file" id="fileInput" accept="image/*">
        </div>
        
        <button onclick="uploadImage()">上传测试</button>
        <button onclick="testConnection()">测试连接</button>
        <button onclick="testImageView()">测试图片查看</button>
        <button onclick="clearLog()">清空日志</button>
        
        <div id="log"></div>
        <div id="result"></div>
        <div id="preview" class="preview" style="display:none;">
            <h4>图片预览:</h4>
            <img id="previewImg" src="" alt="预览">
            <p id="previewInfo"></p>
        </div>
    </div>

    <script>
        let logContent = '';
        
        function log(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            const typeIcon = type === 'error' ? '❌' : type === 'success' ? '✅' : 'ℹ️';
            logContent += `[${timestamp}] ${typeIcon} ${message}\n`;
            document.getElementById('log').textContent = logContent;
            console.log(`[${type.toUpperCase()}] ${message}`);
        }
        
        function clearLog() {
            logContent = '';
            document.getElementById('log').textContent = '';
            document.getElementById('result').innerHTML = '';
            document.getElementById('result').className = '';
            document.getElementById('preview').style.display = 'none';
        }
        
        function showResult(message, type = 'info') {
            const resultDiv = document.getElementById('result');
            resultDiv.textContent = message;
            resultDiv.className = type;
        }
        
        async function testConnection() {
            clearLog();
            const apiUrl = document.getElementById('apiUrl').value.trim();
            const adminKey = document.getElementById('adminKey').value.trim();
            
            if (!apiUrl || !adminKey) {
                alert('请填写API URL和Admin Key');
                return;
            }
            
            log(`测试连接到: ${apiUrl}`);
            
            try {
                // 测试健康检查
                log('测试健康检查接口...');
                const healthResponse = await fetch(`${apiUrl}/api/health`);
                const healthData = await healthResponse.json();
                log(`健康检查: ${JSON.stringify(healthData)}`, 'success');
                
                // 测试图片列表
                log('测试图片列表接口...');
                const listResponse = await fetch(`${apiUrl}/api/images/list`, {
                    headers: { 'Authorization': adminKey }
                });
                
                if (listResponse.status === 401) {
                    log('认证失败: Admin Key 错误', 'error');
                    return;
                }
                
                const listData = await listResponse.json();
                log(`图片列表: 获取到 ${Array.isArray(listData) ? listData.length : 0} 张图片`, 'success');
                
                showResult('连接测试成功！', 'success');
                
            } catch (error) {
                log(`连接测试失败: ${error.message}`, 'error');
                showResult(`连接失败: ${error.message}`, 'error');
            }
        }
        
        async function testImageView() {
            clearLog();
            const apiUrl = document.getElementById('apiUrl').value.trim();
            const adminKey = document.getElementById('adminKey').value.trim();
            
            if (!apiUrl || !adminKey) {
                alert('请填写API URL和Admin Key');
                return;
            }
            
            log('测试图片查看功能...');
            
            try {
                // 1. 先获取图片列表
                const listResponse = await fetch(`${apiUrl}/api/images/list`, {
                    headers: { 'Authorization': adminKey }
                });
                
                if (!listResponse.ok) {
                    log(`获取图片列表失败: ${listResponse.status}`, 'error');
                    return;
                }
                
                const images = await listResponse.json();
                
                if (!images || images.length === 0) {
                    log('没有可测试的图片，请先上传一张图片', 'info');
                    return;
                }
                
                // 2. 测试第一张图片
                const firstImage = images[0];
                const imageUrl = `${apiUrl}${firstImage.url}`;
                log(`测试图片: ${firstImage.filename}`);
                log(`图片URL: ${imageUrl}`);
                
                // 3. 测试访问
                const startTime = Date.now();
                const imgResponse = await fetch(imageUrl);
                const endTime = Date.now();
                
                log(`访问耗时: ${endTime - startTime}ms`, 'info');
                log(`状态码: ${imgResponse.status}`, imgResponse.ok ? 'success' : 'error');
                
                if (imgResponse.ok) {
                    const contentType = imgResponse.headers.get('content-type');
                    const contentLength = imgResponse.headers.get('content-length');
                    
                    log(`Content-Type: ${contentType}`, 'success');
                    log(`Content-Length: ${contentLength || '未知'} bytes`, 'success');
                    
                    // 测试显示图片
                    const blob = await imgResponse.blob();
                    const blobUrl = URL.createObjectURL(blob);
                    
                    document.getElementById('previewImg').src = blobUrl;
                    document.getElementById('previewInfo').textContent = 
                        `大小: ${blob.size} bytes, 类型: ${blob.type}`;
                    document.getElementById('preview').style.display = 'block';
                    
                    log(`图片加载成功，大小: ${blob.size} bytes`, 'success');
                    showResult('图片查看功能正常！', 'success');
                } else {
                    log(`图片查看失败: ${imgResponse.statusText}`, 'error');
                    showResult(`图片查看失败: ${imgResponse.status} ${imgResponse.statusText}`, 'error');
                }
                
            } catch (error) {
                log(`测试失败: ${error.message}`, 'error');
                showResult(`测试失败: ${error.message}`, 'error');
            }
        }
        
        async function uploadImage() {
            clearLog();
            
            const apiUrl = document.getElementById('apiUrl').value.trim();
            const adminKey = document.getElementById('adminKey').value.trim();
            const fileInput = document.getElementById('fileInput');
            const file = fileInput.files[0];
            
            if (!apiUrl || !adminKey) {
                alert('请填写API URL和Admin Key');
                return;
            }
            
            if (!file) {
                alert('请选择图片文件');
                return;
            }
            
            log(`开始上传: ${file.name} (${(file.size / 1024).toFixed(2)} KB)`);
            log(`文件类型: ${file.type}`);
            
            // 验证文件大小
            if (file.size > 5 * 1024 * 1024) {
                log('文件过大: 超过5MB限制', 'error');
                showResult('文件超过5MB限制', 'error');
                return;
            }
            
            // 验证文件类型
            const allowedTypes = ['image/jpeg', 'image/jpg', 'image/png', 'image/gif', 'image/webp'];
            if (!allowedTypes.includes(file.type.toLowerCase())) {
                log(`文件类型不支持: ${file.type}`, 'error');
                showResult(`不支持的文件类型: ${file.type}`, 'error');
                return;
            }
            
            // 创建FormData
            const formData = new FormData();
            formData.append('image', file);
            
            log('创建FormData成功');
            
            try {
                // 发送请求
                log('发送上传请求...');
                const startTime = Date.now();
                
                const response = await fetch(`${apiUrl}/api/images/upload`, {
                    method: 'POST',
                    headers: {
                        'Authorization': adminKey
                    },
                    body: formData
                });
                
                const endTime = Date.now();
                log(`请求完成，耗时: ${endTime - startTime}ms`);
                log(`状态码: ${response.status} ${response.statusText}`);
                
                // 尝试解析响应
                let result;
                try {
                    result = await response.json();
                } catch (parseError) {
                    log('响应解析失败，获取原始文本...', 'error');
                    const text = await response.text();
                    log(`原始响应: ${text.substring(0, 500)}`, 'error');
                    showResult(`解析失败: ${parseError.message}\n原始响应: ${text}`, 'error');
                    return;
                }
                
                if (response.ok && result.success) {
                    const imageData = result.data;
                    log(`上传成功! ID: ${imageData.id}`, 'success');
                    log(`文件名: ${imageData.filename}`, 'success');
                    log(`URL: ${imageData.url}`, 'success');
                    
                    // 显示完整信息
                    const displayInfo = {
                        状态: '上传成功',
                        图片ID: imageData.id,
                        文件名: imageData.filename,
                        文件大小: `${(imageData.size / 1024).toFixed(2)} KB`,
                        图片URL: `${apiUrl}${imageData.url}`,
                        上传时间: new Date(imageData.uploadedAt).toLocaleString(),
                        完整响应: result
                    };
                    
                    showResult(JSON.stringify(displayInfo, null, 2), 'success');
                    
                    // 立即测试查看图片
                    log('立即测试查看图片...');
                    await testImageAccess(apiUrl, imageData.url);
                    
                } else {
                    log(`上传失败: ${result.error || '未知错误'}`, 'error');
                    log(`详情: ${JSON.stringify(result)}`, 'error');
                    showResult(JSON.stringify(result, null, 2), 'error');
                }
                
            } catch (error) {
                log(`请求异常: ${error.message}`, 'error');
                showResult(`请求异常: ${error.message}`, 'error');
            }
        }
        
        async function testImageAccess(apiUrl, imagePath) {
            const imageUrl = `${apiUrl}${imagePath}`;
            log(`测试访问图片: ${imageUrl}`);
            
            try {
                // 方法1: 使用fetch检查
                const startTime = Date.now();
                const response = await fetch(imageUrl);
                const endTime = Date.now();
                
                if (response.ok) {
                    const contentType = response.headers.get('content-type');
                    const contentLength = response.headers.get('content-length');
                    
                    log(`✅ 图片访问成功 (${endTime - startTime}ms)`, 'success');
                    log(`Content-Type: ${contentType}`, 'success');
                    log(`Content-Length: ${contentLength || '未知'} bytes`, 'success');
                    
                    // 获取图片数据并预览
                    const blob = await response.blob();
                    if (blob.size > 0) {
                        const blobUrl = URL.createObjectURL(blob);
                        
                        document.getElementById('previewImg').src = blobUrl;
                        document.getElementById('previewInfo').textContent = 
                            `大小: ${blob.size} bytes, 类型: ${blob.type}`;
                        document.getElementById('preview').style.display = 'block';
                        
                        log(`✅ 图片数据有效，大小: ${blob.size} bytes`, 'success');
                    } else {
                        log(`❌ 图片数据为空 (0 bytes)`, 'error');
                    }
                } else {
                    log(`❌ 图片访问失败: ${response.status} ${response.statusText}`, 'error');
                    
                    // 尝试获取错误信息
                    const errorText = await response.text();
                    if (errorText) {
                        log(`错误信息: ${errorText.substring(0, 200)}`, 'error');
                    }
                }
            } catch (error) {
                log(`❌ 图片访问异常: ${error.message}`, 'error');
            }
        }
        
        // 自动填充上次使用的配置
        document.addEventListener('DOMContentLoaded', () => {
            const savedApiUrl = localStorage.getItem('cloudnotes_api_url');
            const savedAdminKey = localStorage.getItem('cloudnotes_admin_key');
            
            if (savedApiUrl) document.getElementById('apiUrl').value = savedApiUrl;
            if (savedAdminKey) document.getElementById('adminKey').value = savedAdminKey;
            
            // 保存配置
            document.getElementById('apiUrl').addEventListener('change', function() {
                localStorage.setItem('cloudnotes_api_url', this.value);
            });
            
            document.getElementById('adminKey').addEventListener('change', function() {
                localStorage.setItem('cloudnotes_admin_key', this.value);
            });
        });
    </script>
</body>
</html>
